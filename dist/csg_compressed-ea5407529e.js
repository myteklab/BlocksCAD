!function(e){function t(e,t){return e-t}var n=function(){this.polygons=[],this.properties=new n.Properties,this.isCanonicalized=!0,this.isRetesselated=!0};function r(e,t,n){for(var r=0,o=e.length;o>r;){var i=Math.floor((r+o)/2);n(t,e[i])>0?r=i+1:o=i}e.splice(r,0,t)}n.defaultResolution2D=32,n.defaultResolution3D=12,n.fromPolygons=function(e){var t=new n;return t.polygons=e,t.isCanonicalized=!1,t.isRetesselated=!1,t},n.fromSlices=function(e){return new n.Polygon.cFP([[0,0,0],[1,0,0],[1,1,0],[0,1,0]]).solidFromSlices(e)},n.fromObject=function(e){var t=e.polygons.map(function(e){return n.Polygon.fromObject(e)}),r=n.fromPolygons(t);return r=r.canonicalized()},n.uniqBy=function(e,t){var n={};return e.filter(function(e){var r=t(e);return!n.hasOwnProperty(r)&&(n[r]=!0)})},n.fromCompactBinary=function(e){if("CSG"!=e.class)throw new Error("Not a CSG");for(var t,r,o,i,s,a,l=[],u=e.planeData,h=u.length/4,c=0,p=0;p<h;p++)t=u[c++],r=u[c++],o=u[c++],i=u[c++],s=n.Vector3D.Create(t,r,o),a=new n.Plane(s,i),l.push(a);var f,v,d=[],g=e.vertexData,m=g.length/3;c=0;for(var x=0;x<m;x++)t=g[c++],r=g[c++],o=g[c++],f=n.Vector3D.Create(t,r,o),v=new n.Vertex(f),d.push(v);var y,_,w,P,V=e.shared.map(function(e){return n.Polygon.Shared.fromObject(e)}),z=[],D=e.numPolygons,C=e.numVerticesPerPolygon,M=e.polygonVertices,b=e.polygonPlaneIndexes,T=e.polygonSharedIndexes;c=0;for(var F=0;F<D;F++){y=C[F],_=[];for(var S=0;S<y;S++)_.push(d[M[c++]]);a=l[b[F]],w=V[T[F]],P=new n.Polygon(_,w,a),z.push(P)}var A=n.fromPolygons(z);return A.isCanonicalized=!0,A.isRetesselated=!0,A},n.prototype={toPolygons:function(){return this.polygons},union:function(e){var t;e instanceof Array?(t=e.slice(0)).push(this):t=[this,e];for(var n=1;n<t.length;n+=2)t.push(t[n-1].unionSub(t[n]));return t[n-1].reTesselated().canonicalized()},unionSub:function(e,t,r){if(this.mayOverlap(e)){var o=new n.Tree(this.polygons),i=new n.Tree(e.polygons);o.clipTo(i,!1),i.clipTo(o),i.invert(),i.clipTo(o),i.invert();var s=o.allPolygons().concat(i.allPolygons()),a=n.fromPolygons(s);return a.properties=this.properties._merge(e.properties),t&&(a=a.reTesselated()),r&&(a=a.canonicalized()),a}return this.unionForNonIntersecting(e)},unionForNonIntersecting:function(e){var t=this.polygons.concat(e.polygons),r=n.fromPolygons(t);return r.properties=this.properties._merge(e.properties),r.isCanonicalized=this.isCanonicalized&&e.isCanonicalized,r.isRetesselated=this.isRetesselated&&e.isRetesselated,r},subtract:function(e){var t;t=e instanceof Array?e:[e];for(var n=this,r=0;r<t.length;r++){var o=r==t.length-1;n=n.subtractSub(t[r],o,o)}return n},subtractSub:function(e,t,r){var o=new n.Tree(this.polygons),i=new n.Tree(e.polygons);o.invert(),o.clipTo(i),i.clipTo(o,!0),o.addPolygons(i.allPolygons()),o.invert();var s=n.fromPolygons(o.allPolygons());return s.properties=this.properties._merge(e.properties),t&&(s=s.reTesselated()),r&&(s=s.canonicalized()),s},intersect:function(e){var t;t=e instanceof Array?e:[e];for(var n=this,r=0;r<t.length;r++){var o=r==t.length-1;n=n.intersectSub(t[r],o,o)}return n},intersectSub:function(e,t,r){var o=new n.Tree(this.polygons),i=new n.Tree(e.polygons);o.invert(),i.clipTo(o),i.invert(),o.clipTo(i),i.clipTo(o),o.addPolygons(i.allPolygons()),o.invert();var s=n.fromPolygons(o.allPolygons());return s.properties=this.properties._merge(e.properties),t&&(s=s.reTesselated()),r&&(s=s.canonicalized()),s},hull:function(e){var t=e,r=[];r.push(this);for(var o=0;o<t.length;o++)r.push(t[o]);for(o=0;o<r.length;o++){if(!(r[o]instanceof n))throw"ERROR: don't mix 2D and 3D shapes in hull"}var i=function(e){Array.isArray(e)||(e=[e]);for(var t=[],r=0;r<e.length;r++)for(var o=0;o<e[r].polygons.length;o++)for(var i=0;i<e[r].polygons[o].vertices.length;i++)t.push([e[r].polygons[o].vertices[i].pos._x,e[r].polygons[o].vertices[i].pos._y,e[r].polygons[o].vertices[i].pos._z]);var s=n.uniqBy(t,JSON.stringify),a=[];for(r=0;r<s.length;r++)a.push(n.Vector3D.Create(s[r][0],s[r][1],s[r][2]));return a}(r),s=function(e){return e[0].polygons[0].shared?e[0].polygons[0].shared.color:null}(r),a=(new n.quickHull3D).build(i),l=[];for(o=0;o<a.length;o++){for(var u=[],h=0;h<a[o].length;h++)u.push(i[a[o][h]]);var c=new n.Polygon.cFP(u);s&&c.sC(s),l.push(c)}var p=n.fromPolygons(l);return p.isCanonicalized=!0,p.isRetesselated=!0,n.fromPolygons(l)},invert:function(){var e=this.polygons.map(function(e){return e.flipped()});return n.fromPolygons(e)},transform1:function(e){var t=this.polygons.map(function(t){return t.transform(e)}),r=n.fromPolygons(t);return r.properties=this.properties._transform(e),r.isRetesselated=this.isRetesselated,r},transform:function(e){var t=e.isMirroring(),r={},o={},i=this.polygons.map(function(i){var s,a=i.plane,l=a.getTag();l in o?s=o[l]:(s=a.transform(e),o[l]=s);var u=i.vertices.map(function(t){var n,o=t.getTag();return o in r?n=r[o]:(n=t.transform(e),r[o]=n),n});return t&&u.reverse(),new n.Polygon(u,i.shared,s)}),s=n.fromPolygons(i);return s.properties=this.properties._transform(e),s.isRetesselated=this.isRetesselated,s.isCanonicalized=this.isCanonicalized,s},taper:function(e,t){t<=0&&(t=1e-4);var r=this.getBounds(),o=0,i=0;e[0]?(o=r[1].x-r[0].x,i=r[0].x):e[1]?(o=r[1].y-r[0].y,i=r[0].y):e[2]&&(o=r[1].z-r[0].z,i=r[0].z);for(var s=[],a=[],l=[],u=null,h=0;h<this.polygons.length;h++)if(u=this.polygons[h].shared?this.polygons[h].shared.color:null,this.polygons[h].vertices.length>3){var c=[(d=this.polygons[h].vertices)[0].pos.x,d[0].pos.y,d[0].pos.z];a=[],l=[];for(var p=1;p<this.polygons[h].vertices.length-1;p++)l=[],(a=[])[0]=c,a[1]=[d[p].pos.x,d[p].pos.y,d[p].pos.z],a[2]=[d[p+1].pos.x,d[p+1].pos.y,d[p+1].pos.z],l=new n.Polygon.cFP(a),u&&l.sC(u),s.push(l)}else s.push(this.polygons[h]);var f=[],v=[];for(h=0;h<s.length;h++){u=s[h].shared?s[h].shared.color:null,v=[];for(p=0;p<s[h].vertices.length;p++){s[h].vertices.length>3&&console.log("bad facet - more than 3 vertices!");var d=s[h].vertices[p].pos;if(e[0])var g=d.x,m=d.y*(1+(t-1)*(d.x-i)/o),x=d.z*(1+(t-1)*(d.x-i)/o);else if(e[1])m=d.y,g=d.x*(1+(t-1)*(d.y-i)/o),x=d.z*(1+(t-1)*(d.y-i)/o);else x=d.z,m=d.y*(1+(t-1)*(d.z-i)/o),g=d.x*(1+(t-1)*(d.z-i)/o);v[p]=[g,m,x]}f[h]=new n.Polygon.cFP(v),u&&f[h].sC(u)}return n.fromPolygons(f)},toString:function(){var e="CSG solid:\n";return this.polygons.map(function(t){e+=t.toString()}),e},expand:function(e,t){var n=this.expandedShell(e,t,!0);return(n=n.reTesselated()).properties=this.properties,n},contract:function(e,t){var n=this.expandedShell(e,t,!1),r=this.subtract(n);return(r=r.reTesselated()).properties=this.properties,r},stretchAtPlane:function(e,t,r){var o=n.Plane.fromNormalAndPoint(e,t),i=new n.OrthoNormalBasis(o),s=this.sectionCut(i).extrudeInOrthonormalBasis(i,r),a=this.cutByPlane(o),l=this.cutByPlane(o.flipped());return a.union([s,l.tr(o.normal.times(r))])},expandedShell:function(e,r,o){var i,s=this.reTesselated();i=o?s:new n,s.polygons.map(function(t){var n=t.plane.normal.unit().times(2*e),r=t.tr(n.times(-.5)).extrude(n);i=i.unionSub(r,!1,!1)});var a={};for(var l in s.polygons.map(function(e){for(var t=e.vertices.length,n=e.vertices[t-1],r=n.getTag(),o=0;o<t;o++){var i,s,l=e.vertices[o],u=l.getTag();(i=u<r?u+"-"+r:r+"-"+u)in a?s=a[i]:(s={v1:n,v2:l,planenormals:[]},a[i]=s),s.planenormals.push(e.plane.normal),r=u,n=l}}),a){for(var u=a[l],h=u.v1.pos,c=u.v2.pos,p=c.minus(h).unit(),f=u.planenormals[0].unit(),v=f.cross(p),d=[],g=0;g<r;g++)d.push(g*Math.PI*2/r);g=0;for(var m=u.planenormals.length;g<m;g++){var x=u.planenormals[g],y=v.dot(x),_=f.dot(x);(M=Math.atan2(y,_))<0&&(M+=2*Math.PI),d.push(M),(M=Math.atan2(-y,-_))<0&&(M+=2*Math.PI),d.push(M)}var w,P,V=(d=d.sort(t)).length,z=[],D=[],C=[];for(g=-1;g<V;g++){var M=d[g<0?g+V:g],b=(y=Math.sin(M),_=Math.cos(M),f.times(_*e).plus(v.times(y*e))),T=h.plus(b),F=c.plus(b),S=!1;if(g>=0&&T.distanceTo(w)<1e-5&&(S=!0),!S){if(g>=0){z.push(new n.Vertex(T)),D.push(new n.Vertex(F));var A=[new n.Vertex(P),new n.Vertex(F),new n.Vertex(T),new n.Vertex(w)],O=new n.Polygon(A);C.push(O)}w=T,P=F}}D.reverse(),C.push(new n.Polygon(z)),C.push(new n.Polygon(D));var B=n.fromPolygons(C);i=i.unionSub(B,!1,!1)}var E={};for(var I in s.polygons.map(function(e){e.vertices.map(function(t){var n,r=t.getTag();r in E?n=E[r]:(n={pos:t.pos,normals:[]},E[r]=n),n.normals.push(e.plane.normal)})}),E){var N=E[I],k=N.normals[0].unit(),L=null,R=0;for(g=1;g<N.normals.length;g++){var q=N.normals[g].unit(),j=k.cross(q).length();j>.05&&j>R&&(R=j,L=q)}L||(L=k.randomNonParallelVector());var G=k.cross(L).unit(),Z=G.cross(k),Y=n.sphere({center:N.pos,radius:e,resolution:r,axes:[k,G,Z]});i=i.unionSub(Y,!1,!1)}return i},canonicalized:function(){if(this.isCanonicalized)return this;var e=(new n.fuzzyCSGFactory).getCSG(this);return e.isCanonicalized=!0,e.isRetesselated=this.isRetesselated,e.properties=this.properties,e},reTesselated:function(){if(this.isRetesselated)return this;var e={},t=this.isCanonicalized,r=new n.fuzzyCSGFactory;this.polygons.map(function(n){var o=n.plane,i=n.shared;t||(o=r.getPlane(o),i=r.getPolygonShared(i));var s=o.getTag()+"/"+i.getTag();s in e?e[s].push(n):e[s]=[n]});var o=[];for(var i in e){var s=e[i];if(s.length<2)o=o.concat(s);else{var a=[];n.reTesselateCoplanarPolygons(s,a),o=o.concat(a)}}var l=n.fromPolygons(o);return l.isRetesselated=!0,l.properties=this.properties,l},getBounds:function(){if(!this.cachedBoundingBox){for(var e=new n.Vector3D(0,0,0),t=new n.Vector3D(0,0,0),r=this.polygons,o=r.length,i=0;i<o;i++){var s=r[i].boundingBox();0===i?(e=s[0],t=s[1]):(e=e.min(s[0]),t=t.max(s[1]))}this.cachedBoundingBox=[e,t]}return this.cachedBoundingBox},getBoundingSphere:function(){if(!this.cachedBoundingSphere){for(var e,t={center:(e=this.cachedBoundingBox?this.cachedBoundingBox:this.getBounds())[0].plus(e[1]).dividedBy(2),radius:0},r=0;r<this.polygons.length;r++)for(var o=0;o<this.polygons[r].vertices.length;o++){var i=this.polygons[r].vertices[o];t.radius=Math.max(t.radius,new n.Vector3D(i.pos.x,i.pos.y,i.pos.z).minus(t.center).lengthSquared())}t.radius=Math.sqrt(t.radius),this.cachedBoundingSphere=t}return this.cachedBoundingSphere},mayOverlap:function(e){if(0===this.polygons.length||0===e.polygons.length)return!1;var t=this.getBounds(),n=e.getBounds();return!(t[1].x<n[0].x)&&(!(t[0].x>n[1].x)&&(!(t[1].y<n[0].y)&&(!(t[0].y>n[1].y)&&(!(t[1].z<n[0].z)&&!(t[0].z>n[1].z)))))},cutByPlane:function(e){if(0===this.polygons.length)return new n;var t=e.normal.times(e.w),r=0;this.polygons.map(function(e){e.vertices.map(function(e){var n=e.pos.distanceToSquared(t);n>r&&(r=n)})}),r=Math.sqrt(r),r*=1.01;var o=[],i=new n.OrthoNormalBasis(e);o.push(new n.Vertex(i.to3D(new n.Vector2D(r,-r)))),o.push(new n.Vertex(i.to3D(new n.Vector2D(-r,-r)))),o.push(new n.Vertex(i.to3D(new n.Vector2D(-r,r)))),o.push(new n.Vertex(i.to3D(new n.Vector2D(r,r))));var s=new n.Polygon(o,null,e.flipped()).extrude(e.normal.times(-r)),a=this.intersect(s);return a.properties=this.properties,a},connectTo:function(e,t,n,r){var o=e.getTransformationTo(t,n,r);return this.transform(o)},setShared:function(e){var t=this.polygons.map(function(t){return new n.Polygon(t.vertices,e,t.plane)}),r=n.fromPolygons(t);return r.properties=this.properties,r.isRetesselated=this.isRetesselated,r.isCanonicalized=this.isCanonicalized,r},sC:function(e){var t=n.Polygon.Shared.fromColor.apply(this,arguments);return this.setShared(t)},toCompactBinary:function(){var e=this.canonicalized(),t=e.polygons.length,n=0,r=0,o={},i=[],s=0,a={},l=0,u=[],h=[],c={},p=0;e.polygons.map(function(e){e.vertices.map(function(e){++n;var t=e.getTag();t in o||(o[t]=r++,i.push(e))});var t=e.plane.getTag();t in a||(a[t]=s++,u.push(e.plane));var l=e.shared.getTag();l in c||(c[l]=p++,h.push(e.shared))});var f=new Uint32Array(t),v=new Uint32Array(t),d=new Uint32Array(n),g=new Uint32Array(t),m=new Float64Array(3*r),x=new Float64Array(4*s),y=0;for(l=0;l<t;++l){var _=e.polygons[l];f[l]=_.vertices.length,_.vertices.map(function(e){var t=e.getTag(),n=o[t];d[y++]=n});var w=_.plane.getTag(),P=a[w];g[l]=P;var V=_.shared.getTag(),z=c[V];v[l]=z}var D=0;i.map(function(e){var t=e.pos;m[D++]=t._x,m[D++]=t._y,m[D++]=t._z});var C=0;return u.map(function(e){var t=e.normal;x[C++]=t._x,x[C++]=t._y,x[C++]=t._z,x[C++]=e.w}),{class:"CSG",numPolygons:t,numVerticesPerPolygon:f,polygonPlaneIndexes:g,polygonSharedIndexes:v,polygonVertices:d,vertexData:m,planeData:x,shared:h}},toPointCloud:function(e){var t=this.reTesselated(),r=new n,o={};for(var i in t.polygons.map(function(e){e.vertices.map(function(e){o[e.getTag()]=e.pos})}),o){var s=o[i],a=n.cube({center:s,radius:e});r=r.unionSub(a,!1,!1)}return r=r.reTesselated()},getTransformationAndInverseTransformationToFlatLying:function(){if(0===this.polygons.length)return new n.Matrix4x4;var e=this.canonicalized(),t={};e.polygons.map(function(e){t[e.plane.getTag()]=e.plane});var r,o,i=new n.Vector3D(1,0,0),s=new n.Vector3D(0,1,0),a=new n.Vector3D(0,0,1),l=new n.Connector([0,0,0],[0,0,-1],i),u=new n.Connector([0,0,0],[0,0,-1],s),h=!0,c=0,p=0;for(var f in t){var v,d,g,m=t[f],x=m.normal.times(m.w);if(m.normal.cross(i).length()>m.normal.cross(s).length())v=(g=new n.Connector(x,m.normal,i)).getTransformationTo(l,!1,0),d=l.getTransformationTo(g,!1,0);else v=(g=new n.Connector(x,m.normal,s)).getTransformationTo(u,!1,0),d=u.getTransformationTo(g,!1,0);var y=e.transform(v),_=-m.normal.dot(a),w=y.getBounds(),P=w[1].z-w[0].z,V=h;if(V||(P<c?V=!0:P==c&&_>p&&(V=!0)),V){var z=new n.Vector3D([-.5*(w[1].x+w[0].x),-.5*(w[1].y+w[0].y),-w[0].z]);c=P,p=_,r=v=v.multiply(n.Matrix4x4.translation(z)),o=d=n.Matrix4x4.translation(z.negated()).multiply(d)}h=!1}return[r,o]},getTransformationToFlatLying:function(){return this.getTransformationAndInverseTransformationToFlatLying()[0]},lieFlat:function(){var e=this.getTransformationToFlatLying();return this.transform(e)},projectToOrthoNormalBasis:function(e){var t=[];return this.polygons.filter(function(t){return t.plane.normal.minus(e.plane.normal).lengthSquared()<1e-5*1e-5}).map(function(n){var r=n.projectToOrthoNormalBasis(e);r.sides.length>0&&t.push(r)}),(new o).union(t)},sectionCut:function(e){var t=e.plane,r=e.plane.flipped();t=new n.Plane(t.normal,t.w),r=new n.Plane(r.normal,r.w+5e-5);var o=this.cutByPlane(t);return(o=o.cutByPlane(r)).projectToOrthoNormalBasis(e)},meshRepair:function(){for(var e=[],t={},r={},o=0;o<this.polygons.length;o++){var i=this.polygons[o],s=i.vertices.length;s<3&&console.log("Degenerate Poly!!!!");for(var a=0;a<s;a++){var l=i.vertices[a];l.pos._x=parseFloat(l.pos._x.toPrecision(9)),l.pos._y=parseFloat(l.pos._y.toPrecision(9)),l.pos._z=parseFloat(l.pos._z.toPrecision(9))}for(var u=0;u<i.vertices.length-1;u++){(d={}).u=i.vertices[u].pos,d.v=i.vertices[u+1].pos,d.face=o,[d.u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]in t||(t[[d.u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]]=[]),r[[d.u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]]=[],t[[d.u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]].push(d),e.push(d)}(d={}).u=i.vertices[i.vertices.length-1].pos,d.v=i.vertices[0].pos,d.face=o,[d.u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]in t||(t[[d.u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]]=[]),r[[d.u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]]=[],t[[d.u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]].push(d),e.push(d)}var h=[],c=[],p={},f={},v=0;for(o=0;o<e.length;o++){var d;if(1==t[[(d=e[o]).u._x,d.u._y,d.u._z,d.v._x,d.v._y,d.v._z]].length){if(t[[d.v._x,d.v._y,d.v._z,d.u._x,d.u._y,d.u._z]])var g=t[[d.v._x,d.v._y,d.v._z,d.u._x,d.u._y,d.u._z]].length;else g=0;if(g>1&&c.push(d),1==g){v++,d.opp=t[[d.v._x,d.v._y,d.v._z,d.u._x,d.u._y,d.u._z]][0],t[[d.v._x,d.v._y,d.v._z,d.u._x,d.u._y,d.u._z]][0].opp=d;continue}}else c.push(d);h.push(d),[d.u._x,d.u._y,d.u._z]in p||(p[[d.u._x,d.u._y,d.u._z]]=[]),[d.v._x,d.v._y,d.v._z]in f||(f[[d.v._x,d.v._y,d.v._z]]=[]),p[[d.u._x,d.u._y,d.u._z]].push(d),f[[d.v._x,d.v._y,d.v._z]].push(d)}console.log("paired, unpaired, multiply paired edges: "+v+","+h.length+","+c.length);var m=n.fixUnpairedEdges(this.polygons,h,t,p,f,r,0,!1);if(m&&console.log("number of edges fixed:",m),m<h.length){var x=[];for(o=0;o<h.length;o++){var y=h[o];r[[y.u._x,y.u._y,y.u._z,y.v._x,y.v._y,y.v._z]].length||x.push(y)}(m=n.fixUnpairedEdges(this.polygons,x,t,p,f,r,m,!0))&&console.log("second pass edges fixed:",m)}},toTriangles:function(){var e=[];return this.polygons.forEach(function(t){for(var r=t.vertices[0],o=t.vertices.length-3;o>=0;o--)e.push(new n.Polygon([r,t.vertices[o+1],t.vertices[o+2]],t.shared,t.plane))}),e},getFeatures:function(e){e instanceof Array||(e=[e]);var t=this.toTriangles().map(function(t){return t.getTetraFeatures(e)}).reduce(function(e,t){return t.map(function(t,n){return t+(0===e?0:e[n])})},0);return 1==t.length?t[0]:t}},n.parseOption=function(e,t,n){var r=n;return e&&t in e&&(r=e[t]),r},n.parseOptionAs3DVector=function(e,t,r){var o=n.parseOption(e,t,r);return o=new n.Vector3D(o)},n.parseOptionAs3DVectorList=function(e,t,r){return n.parseOption(e,t,r).map(function(e){return new n.Vector3D(e)})},n.parseOptionAs2DVector=function(e,t,r){var o=n.parseOption(e,t,r);return o=new n.Vector2D(o)},n.parseOptionAsFloat=function(e,t,r){var o=n.parseOption(e,t,r);if("string"==typeof o&&(o=Number(o)),isNaN(o)||"number"!=typeof o)throw new Error("Parameter "+t+" should be a number");return o},n.parseOptionAsInt=function(e,t,r){var o=n.parseOption(e,t,r);if(o=Number(Math.floor(o)),isNaN(o))throw new Error("Parameter "+t+" should be a number");return o},n.parseOptionAsBool=function(e,t,r){var o=n.parseOption(e,t,r);return"string"==typeof o&&("true"==o?o=!0:"false"==o?o=!1:0==o&&(o=!1)),o=!!o},n.cube=function(e){var t,r;if("corner1"in(e=e||{})||"corner2"in e){if("center"in e||"radius"in e)throw new Error("cube: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=n.parseOptionAs3DVector(e,"corner1",[0,0,0]),corner2=n.parseOptionAs3DVector(e,"corner2",[1,1,1]),t=corner1.plus(corner2).times(.5),r=corner2.minus(corner1).times(.5)}else t=n.parseOptionAs3DVector(e,"center",[0,0,0]),r=n.parseOptionAs3DVector(e,"radius",[1,1,1]);if(r.x<0||r.y<0||r.z<0)throw new Error("Dimension should be positive");if(r.x<5e-4||r.y<5e-4||r.z<5e-4)return console.log("Throwing out a zero-length cube."),new n;var o=n.fromPolygons([[[0,4,6,2],[-1,0,0]],[[1,3,7,5],[1,0,0]],[[0,1,5,4],[0,-1,0]],[[2,6,7,3],[0,1,0]],[[0,2,3,1],[0,0,-1]],[[4,5,7,6],[0,0,1]]].map(function(e){var o=e[0].map(function(e){var o=new n.Vector3D(t.x+r.x*(2*!!(1&e)-1),t.y+r.y*(2*!!(2&e)-1),t.z+r.z*(2*!!(4&e)-1));return new n.Vertex(o)});return new n.Polygon(o,null)}));return o.properties.cube=new n.Properties,o.properties.cube.center=new n.Vector3D(t),o.properties.cube.facecenters=[new n.Connector(new n.Vector3D([r.x,0,0]).plus(t),[1,0,0],[0,0,1]),new n.Connector(new n.Vector3D([-r.x,0,0]).plus(t),[-1,0,0],[0,0,1]),new n.Connector(new n.Vector3D([0,r.y,0]).plus(t),[0,1,0],[0,0,1]),new n.Connector(new n.Vector3D([0,-r.y,0]).plus(t),[0,-1,0],[0,0,1]),new n.Connector(new n.Vector3D([0,0,r.z]).plus(t),[0,0,1],[1,0,0]),new n.Connector(new n.Vector3D([0,0,-r.z]).plus(t),[0,0,-1],[1,0,0])],o},n.sphere=function(e){e=e||{};var t,r,o,i=n.parseOptionAs3DVector(e,"center",[0,0,0]),s=n.parseOptionAsFloat(e,"radius",1),a=n.parseOptionAsInt(e,"res",n.defaultResolution3D);if(s<0)throw new Error("Radius should be positive");if(s<1e-6)return console.log("Throwing out a zero-radius sphere."),new n;"axes"in e?(t=e.axes[0].unit().times(s),r=e.axes[1].unit().times(s),o=e.axes[2].unit().times(s)):(t=new n.Vector3D([1,0,0]).times(s),r=new n.Vector3D([0,-1,0]).times(s),o=new n.Vector3D([0,0,1]).times(s)),a<4&&(a=4);for(var l,u=Math.round(a/4),h=[],c=0;c<=a;c++){var p=2*Math.PI*c/a,f=t.times(Math.cos(p)).plus(r.times(Math.sin(p)));if(c>0)for(var v,d,g=[],m=0;m<=u;m++){var x=.5*Math.PI*m/u,y=Math.cos(x),_=Math.sin(x);m>0&&((g=[]).push(new n.Vertex(i.plus(l.times(v).minus(o.times(d))))),g.push(new n.Vertex(i.plus(f.times(v).minus(o.times(d))))),m<u&&g.push(new n.Vertex(i.plus(f.times(y).minus(o.times(_))))),g.push(new n.Vertex(i.plus(l.times(y).minus(o.times(_))))),h.push(new n.Polygon(g)),(g=[]).push(new n.Vertex(i.plus(l.times(v).plus(o.times(d))))),g.push(new n.Vertex(i.plus(f.times(v).plus(o.times(d))))),m<u&&g.push(new n.Vertex(i.plus(f.times(y).plus(o.times(_))))),g.push(new n.Vertex(i.plus(l.times(y).plus(o.times(_))))),g.reverse(),h.push(new n.Polygon(g))),v=y,d=_}l=f}var w=n.fromPolygons(h);return w.properties.sphere=new n.Properties,w.properties.sphere.center=new n.Vector3D(i),w.properties.sphere.facepoint=i.plus(t),w},n.cylinder=function(e){var t=n.parseOptionAs3DVector(e,"start",[0,-1,0]),r=n.parseOptionAs3DVector(e,"end",[0,1,0]),o=n.parseOptionAsFloat(e,"radius",1),i=n.parseOptionAsFloat(e,"radiusEnd",o),s=n.parseOptionAsFloat(e,"radiusStart",o),a=n.parseOptionAsFloat(e,"sectorAngle",360);if(a=a>360?a%360:a,i<0||s<0)throw new Error("Radius should be non-negative");if(Math.abs(r.z-t.z)<5e-4||i<5e-4&&s<5e-4)return console.log("throwing out a zero-height cylinder or a cylinder with both ends < 0.0005"),new n;var l=n.parseOptionAsInt(e,"res",n.defaultResolution2D),u=r.minus(t),h=u.unit(),c=h.randomNonParallelVector().unit(),p=c.cross(h).unit(),f=new n.Vertex(t),v=new n.Vertex(r),d=[];function g(e,r,o){var i=r*Math.PI*a/180,s=c.times(Math.cos(i)).plus(p.times(Math.sin(i))),l=t.plus(u.times(e)).plus(s.times(o));return new n.Vertex(l)}if(a>0){for(var m=0;m<l;m++){var x=m/l,y=(m+1)/l;i==s?(d.push(new n.Polygon([f,g(0,x,i),g(0,y,i)])),d.push(new n.Polygon([g(0,y,i),g(0,x,i),g(1,x,i),g(1,y,i)])),d.push(new n.Polygon([v,g(1,y,i),g(1,x,i)]))):(s>0&&(d.push(new n.Polygon([f,g(0,x,s),g(0,y,s)])),d.push(new n.Polygon([g(0,x,s),g(1,x,i),g(0,y,s)]))),i>0&&(d.push(new n.Polygon([v,g(1,y,i),g(1,x,i)])),d.push(new n.Polygon([g(1,x,i),g(1,y,i),g(0,y,s)]))))}a<360&&(d.push(new n.Polygon([f,v,g(0,0,s)])),d.push(new n.Polygon([g(0,0,s),v,g(1,0,i)])),d.push(new n.Polygon([f,g(0,1,s),v])),d.push(new n.Polygon([g(0,1,s),g(1,1,i),v])))}var _=n.fromPolygons(d);_.properties.cylinder=new n.Properties,_.properties.cylinder.start=new n.Connector(t,h.negated(),c),_.properties.cylinder.end=new n.Connector(r,h,c);var w=t.plus(u.times(.5)),P=c.rotate(t,h,-a/2).times((s+i)/2),V=P.cross(h);return _.properties.cylinder.facepointH=new n.Connector(w.plus(P),P,h),_.properties.cylinder.facepointH90=new n.Connector(w.plus(V),V,h),_},n.roundedCylinder=function(e){var t,r=n.parseOptionAs3DVector(e,"start",[0,-1,0]),o=n.parseOptionAs3DVector(e,"end",[0,1,0]),i=n.parseOptionAsFloat(e,"radius",1),s=o.minus(r);t=Math.abs(s.x)>Math.abs(s.y)?new n.Vector3D(0,1,0):new n.Vector3D(1,0,0);var a=n.parseOptionAs3DVector(e,"normal",t),l=n.parseOptionAsInt(e,"resolution",n.defaultResolution3D);l<4&&(l=4);var u=[],h=Math.floor(.25*l);if(s.length()<1e-10)return n.sphere({center:r,radius:i,resolution:l});for(var c,p=s.unit().times(i),f=p.cross(a).unit().times(i),v=f.cross(p).unit().times(i),d=0;d<=l;d++){var g=2*Math.PI*d/l,m=f.times(Math.cos(g)).plus(v.times(Math.sin(g)));if(d>0){var x,y,_=[];_.push(new n.Vertex(r.plus(m))),_.push(new n.Vertex(r.plus(c))),_.push(new n.Vertex(o.plus(c))),_.push(new n.Vertex(o.plus(m))),u.push(new n.Polygon(_));for(var w=0;w<=h;w++){var P=.5*Math.PI*w/h,V=Math.cos(P),z=Math.sin(P);w>0&&((_=[]).push(new n.Vertex(r.plus(c.times(x).minus(p.times(y))))),_.push(new n.Vertex(r.plus(m.times(x).minus(p.times(y))))),w<h&&_.push(new n.Vertex(r.plus(m.times(V).minus(p.times(z))))),_.push(new n.Vertex(r.plus(c.times(V).minus(p.times(z))))),u.push(new n.Polygon(_)),(_=[]).push(new n.Vertex(o.plus(c.times(x).plus(p.times(y))))),_.push(new n.Vertex(o.plus(m.times(x).plus(p.times(y))))),w<h&&_.push(new n.Vertex(o.plus(m.times(V).plus(p.times(z))))),_.push(new n.Vertex(o.plus(c.times(V).plus(p.times(z))))),_.reverse(),u.push(new n.Polygon(_))),x=V,y=z}}c=m}var D=n.fromPolygons(u),C=p.unit(),M=f.unit();return D.properties.roundedCylinder=new n.Properties,D.properties.roundedCylinder.start=new n.Connector(r,C.negated(),M),D.properties.roundedCylinder.end=new n.Connector(o,C,M),D.properties.roundedCylinder.facepoint=r.plus(f),D},n.roundedCube=function(e){var t,r;if("corner1"in(e=e||{})||"corner2"in e){if("center"in e||"radius"in e)throw new Error("roundedCube: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=n.parseOptionAs3DVector(e,"corner1",[0,0,0]),corner2=n.parseOptionAs3DVector(e,"corner2",[1,1,1]),t=corner1.plus(corner2).times(.5),r=corner2.minus(corner1).times(.5)}else t=n.parseOptionAs3DVector(e,"center",[0,0,0]),r=n.parseOptionAs3DVector(e,"radius",[1,1,1]);r=r.abs();var o=n.parseOptionAsInt(e,"resolution",n.defaultResolution3D);o<4&&(o=4),o%2==1&&o<8&&(o=8);var i=n.parseOptionAs3DVector(e,"roundradius",[.2,.2,.2]);i=n.Vector3D.Create(Math.max(i.x,.01),Math.max(i.y,.01),Math.max(i.z,.01));var s=r.minus(i);if(s.x<0||s.y<0||s.z<0)throw"roundradius <= radius!";var a=n.sphere({radius:1,resolution:o});return a=a.scale(i),s.x>1e-5&&(a=a.stretchAtPlane([1,0,0],[0,0,0],2*s.x)),s.y>1e-5&&(a=a.stretchAtPlane([0,1,0],[0,0,0],2*s.y)),s.z>1e-5&&(a=a.stretchAtPlane([0,0,1],[0,0,0],2*s.z)),(a=(a=a.tr([-s.x+t.x,-s.y+t.y,-s.z+t.z])).reTesselated()).properties.roundedCube=new n.Properties,a.properties.roundedCube.center=new n.Vertex(t),a.properties.roundedCube.facecenters=[new n.Connector(new n.Vector3D([r.x,0,0]).plus(t),[1,0,0],[0,0,1]),new n.Connector(new n.Vector3D([-r.x,0,0]).plus(t),[-1,0,0],[0,0,1]),new n.Connector(new n.Vector3D([0,r.y,0]).plus(t),[0,1,0],[0,0,1]),new n.Connector(new n.Vector3D([0,-r.y,0]).plus(t),[0,-1,0],[0,0,1]),new n.Connector(new n.Vector3D([0,0,r.z]).plus(t),[0,0,1],[1,0,0]),new n.Connector(new n.Vector3D([0,0,-r.z]).plus(t),[0,0,-1],[1,0,0])],a},n.polyhedron=function(e){if("points"in(e=e||{})!="faces"in e)throw new Error("polyhedron needs 'points' and 'faces' arrays");var t=n.parseOptionAs3DVectorList(e,"points",[[1,1,0],[1,-1,0],[-1,-1,0],[-1,1,0],[0,0,1]]).map(function(e){return new n.Vertex(e)}),r=n.parseOption(e,"faces",[[0,1,4],[1,2,4],[2,3,4],[3,0,4],[1,0,3],[2,1,3]]);r.forEach(function(e){e.reverse()});var o=r.map(function(e){return new n.Polygon(e.map(function(e){return t[e]}))});return n.fromPolygons(o).reTesselated()},n.IsFloat=function(e){return!isNaN(e)||e===1/0||e===-1/0},n.solve2Linear=function(e,t,n,r,o,i){var s=1/(e*r-t*n),a=o*r-t*i,l=-o*n+e*i;return[a*=s,l*=s]},n.Vector3D=function(e,t,r){if(3==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t),this._z=parseFloat(r);else if(2==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t),this._z=0;else{var o=!0;if(1==arguments.length)if("object"==typeof e)e instanceof n.Vector3D?(this._x=e._x,this._y=e._y,this._z=e._z):e instanceof n.Vector2D?(this._x=e._x,this._y=e._y,this._z=0):e instanceof Array?e.length<2||e.length>3?o=!1:(this._x=parseFloat(e[0]),this._y=parseFloat(e[1]),3==e.length?this._z=parseFloat(e[2]):this._z=0):"x"in e&&"y"in e?(this._x=parseFloat(e.x),this._y=parseFloat(e.y),this._z="z"in e?parseFloat(e.z):0):o=!1;else{var i=parseFloat(e);this._x=i,this._y=i,this._z=i}else o=!1;if(o&&(n.IsFloat(this._x)&&n.IsFloat(this._y)&&n.IsFloat(this._z)||(o=!1)),!o)throw new Error("Undefined value.  Check to see if you are using a loop variable in code outside of a loop, or any variable without defining the value.")}},n.Vector3D.Create=function(e,t,r){var o=Object.create(n.Vector3D.prototype);return o._x=e,o._y=t,o._z=r,o},n.Vector3D.prototype={get x(){return this._x},get y(){return this._y},get z(){return this._z},set x(e){throw new Error("Vector3D is immutable")},set y(e){throw new Error("Vector3D is immutable")},set z(e){throw new Error("Vector3D is immutable")},clone:function(){return n.Vector3D.Create(this._x,this._y,this._z)},negated:function(){return n.Vector3D.Create(-this._x,-this._y,-this._z)},abs:function(){return n.Vector3D.Create(Math.abs(this._x),Math.abs(this._y),Math.abs(this._z))},plus:function(e){return n.Vector3D.Create(this._x+e._x,this._y+e._y,this._z+e._z)},minus:function(e){return n.Vector3D.Create(this._x-e._x,this._y-e._y,this._z-e._z)},times:function(e){return n.Vector3D.Create(this._x*e,this._y*e,this._z*e)},dividedBy:function(e){return n.Vector3D.Create(this._x/e,this._y/e,this._z/e)},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z},lerp:function(e,t){return this.plus(e.minus(this).times(t))},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},unit:function(){return this.dividedBy(this.length())},cross:function(e){return n.Vector3D.Create(this._y*e._z-this._z*e._y,this._z*e._x-this._x*e._z,this._x*e._y-this._y*e._x)},distanceTo:function(e){return this.minus(e).length()},distanceToSquared:function(e){return this.minus(e).lengthSquared()},equals:function(e){return this._x==e._x&&this._y==e._y&&this._z==e._z},multiply4x4:function(e){return e.leftMultiply1x3Vector(this)},transform:function(e){return e.leftMultiply1x3Vector(this)},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+", "+this._z.toFixed(2)+")"},randomNonParallelVector:function(){var e=this.abs();return e._x<=e._y&&e._x<=e._z?n.Vector3D.Create(1,0,0):e._y<=e._x&&e._y<=e._z?n.Vector3D.Create(0,1,0):n.Vector3D.Create(0,0,1)},min:function(e){return n.Vector3D.Create(Math.min(this._x,e._x),Math.min(this._y,e._y),Math.min(this._z,e._z))},max:function(e){return n.Vector3D.Create(Math.max(this._x,e._x),Math.max(this._y,e._y),Math.max(this._z,e._z))},setZero:function(){this._x=0,this._y=0,this._z=0},hAdd:function(e,t){e._x+=t._x,e._y+=t._y,e._z+=t._z},hTimes:function(e,t){e._x*=t,e._y*=t,e._z*=t},normalize:function(){var e=this.lengthSquared(),t=e-1;if(t>4.440892098500626e-16||t<-4.440892098500626e-16){var n=Math.sqrt(e);this._x/=n,this._y/=n,this._z/=n}},set:function(e,t,n){this._x=e,this._y=t,this._z=n}},n.Vertex=function(e){this.pos=e},n.Vertex.fromObject=function(e){var t=new n.Vector3D(e.pos);return new n.Vertex(t)},n.Vertex.prototype={flipped:function(){return this},getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e},interpolate:function(e,t){var r=this.pos.lerp(e.pos,t);return new n.Vertex(r)},transform:function(e){var t=this.pos.multiply4x4(e);return new n.Vertex(t)},toString:function(){return this.pos.toString()}},n.hVertex=function(e,t,r,o){this.pnt=new n.Vector3D(e,t,r),4==arguments.length&&(this.index=o),this.next=null,this.prev=null,this.face=null},n.hVertex.prototype={clone:function(){return new n.hVertex(this._x,this._y,this._z,this.index)}},n.hVertexList=function(){this.head=null,this.tail=null},n.hVertexList.prototype={clear:function(){this.head=null,this.tail=null},add:function(e){null==this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e},addAll:function(e){for(null==this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!=e.next;)e=e.next;this.tail=e},delete:function(e,t){1==arguments.length?(null==e.prev?this.head=e.next:e.prev.next=e.next,null==e.next?this.tail=e.prev:e.next.prev=e.prev):2==arguments.length&&(null==e.prev?this.head=t.next:e.prev.next=t.next,null==t.next?this.tail=e.prev:t.next.prev=e.prev)},insertBefore:function(e,t){e.prev=t.prev,null==t.prev?this.head=e:t.prev.next=e,e.next=t,t.prev=e},first:function(){return this.head},isEmpty:function(){return null==this.head}},n.HalfEdge=function(e,t){2==arguments.length?(this.vertex=e,this.face=t):(this.vertex=null,this.face=null),this.prev=null,this.next=null,this.opposite=null},n.HalfEdge.prototype={setNext:function(e){this.next=e},getNext:function(){return this.next},setPrev:function(e){this.prev=e},getPrev:function(){return this.prev},getFace:function(){return this.face},getOpposite:function(){return this.opposite},setOpposite:function(e){this.opposite=e,e.opposite=this},head:function(){return this.vertex},tail:function(){return null!=this.prev?this.prev.vertex:null},oppositeFace:function(){return null!=this.opposite?this.opposite.face:null},getVertexString:function(){return null!=this.tail()?this.tail().index+"-"+this.head().index:"? -"+this.head().index},length:function(){return null!=this.tail()?this.head().pnt.distanceTo(this.tail().pnt):-1},lengthSquared:function(){return null!=this.tail()?this.head().pnt.distanceToSquared(this.tail().pnt):-1}},n.Face=function(){this.normal=new n.Vector3D(0,0,0),this.centroid=new n.Vector3D(0,0,0),this.mark=1,this.he0=null,this.area=-1,this.planeOffset=-1,this.index=-1,this.numVerts=-1,this.next=null,this.outside=null},n.Face.prototype={computeCentroid:function(e){e.setZero();var t=this.he0;do{e.hAdd(e,t.head().pnt),t=t.next}while(t!=this.he0);e.hTimes(e,1/this.numVerts)},computeNormal:function(e,t){var n=this.he0.next,r=n.next,o=this.he0.head().pnt,i=n.head().pnt,s=i._x-o._x,a=i._y-o._y,l=i._z-o._z;for(this.normal.setZero(),this.numVerts=2;r!=this.he0;){var u=s,h=a,c=l;s=(i=r.head().pnt)._x-o._x,a=i._y-o._y,l=i._z-o._z,this.normal._x+=h*l-c*a,this.normal._y+=c*s-u*l,this.normal._z+=u*a-h*s,n=r,r=r.next,this.numVerts++}if(this.area=this.normal.length(),this.normal.hTimes(this.normal,1/this.area),2==arguments.length&&this.area<t){var p=null,f=0,v=this.he0;do{var d=v.lengthSquared();d>f&&(p=v,f=d)}while(v!=this.he0);i=p.head().pnt,p1=p.tail().pnt;var g=Math.sqrt(f),m=(i._x-p1._x)/g,x=(i._y-p1._y)/g,y=(i._z-p1._z)/g,_=this.normal._x*m+this.normal._y*x+this.normal._z*y;this.normal._x-=_*m,this.normal._y-=_*x,this.normal._z-=_*y,this.normal.normalize()}},computeNormalAndCentroid:function(e){1==arguments.length?this.computeNormal(this.normal,e):this.computeNormal(this.normal),this.computeCentroid(this.centroid),this.planeOffset=this.normal.dot(this.centroid)},createTriangle:function(e,t,r,o){var i=new n.Face,s=new n.HalfEdge(e,i),a=new n.HalfEdge(t,i),l=new n.HalfEdge(r,i);return s.prev=l,s.next=a,a.prev=s,a.next=l,l.prev=a,l.next=s,i.he0=s,o?i.computeNormalAndCentroid(o):i.computeNormalAndCentroid(0),i},create:function(e,t){for(var r=new n.Face,o=null,i=0;i<t.length;i++){var s=new n.HalfEdge(e[t[i]],r);null!=o?(s.setPrev(o),o.setNext(s)):r.he0=s,o=s}return r.he0.setPrev(o),o.setNext(r.he0),r.computeNormalAndCentroid(),r},getEdge:function(e){for(var t=this.he0;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t},getFirstEdge:function(){return this.he0},findEdge:function(e,t){var n=this.he0;do{if(n.head()==t&&n.tail()==e)return n;n=n.next}while(n!=this.he0);return null},distanceToPlane:function(e){return this.normal._x*e._x+this.normal._y*e._y+this.normal._z*e._z-this.planeOffset},getNormal:function(){return this.normal},getCentroid:function(){return this.centroid},numVertices:function(){return this.numVerts},getVertexString:function(){var e="",t=this.he0;do{0==e.length?e+=t.head().index:e+=" "+t.head().index,t=t.next}while(t!=this.he0);return e},getVertexIndices:function(e){var t=this.he0,n=0;do{e[n++]=t.head().index,t=t.next}while(t!=this.he0)},connectHalfEdges:function(e,t){var n=null;if(e.oppositeFace()==t.oppositeFace()){var r,o=t.oppositeFace();e==this.he0&&(this.he0=t),3==o.numVertices()?(r=t.getOpposite().prev.getOpposite(),o.mark=3,n=o):(r=t.getOpposite().next,o.he0==r.prev&&(o.he0=r),r.prev=r.prev.prev,r.prev.next=r),t.prev=e.prev,t.prev.next=t,t.opposite=r,r.opposite=t,o.computeNormalAndCentroid()}else e.next=t,t.prev=e;return n},checkConsistency:function(){var e=this.he0,t=0,n=0;if(this.numVerts<3)throw"face"+this.getVertexString()+": unreflected half edge "+e.getVertexString();do{var r=e.getOpposite();if(null==r)throw"face "+this.getVertexString()+": unreflected half edge "+e.getVertexString();if(r.getOpposite()!=e)throw"face "+this.getVertexString()+": opposite half edge "+r.getVertexString()+" has opposite "+r.getOpposite().getVertexString();if(r.head()!=e.tail()||e.head()!=r.tail())throw"face "+this.getVertexString()+": half edge "+e.getVertexString()+" reflected by "+r.getVertexString();var o=r.face;if(null==o)throw"face "+this.getVertexString()+": no face on half edge "+r.getVertexString();if(3==o.mark)throw"face "+this.getVertexString()+": opposite face "+o.getVertexString()+" not on hull";var i=Math.abs(this.distanceToPlane(e.head().pnt));i>t&&(t=i),n++,e=e.next}while(e!=this.he0);if(n!=this.numVerts)throw"face "+this.getVertexString()+" numVerts="+this.numVerts+" should be "+n},mergeAdjacentFace:function(e,t){var n=e.oppositeFace(),r=0;t[r++]=n,n.mark=3;for(var o,i,s=e.getOpposite(),a=e.prev,l=e.next,u=s.prev,h=s.next;a.oppositeFace()==n;)a=a.prev,h=h.next;for(;l.oppositeFace()==n;)u=u.prev,l=l.next;for(o=h;o!=u.next;o=o.next)o.face=this;return e==this.he0&&(this.he0=l),null!=(i=this.connectHalfEdges(u,l))&&(t[r++]=i),null!=(i=this.connectHalfEdges(a,h))&&(t[r++]=i),this.computeNormalAndCentroid(),this.checkConsistency(),r},areaSquared:function(e,t){var n=e.tail().pnt,r=e.head().pnt,o=t.head().pnt,i=r._x-n._x,s=r._y-n._y,a=r._z-n._z,l=o._x-n._x,u=o._y-n._y,h=o._z-n._z,c=s*h-a*u,p=a*l-i*h,f=i*u-s*l;return c*c+p*p+f*f},triangulate:function(e,t){var r;if(!(this.numVertices<4)){var o=this.he0.head(),i=(r=this.he0.next).opposite,s=null;for(r=r.next;r!=this.he0.prev;r=r.next){(a=createTriangle(o,r.prev.head(),r.head(),t)).he0.next.setOpposite(i),a.he0.prev.setOpposite(r.opposite),i=a.he0,e.add(a),null==s&&(s=a)}(r=new n.HalfEdge(this.he0.prev.prev.head(),this)).setOpposite(i),r.prev=this.he0,r.prev.next=r,r.next=this.he0.prev,r.next.prev=r,computeNormalAndCentroid(t),checkConsistency();for(var a=s;null!=a;a=a.next)a.checkConsistency()}}},n.FaceList=function(){this.head=null,this.tail=null},n.FaceList.prototype={clear:function(){this.head=null,this.tail=null},add:function(e){null==this.head?this.head=e:this.tail.next=e,e.next=null,this.tail=e},first:function(){return this.head},isEmpty:function(){return null==this.head}},n.quickHull3D=function(){this.AUTOMATIC_TOLERANCE=-1,this.DOUBLE_PREC=2.220446049250313e-16,this.findIndex=-1,this.debug=!0,this.charLength=0,this.pointBuffer=[],this.vertexPointIndices=[],this.discardedFaces=[],this.maxVtxs=[],this.minVtxs=[];for(var e=0;e<3;e++)this.maxVtxs.push(new n.hVertex(0,0,0,e)),this.minVtxs.push(new n.hVertex(0,0,0,e)),this.discardedFaces.push(new n.Face);this.faces=[],this.horizon=[],this.newFaces=new n.FaceList,this.unclaimed=new n.hVertexList,this.claimed=new n.hVertexList,this.numVertices=0,this.numFaces=0,this.numPoints=0,this.explicitTolerance=this.AUTOMATIC_TOLERANCE,this.tolerance=0},n.quickHull3D.prototype={build:function(e){return e.length<4?(console.log("cannot build hull - fewer than four points"),null):(this.initBuffers(e,e.length),this.buildHull())},initBuffers:function(e,t){this.pointBuffer=[];for(var r=0;r<t;r++)this.pointBuffer.push(new n.hVertex(e[r]._x,e[r]._y,e[r]._z,r)),this.vertexPointIndices.push(0);this.faces=[],this.claimed.clear(),this.numVertices=t,this.numFaces=0,this.numPoints=t},buildHull:function(){var e;for(this.computeMaxAndMin(),this.createInitialSimplex();null!=(e=this.nextPointToAdd());)this.addPointToHull(e),0;return this.reindexFacesAndVertices(),this.getFaces()},computeMaxAndMin:function(){for(var e=this.pointBuffer[0],t=0;t<3;t++)this.maxVtxs[t]=this.pointBuffer[0],this.minVtxs[t]=this.pointBuffer[0];var n=[e.pnt._x,e.pnt._y,e.pnt._z],r=[e.pnt._x,e.pnt._y,e.pnt._z];for(t=0;t<this.numPoints;t++){var o=this.pointBuffer[t].pnt;o._x>n[0]?(n[0]=o._x,this.maxVtxs[0]=this.pointBuffer[t]):o._x<r[0]&&(r[0]=o._x,this.minVtxs[0]=this.pointBuffer[t]),o._y>n[1]?(n[1]=o._y,this.maxVtxs[1]=this.pointBuffer[t]):o._y<r[1]&&(r[1]=o._y,this.minVtxs[1]=this.pointBuffer[t]),o._z>n[2]?(n[2]=o._z,this.maxVtxs[2]=this.pointBuffer[t]):o._z<r[2]&&(r[2]=o._z,this.minVtxs[2]=this.pointBuffer[t])}this.charLength=Math.max(n[0]-r[0],n[1]-r[1],n[2]-r[2]),this.explicitTolerance==this.AUTOMATIC_TOLERANCE?this.tolerance=3*this.DOUBLE_PREC*(Math.max(Math.abs(n[0]),Math.abs(r[0]))+Math.max(Math.abs(n[1]),Math.abs(r[1]))+Math.max(Math.abs(n[2]),Math.abs(r[2]))):this.tolerance=this.explicitTolerance},createInitialSimplex:function(){var e=0,t=0,r=this.maxVtxs[0].pnt._x-this.minVtxs[0].pnt._x,o=this.maxVtxs[1].pnt._y-this.minVtxs[1].pnt._y,i=this.maxVtxs[2].pnt._z-this.minVtxs[2].pnt._z;if(r>e&&(e=r,t=0),o>e&&(e=o,t=1),i>e&&(e=i,t=2),e<=this.tolerance)throw"hull points are all coincident - fail!";var s=[];s[0]=this.maxVtxs[t],s[1]=this.minVtxs[t];var a=new n.Vector3D(s[1].pnt._x,s[1].pnt._y,s[1].pnt._z);(a=a.minus(s[0].pnt)).normalize();for(var l=new n.Vector3D(0,0,0),u=0,h=0;h<this.numPoints;h++){var c=this.pointBuffer[h],p=n.Vector3D.Create(c.pnt._x,c.pnt._y,c.pnt._z);p=p.minus(s[0].pnt);var f=n.Vector3D.Create(a._x,a._y,a._z),v=(f=f.cross(p)).lengthSquared();v>u&&this.pointBuffer[h]!=s[0]&&this.pointBuffer[h]!=s[1]&&(u=v,s[2]=this.pointBuffer[h],l.set(f._x,f._y,f._z))}if(Math.sqrt(u)<=100*this.tolerance)throw"Input points to hull appear to be co-linear";l.normalize();var d=0,g=s[2].pnt.dot(l);for(h=0;h<this.numPoints;h++){(w=Math.abs(this.pointBuffer[h].pnt.dot(l)-g))>d&&this.pointBuffer[h]!=s[0]&&this.pointBuffer[h]!=s[1]&&this.pointBuffer[h]!=s[2]&&(d=w,s[3]=this.pointBuffer[h])}if(Math.abs(d)<=100*this.tolerance)throw"Input points appear to be coplanar";var m=[new n.Face,new n.Face,new n.Face,new n.Face];if(s[3].pnt.dot(l)-g<0){m[0]=m[0].createTriangle(s[0],s[1],s[2]),m[1]=m[1].createTriangle(s[3],s[1],s[0]),m[2]=m[2].createTriangle(s[3],s[2],s[1]),m[3]=m[3].createTriangle(s[3],s[0],s[2]);for(h=0;h<3;h++){var x=(h+1)%3;m[h+1].getEdge(1).setOpposite(m[x+1].getEdge(0)),m[h+1].getEdge(2).setOpposite(m[0].getEdge(x))}}else{m[0]=m[0].createTriangle(s[0],s[2],s[1]),m[1]=m[1].createTriangle(s[3],s[0],s[1]),m[2]=m[2].createTriangle(s[3],s[1],s[2]),m[3]=m[3].createTriangle(s[3],s[2],s[0]);for(h=0;h<3;h++){x=(h+1)%3;m[h+1].getEdge(0).setOpposite(m[x+1].getEdge(1)),m[h+1].getEdge(2).setOpposite(m[0].getEdge((3-h)%3))}}for(h=0;h<4;h++)this.faces.push(m[h]);for(h=0;h<this.numPoints;h++){var y=this.pointBuffer[h];if(y!=s[0]&&y!=s[1]&&y!=s[2]&&y!=s[3]){d=this.tolerance;var _=null;for(x=0;x<4;x++){var w;(w=m[x].distanceToPlane(y.pnt))>d&&(_=m[x],d=w)}null!=_&&this.addPointToFace(y,_)}}},addPointToFace:function(e,t){e.face=t,null==t.outside?this.claimed.add(e):this.claimed.insertBefore(e,t.outside),t.outside=e},nextPointToAdd:function(){if(this.claimed.isEmpty())return null;for(var e=this.claimed.first().face,t=null,n=0,r=e.outside;null!=r&&r.face==e;r=r.next){var o=e.distanceToPlane(r.pnt);o>n&&(n=o,t=r)}return t},addPointToHull:function(e){this.horizon=[],this.unclaimed.clear(),this.removePointFromFace(e,e.face),this.calculateHorizon(e.pnt,null,e.face,this.horizon),this.newFaces.clear(),this.addNewFaces(this.newFaces,e,this.horizon);for(var t=this.newFaces.first();null!=t;t=t.next)if(1==t.mark)for(;this.doAdjacentMerge(t,1););for(t=this.newFaces.first();null!=t;t=t.next)if(2==t.mark)for(t.mark=1;this.doAdjacentMerge(t,2););this.resolveUnclaimedPoints(this.newFaces)},removePointFromFace:function(e,t){e==t.outside&&(null!=e.next&&e.next.face==t?t.outside=e.next:t.outside=null),this.claimed.delete(e)},calculateHorizon:function(e,t,n,r){var o;this.deleteFacePoints(n,null),n.mark=3,o=null==t?t=n.getEdge(0):t.getNext();do{var i=o.oppositeFace();1==i.mark&&(i.distanceToPlane(e)>this.tolerance?this.calculateHorizon(e,o.getOpposite(),i,r):r.push(o)),o=o.getNext()}while(o!=t)},oppFaceDistance:function(e){return e.face.distanceToPlane(e.opposite.face.getCentroid())},doAdjacentMerge:function(e,t){var n=e.he0,r=!0;do{var o=n.oppositeFace(),i=!1;if(2==t?(this.oppFaceDistance(n)>-1*this.tolerance||this.oppFaceDistance(n.opposite)>-1*this.tolerance)&&(i=!0):e.area>o.area?this.oppFaceDistance(n)>-this.tolerance?i=!0:this.oppFaceDistance(n.opposite)>-this.tolerance&&(r=!1):this.oppFaceDistance(n.opposite)>-this.tolerance?i=!0:this.oppFaceDistance(n)>-this.tolerance&&(r=!1),i){for(var s=e.mergeAdjacentFace(n,this.discardedFaces),a=0;a<s;a++)this.deleteFacePoints(this.discardedFaces[a],e);return!0}n=n.next}while(n!=e.he0);return r||(e.mark=2),!1},deleteFacePoints:function(e,t){var n=this.removeAllPointsFromFace(e);if(null!=n)if(null==t)this.unclaimed.addAll(n);else for(var r=n,o=r;null!=o;o=r){r=o.next,t.distanceToPlane(o.pnt)>this.tolerance?this.addPointToFace(o,t):this.unclaimed.add(o)}},removeAllPointsFromFace:function(e){if(null!=e.outside){for(var t=e.outside;null!=t.next&&t.next.face==e;)t=t.next;return this.claimed.delete(e.outside,t),t.next=null,e.outside}return null},addNewFaces:function(e,t,n){e.clear();for(var r=null,o=null,i=0;i<n.length;i++){var s=n[i],a=this.addAdjoiningFace(t,s);null!=r?a.next.setOpposite(r):o=a,e.add(a.getFace()),r=a}o.next.setOpposite(r)},addAdjoiningFace:function(e,t){var r=new n.Face;return r=r.createTriangle(e,t.tail(),t.head()),this.faces.push(r),r.getEdge(-1).setOpposite(t.getOpposite()),r.getEdge(0)},resolveUnclaimedPoints:function(e){for(var t=this.unclaimed.first(),n=t;null!=n;n=t){t=n.next;for(var r=this.tolerance,o=null,i=e.first();null!=i;i=i.next)if(1==i.mark){var s=i.distanceToPlane(n.pnt);if(s>r&&(r=s,o=i),r>1e3*this.tolerance)break}null!=o&&this.addPointToFace(n,o)}},reindexFacesAndVertices:function(){for(var e=0;e<this.numPoints;e++)this.pointBuffer[e].index=-1;this.numFaces=0;var t=[];for(e=0;e<this.faces.length;e++){var n=this.faces[e];1==n.mark&&(this.markFaceVertices(n,0),this.numFaces++,t.push(n))}this.faces=t,this.numVertices=0;for(e=0;e<this.numPoints;e++){var r=this.pointBuffer[e];0==r.index&&(this.vertexPointIndices[this.numVertices]=e,r.index=this.numVertices++)}},markFaceVertices:function(e,t){var n=e.getFirstEdge(),r=n;do{r.head().index=t,r=r.next}while(r!=n)},getFaces:function(){for(var e=[],t=0;t<this.faces.length;t++){var n=this.faces[t];e.push([]),this.getFaceIndices(e[t],n)}return e},getFaceIndices:function(e,t){var n=t.he0,r=0;do{var o=n.head().index;o=this.vertexPointIndices[o],e[r++]=o,n=n.next}while(n!=t.he0)},getVertices:function(){for(var e=[],t=0;t<this.numVertices;t++){var n=this.pointBuffer[this.vertexPointIndices[t]].pnt;e.push([n._x,n._y,n._z])}return e},printPoints:function(){for(var e=0;e<this.pointBuffer.length;e++){var t=this.pointBuffer[e].pnt;console.log(e+": "+t._x+", "+t._y+", "+t._z)}}},n.Plane=function(e,t){this.normal=e,this.w=t},n.Plane.fromObject=function(e){var t=new n.Vector3D(e.normal),r=parseFloat(e.w);return new n.Plane(t,r)},n.Plane.EPSILON=1e-5,n.Plane.fromVector3Ds=function(e,t,r){var o=t.minus(e).cross(r.minus(e)).unit();return new n.Plane(o,o.dot(e))},n.Plane.anyPlaneFromVector3Ds=function(e,t,r){var o=t.minus(e),i=r.minus(e);o.length()<1e-5&&(o=i.randomNonParallelVector()),i.length()<1e-5&&(i=o.randomNonParallelVector());var s=o.cross(i);return s.length()<1e-5&&(i=o.randomNonParallelVector(),s=o.cross(i)),s=s.unit(),new n.Plane(s,s.dot(e))},n.Plane.fromPoints=function(e,t,r){return e=new n.Vector3D(e),t=new n.Vector3D(t),r=new n.Vector3D(r),n.Plane.fromVector3Ds(e,t,r)},n.Plane.fromNormalAndPoint=function(e,t){e=new n.Vector3D(e),t=new n.Vector3D(t),e=e.unit();var r=t.dot(e);return new n.Plane(e,r)},n.Plane.prototype={flipped:function(){return new n.Plane(this.normal.negated(),-this.w)},getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e},equals:function(e){return this.normal.equals(e.normal)&&this.w==e.w},transform:function(e){var t=e.isMirroring(),r=this.normal.randomNonParallelVector(),o=this.normal.cross(r),i=this.normal.cross(o),s=this.normal.times(this.w),a=s.plus(o),l=s.plus(i);s=s.multiply4x4(e),a=a.multiply4x4(e),l=l.multiply4x4(e);var u=n.Plane.fromVector3Ds(s,a,l);return t&&(u=u.flipped()),u},splitPolygon:function(e){var t={type:null,front:null,back:null},r=this.normal,o=e.vertices,i=o.length;if(e.plane.equals(this))t.type=0;else{for(var s=n.Plane.EPSILON,a=this.w,l=!1,u=!1,h=[],c=-s,p=0;p<i;p++){var f=(C=r.dot(o[p].pos)-a)<0;h.push(f),C>s&&(l=!0),C<c&&(u=!0)}if(l||u)if(u)if(l){t.type=4;for(var v=[],d=[],g=(f=h[0],0);g<i;g++){var m=o[g],x=g+1;x>=i&&(x=0);var y=h[x];if(f==y)f?d.push(m):v.push(m);else{var _=m.pos,w=o[x].pos,P=this.splitLineBetweenPoints(_,w),V=new n.Vertex(P);f?(d.push(m),d.push(V),v.push(V)):(v.push(m),v.push(V),d.push(V))}f=y}var z=n.Plane.EPSILON*n.Plane.EPSILON;if(d.length>=3){var D=d[d.length-1];for(g=0;g<d.length;g++){(m=d[g]).pos.distanceToSquared(D.pos)<z&&(d.splice(g,1),g--),D=m}}if(v.length>=3)for(D=v[v.length-1],g=0;g<v.length;g++){(m=v[g]).pos.distanceToSquared(D.pos)<z&&(v.splice(g,1),g--),D=m}v.length>=3&&(t.front=new n.Polygon(v,e.shared,e.plane)),d.length>=3&&(t.back=new n.Polygon(d,e.shared,e.plane))}else t.type=3;else t.type=2;else{var C=r.dot(e.plane.normal);t.type=C>=0?0:1}}return t},splitLineBetweenPoints:function(e,t){var n=t.minus(e),r=(this.w-this.normal.dot(e))/this.normal.dot(n);return isNaN(r)&&(r=0),r>1&&(r=1),r<0&&(r=0),e.plus(n.times(r))},intersectWithLine:function(e){return e.intersectWithPlane(this)},intersectWithPlane:function(e){return n.Line3D.fromPlanes(this,e)},signedDistanceToPoint:function(e){return this.normal.dot(e)-this.w},toString:function(){return"[normal: "+this.normal.toString()+", w: "+this.w+"]"},mirrorPoint:function(e){var t=this.signedDistanceToPoint(e);return e.minus(this.normal.times(2*t))}},n.Polygon=function(e,t,r){this.vertices=e,t||(t=n.Polygon.defaultShared),this.shared=t,arguments.length>=3?this.plane=r:this.plane=n.Plane.fromVector3Ds(e[0].pos,e[1].pos,e[2].pos)},n.Polygon.fromObject=function(e){var t=e.vertices.map(function(e){return n.Vertex.fromObject(e)}),r=n.Polygon.Shared.fromObject(e.shared),o=n.Plane.fromObject(e.plane);return new n.Polygon(t,r,o)},n.Polygon.prototype={checkIfConvex:function(){if(!n.Polygon.verticesConvex(this.vertices,this.plane.normal))throw n.Polygon.verticesConvex(this.vertices,this.plane.normal),new Error("Not convex!")},sC:function(e){var t=n.Polygon.Shared.fromColor.apply(this,arguments);return this.shared=t,this},getSignedVolume:function(){for(var e=0,t=0;t<this.vertices.length-2;t++)e+=this.vertices[0].pos.dot(this.vertices[t+1].pos.cross(this.vertices[t+2].pos));return e/=6},getArea:function(){for(var e=0,t=0;t<this.vertices.length-2;t++)e+=this.vertices[t+1].pos.minus(this.vertices[0].pos).cross(this.vertices[t+2].pos.minus(this.vertices[t+1].pos)).length();return e/=2},getTetraFeatures:function(e){var t=[];return e.forEach(function(e){"volume"==e?t.push(this.getSignedVolume()):"area"==e&&t.push(this.getArea())},this),t},extrude:function(e){var t=[],r=this;r.plane.normal.dot(e)>0&&(r=r.flipped()),t.push(r);for(var o=r.tr(e),i=this.vertices.length,s=0;s<i;s++){var a=[],l=s<i-1?s+1:0;a.push(r.vertices[s].pos),a.push(o.vertices[s].pos),a.push(o.vertices[l].pos),a.push(r.vertices[l].pos);var u=n.Polygon.cFP(a,this.shared);t.push(u)}return o=o.flipped(),t.push(o),n.fromPolygons(t)},tr:function(e){return this.transform(n.Matrix4x4.translation(e))},boundingSphere:function(){if(!this.cachedBoundingSphere){var e=this.boundingBox(),t=e[0].plus(e[1]).times(.5),n=e[1].minus(t).length();this.cachedBoundingSphere=[t,n]}return this.cachedBoundingSphere},boundingBox:function(){if(!this.cachedBoundingBox){var e,t,r=this.vertices,o=r.length;t=e=0===o?new n.Vector3D(0,0,0):r[0].pos;for(var i=1;i<o;i++){var s=r[i].pos;e=e.min(s),t=t.max(s)}this.cachedBoundingBox=[e,t]}return this.cachedBoundingBox},flipped:function(){var e=this.vertices.map(function(e){return e.flipped()});e.reverse();var t=this.plane.flipped();return new n.Polygon(e,this.shared,t)},transform:function(e){var t=this.vertices.map(function(t){return t.transform(e)}),r=this.plane.transform(e);return e.isMirroring()&&t.reverse(),new n.Polygon(t,this.shared,r)},toString:function(){var e="Polygon plane: "+this.plane.toString()+"\n";return this.vertices.map(function(t){e+="  "+t.toString()+"\n"}),e},projectToOrthoNormalBasis:function(e){var t=this.vertices.map(function(t){return e.to2D(t.pos)}),n=o.fromPointsNoCheck(t),r=n.area();return Math.abs(r)<1e-5?n=new o:r<0&&(n=n.flipped()),n},solidFromSlices:function(e){var t,r=[],o=null,i=null,s=null,a=null,l=2,u=!1,h=null;if(e&&(u=Boolean(e.loop),e.numslices&&(l=e.numslices),e.callback&&(t=e.callback)),!t){var c=new n.Polygon.cFP([[0,0,0],[1,0,0],[1,1,0],[0,1,0]]);t=function(e,t){return 0==e||1==e?c.tr([0,0,e]):null}}for(var p=0,f=l-1;p<=f;p++)if(o=t.call(this,p/f,p)){if(!(o instanceof n.Polygon))throw new Error("CSG.Polygon.solidFromSlices callback error: CSG.Polygon expected");o.checkIfConvex(),i?(null===h&&(h=i.plane.signedDistanceToPoint(o.vertices[0].pos)<0),this._addWalls(r,i,o,h)):s=o,i=o}(a=o,u)?s.vertices.length==a.vertices.length&&s.vertices.every(function(e,t){return e.pos.equals(a.vertices[t].pos)})||this._addWalls(r,a,s,h):(r.unshift(h?s:s.flipped()),r.push(h?a.flipped():a));return n.fromPolygons(r)},_addWalls:function(e,t,r,o){var s=t.vertices.slice(0),a=r.vertices.slice(0),l=r.shared||null;s[0].pos.equals(s[s.length-1].pos)||s.push(s[0]),a[0].pos.equals(a[a.length-1].pos)||a.push(a[0]),o&&(s=s.reverse(),a=a.reverse());for(var u,h=a.length-1,c=s.length-1,p=h-c,f=p>0,v=p<0,d=[],g=Math.abs(p);g>0;g--)d.push({len:1/0,index:-1});if(v)for(g=0;g<c;g++){u=s[g].pos.distanceToSquared(s[g+1].pos);for(var m=d.length-1;m>=0;m--)if(d[m].len>u){d[m].len=u,d.index=m;break}}else if(f)for(g=0;g<h;g++){u=a[g].pos.distanceToSquared(a[g+1].pos);for(m=d.length-1;m>=0;m--)if(d[m].len>u){d[m].len=u,d.index=m;break}}d.sort(i);for(var x,y=function(e,t,r,o){return new n.Polygon([e,t,r],o)},_=s[0],w=a[0],P=0,V=0,z=h+c;P+V<z;){if(d.length){if(f&&V==d[0].index){x=a[++V],e.push(y(x,w,_,l)),w=x,d.shift();continue}if(v&&P==d[0].index){x=s[++P],e.push(y(w,_,x,l)),_=x,d.shift();continue}}(P<c?w.pos.distanceToSquared(s[P+1].pos):1/0)<=(V<h?_.pos.distanceToSquared(a[V+1].pos):1/0)?(x=s[++P],e.push(y(w,_,x,l)),_=x):V<h&&(x=a[++V],e.push(y(x,w,_,l)),w=x)}return e}},n.Polygon.verticesConvex=function(e,t){var r=e.length;if(r>2)for(var o=e[r-2].pos,i=e[r-1].pos,s=0;s<r;s++){var a=e[s].pos;if(!n.Polygon.isConvexPoint(o,i,a,t))return!1;o=i,i=a}return!0},n.Polygon.cFP=function(e,t,r){arguments.length<3?new n.Vector3D(0,0,0):r.normal;var o=[];return e.map(function(e){var t=new n.Vector3D(e),r=new n.Vertex(t);o.push(r)}),arguments.length<3?new n.Polygon(o,t):new n.Polygon(o,t,r)},n.Polygon.isConvexPoint=function(e,t,n,r){return t.minus(e).cross(n.minus(t)).dot(r)>=0},n.Polygon.isStrictlyConvexPoint=function(e,t,n,r){return t.minus(e).cross(n.minus(t)).dot(r)>=1e-5},n.Polygon.Shared=function(e){if(null!==e&&4!=e.length)throw new Error("Expecting 4 element array");this.color=e},n.Polygon.Shared.fromObject=function(e){return new n.Polygon.Shared(e.color)},n.Polygon.Shared.fromColor=function(e){var t;if(1==arguments.length)t=arguments[0].slice();else{t=[];for(var r=0;r<arguments.length;r++)t.push(arguments[r])}if(3==t.length)t.push(1);else if(4!=t.length)throw new Error("setColor expects either an array with 3 or 4 elements, or 3 or 4 parameters.");return new n.Polygon.Shared(t)},n.Polygon.Shared.prototype={getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e},getHash:function(){return this.color?this.color.join("/"):"null"}},n.Polygon.defaultShared=new n.Polygon.Shared(null),n.PolygonTreeNode=function(){this.parent=null,this.children=[],this.polygon=null,this.removed=!1},n.PolygonTreeNode.prototype={addPolygons:function(e){if(!this.isRootNode())throw new Error("Assertion failed");var t=this;e.map(function(e){t.addChild(e)})},remove:function(){if(!this.removed){this.removed=!0;var e=this.parent.children,t=e.indexOf(this);if(t<0)throw new Error("Assertion failed");e.splice(t,1),this.parent.recursivelyInvalidatePolygon()}},isRemoved:function(){return this.removed},isRootNode:function(){return!this.parent},invert:function(){if(!this.isRootNode())throw new Error("Assertion failed");this.invertSub()},getPolygon:function(){if(!this.polygon)throw new Error("Assertion failed");return this.polygon},getPolygons:function(e){var t,n,r,o,i=[this],s=[i];for(t=0;t<s.length;++t)for(n=0,r=(i=s[t]).length;n<r;n++)(o=i[n]).polygon?e.push(o.polygon):s.push(o.children)},splitByPlane:function(e,t,n,r,o){if(this.children.length){var i,s,a,l,u,h=[this.children];for(i=0;i<h.length;i++)for(s=0,a=(u=h[i]).length;s<a;s++)(l=u[s]).children.length?h.push(l.children):l._splitByPlane(e,t,n,r,o)}else this._splitByPlane(e,t,n,r,o)},_splitByPlane:function(e,t,n,r,o){var i=this.polygon;if(i){var s=i.boundingSphere(),a=s[1]+1e-4,l=e.normal,u=s[0],h=l.dot(u)-e.w;if(h>a)r.push(this);else if(h<-a)o.push(this);else{var c=e.splitPolygon(i);switch(c.type){case 0:t.push(this);break;case 1:n.push(this);break;case 2:r.push(this);break;case 3:o.push(this);break;case 4:if(c.front){var p=this.addChild(c.front);r.push(p)}if(c.back){var f=this.addChild(c.back);o.push(f)}}}}},addChild:function(e){var t=new n.PolygonTreeNode;return t.parent=this,t.polygon=e,this.children.push(t),t},invertSub:function(){var e,t,n,r,o=[this],i=[o];for(e=0;e<i.length;e++)for(t=0,n=(o=i[e]).length;t<n;t++)(r=o[t]).polygon&&(r.polygon=r.polygon.flipped()),i.push(r.children)},recursivelyInvalidatePolygon:function(){for(var e=this;e.polygon;)e.polygon=null,e.parent&&(e=e.parent)}},n.Tree=function(e){this.polygonTree=new n.PolygonTreeNode,this.rootnode=new n.Node(null),e&&this.addPolygons(e)},n.Tree.prototype={invert:function(){this.polygonTree.invert(),this.rootnode.invert()},clipTo:function(e,t){t=!!t,this.rootnode.clipTo(e,t)},allPolygons:function(){var e=[];return this.polygonTree.getPolygons(e),e},addPolygons:function(e){var t=this,n=e.map(function(e){return t.polygonTree.addChild(e)});this.rootnode.addPolygonTreeNodes(n)}},n.Node=function(e){this.plane=null,this.front=null,this.back=null,this.polygontreenodes=[],this.parent=e},n.Node.prototype={invert:function(){for(var e,t=[this],n=0;n<t.length;n++){(e=t[n]).plane&&(e.plane=e.plane.flipped()),e.front&&t.push(e.front),e.back&&t.push(e.back);var r=e.front;e.front=e.back,e.back=r}},clipPolygons:function(e,t){var n,r={node:this,polygontreenodes:e},o=[];do{if(n=r.node,e=r.polygontreenodes,n.plane){var i=[],s=[],a=t?i:s,l=n.plane,u=e.length;for(p=0;p<u;p++){var h=e[p];h.isRemoved()||h.splitByPlane(l,a,i,s,i)}n.front&&s.length>0&&o.push({node:n.front,polygontreenodes:s});var c=i.length;if(n.back&&c>0)o.push({node:n.back,polygontreenodes:i});else for(var p=0;p<c;p++)i[p].remove()}r=o.pop()}while(void 0!==r)},clipTo:function(e,t){var n=this,r=[];do{n.polygontreenodes.length>0&&e.rootnode.clipPolygons(n.polygontreenodes,t),n.front&&r.push(n.front),n.back&&r.push(n.back),n=r.pop()}while(void 0!==n)},addPolygonTreeNodes:function(e){var t,r={node:this,polygontreenodes:e},o=[];do{if(t=r.node,0!==(e=r.polygontreenodes).length){var i=t;if(!t.plane){var s=e[0].getPolygon().plane;t.plane=s}for(var a=[],l=[],u=0,h=e.length;u<h;++u)e[u].splitByPlane(i.plane,i.polygontreenodes,l,a,l);a.length>0&&(t.front||(t.front=new n.Node(t)),o.push({node:t.front,polygontreenodes:a})),l.length>0&&(t.back||(t.back=new n.Node(t)),o.push({node:t.back,polygontreenodes:l})),r=o.pop()}else r=o.pop()}while(void 0!==r)},getParentPlaneNormals:function(e,t){t>0&&this.parent&&(e.push(this.parent.plane.normal),this.parent.getParentPlaneNormals(e,t-1))}},n.Matrix4x4=function(e){arguments.length>=1?this.elements=e:this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},n.Matrix4x4.prototype={plus:function(e){for(var t=[],r=0;r<16;r++)t[r]=this.elements[r]+e.elements[r];return new n.Matrix4x4(t)},minus:function(e){for(var t=[],r=0;r<16;r++)t[r]=this.elements[r]-e.elements[r];return new n.Matrix4x4(t)},multiply:function(e){var t=this.elements[0],r=this.elements[1],o=this.elements[2],i=this.elements[3],s=this.elements[4],a=this.elements[5],l=this.elements[6],u=this.elements[7],h=this.elements[8],c=this.elements[9],p=this.elements[10],f=this.elements[11],v=this.elements[12],d=this.elements[13],g=this.elements[14],m=this.elements[15],x=e.elements[0],y=e.elements[1],_=e.elements[2],w=e.elements[3],P=e.elements[4],V=e.elements[5],z=e.elements[6],D=e.elements[7],C=e.elements[8],M=e.elements[9],b=e.elements[10],T=e.elements[11],F=e.elements[12],S=e.elements[13],A=e.elements[14],O=e.elements[15],B=[];return B[0]=t*x+r*P+o*C+i*F,B[1]=t*y+r*V+o*M+i*S,B[2]=t*_+r*z+o*b+i*A,B[3]=t*w+r*D+o*T+i*O,B[4]=s*x+a*P+l*C+u*F,B[5]=s*y+a*V+l*M+u*S,B[6]=s*_+a*z+l*b+u*A,B[7]=s*w+a*D+l*T+u*O,B[8]=h*x+c*P+p*C+f*F,B[9]=h*y+c*V+p*M+f*S,B[10]=h*_+c*z+p*b+f*A,B[11]=h*w+c*D+p*T+f*O,B[12]=v*x+d*P+g*C+m*F,B[13]=v*y+d*V+g*M+m*S,B[14]=v*_+d*z+g*b+m*A,B[15]=v*w+d*D+g*T+m*O,new n.Matrix4x4(B)},clone:function(){var e=this.elements.map(function(e){return e});return new n.Matrix4x4(e)},rightMultiply1x3Vector:function(e){var t=e._x,r=e._y,o=e._z,i=t*this.elements[0]+r*this.elements[1]+o*this.elements[2]+1*this.elements[3],s=t*this.elements[4]+r*this.elements[5]+o*this.elements[6]+1*this.elements[7],a=t*this.elements[8]+r*this.elements[9]+o*this.elements[10]+1*this.elements[11],l=t*this.elements[12]+r*this.elements[13]+o*this.elements[14]+1*this.elements[15];if(1!=l){var u=1/l;i*=u,s*=u,a*=u}return new n.Vector3D(i,s,a)},leftMultiply1x3Vector:function(e){var t=e._x,r=e._y,o=e._z,i=t*this.elements[0]+r*this.elements[4]+o*this.elements[8]+1*this.elements[12],s=t*this.elements[1]+r*this.elements[5]+o*this.elements[9]+1*this.elements[13],a=t*this.elements[2]+r*this.elements[6]+o*this.elements[10]+1*this.elements[14],l=t*this.elements[3]+r*this.elements[7]+o*this.elements[11]+1*this.elements[15];if(1!=l){var u=1/l;i*=u,s*=u,a*=u}return new n.Vector3D(i,s,a)},rightMultiply1x2Vector:function(e){var t=e.x,r=e.y,o=t*this.elements[0]+r*this.elements[1]+0*this.elements[2]+1*this.elements[3],i=t*this.elements[4]+r*this.elements[5]+0*this.elements[6]+1*this.elements[7],s=(this.elements[8],this.elements[9],this.elements[10],this.elements[11],t*this.elements[12]+r*this.elements[13]+0*this.elements[14]+1*this.elements[15]);if(1!=s){var a=1/s;o*=a,i*=a,a}return new n.Vector2D(o,i)},leftMultiply1x2Vector:function(e){var t=e.x,r=e.y,o=t*this.elements[0]+r*this.elements[4]+0*this.elements[8]+1*this.elements[12],i=t*this.elements[1]+r*this.elements[5]+0*this.elements[9]+1*this.elements[13],s=(this.elements[2],this.elements[6],this.elements[10],this.elements[14],t*this.elements[3]+r*this.elements[7]+0*this.elements[11]+1*this.elements[15]);if(1!=s){var a=1/s;o*=a,i*=a,a}return new n.Vector2D(o,i)},isMirroring:function(){var e=new n.Vector3D(this.elements[0],this.elements[4],this.elements[8]),t=new n.Vector3D(this.elements[1],this.elements[5],this.elements[9]),r=new n.Vector3D(this.elements[2],this.elements[6],this.elements[10]);return e.cross(t).dot(r)<0}},n.Matrix4x4.unity=function(){return new n.Matrix4x4},n.Matrix4x4.rotationX=function(e){var t=e*Math.PI*(1/180),r=Math.cos(t),o=Math.sin(t),i=[1,0,0,0,0,r,o,0,0,-o,r,0,0,0,0,1];return new n.Matrix4x4(i)},n.Matrix4x4.rotationY=function(e){var t=e*Math.PI*(1/180),r=Math.cos(t),o=Math.sin(t),i=[r,0,-o,0,0,1,0,0,o,0,r,0,0,0,0,1];return new n.Matrix4x4(i)},n.Matrix4x4.rotationZ=function(e){var t=e*Math.PI*(1/180),r=Math.cos(t),o=Math.sin(t),i=[r,o,0,0,-o,r,0,0,0,0,1,0,0,0,0,1];return new n.Matrix4x4(i)},n.Matrix4x4.rotation=function(e,t,r){e=new n.Vector3D(e),t=new n.Vector3D(t);var o=n.Plane.fromNormalAndPoint(t,e),i=new n.OrthoNormalBasis(o),s=n.Matrix4x4.translation(e.negated());return s=(s=(s=(s=s.multiply(i.getProjectionMatrix())).multiply(n.Matrix4x4.rotationZ(r))).multiply(i.getInverseProjectionMatrix())).multiply(n.Matrix4x4.translation(e))},n.Matrix4x4.translation=function(e){var t=new n.Vector3D(e),r=[1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,t.z,1];return new n.Matrix4x4(r)},n.Matrix4x4.mirroring=function(e){var t=e.normal.x,r=e.normal.y,o=e.normal.z,i=e.w,s=[1-2*t*t,-2*r*t,-2*o*t,0,-2*t*r,1-2*r*r,-2*o*r,0,-2*t*o,-2*r*o,1-2*o*o,0,-2*t*i,-2*r*i,-2*o*i,1];return new n.Matrix4x4(s)},n.Matrix4x4.scaling=function(e){var t=new n.Vector3D(e),r=[t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1];return new n.Matrix4x4(r)},n.Vector2D=function(e,t){if(2==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t);else{var r=!0;if(1==arguments.length)if("object"==typeof e)e instanceof n.Vector2D?(this._x=e._x,this._y=e._y):e instanceof Array?(this._x=parseFloat(e[0]),this._y=parseFloat(e[1])):"x"in e&&"y"in e?(this._x=parseFloat(e.x),this._y=parseFloat(e.y)):r=!1;else{var o=parseFloat(e);this._x=o,this._y=o}else r=!1;if(r&&(n.IsFloat(this._x)&&n.IsFloat(this._y)||(r=!1)),!r)throw new Error("Undefined value.  Check to see if you are using a loop variable in code outside of a loop, or any variable without defining the value.")}},n.Vector2D.fromAngle=function(e){return n.Vector2D.fromAngleRadians(e)},n.Vector2D.fromAngleDegrees=function(e){var t=Math.PI*e/180;return n.Vector2D.fromAngleRadians(t)},n.Vector2D.fromAngleRadians=function(e){return n.Vector2D.Create(Math.cos(e),Math.sin(e))},n.Vector2D.Create=function(e,t){var r=Object.create(n.Vector2D.prototype);return r._x=e,r._y=t,r},n.Vector2D.prototype={get x(){return this._x},get y(){return this._y},set x(e){throw new Error("Vector2D is immutable")},set y(e){throw new Error("Vector2D is immutable")},toVector3D:function(e){return new n.Vector3D(this._x,this._y,e)},equals:function(e){return this._x==e._x&&this._y==e._y},clone:function(){return n.Vector2D.Create(this._x,this._y)},negated:function(){return n.Vector2D.Create(-this._x,-this._y)},plus:function(e){return n.Vector2D.Create(this._x+e._x,this._y+e._y)},minus:function(e){return n.Vector2D.Create(this._x-e._x,this._y-e._y)},times:function(e){return n.Vector2D.Create(this._x*e,this._y*e)},dividedBy:function(e){return n.Vector2D.Create(this._x/e,this._y/e)},dot:function(e){return this._x*e._x+this._y*e._y},lerp:function(e,t){return this.plus(e.minus(this).times(t))},length:function(){return Math.sqrt(this.dot(this))},distanceTo:function(e){return this.minus(e).length()},distanceToSquared:function(e){return this.minus(e).lengthSquared()},lengthSquared:function(){return this.dot(this)},unit:function(){return this.dividedBy(this.length())},cross:function(e){return this._x*e._y-this._y*e._x},normal:function(){return n.Vector2D.Create(this._y,-this._x)},multiply4x4:function(e){return e.leftMultiply1x2Vector(this)},transform:function(e){return e.leftMultiply1x2Vector(this)},angle:function(){return this.angleRadians()},angleDegrees:function(){return 180*this.angleRadians()/Math.PI},angleRadians:function(){return Math.atan2(this._y,this._x)},min:function(e){return n.Vector2D.Create(Math.min(this._x,e._x),Math.min(this._y,e._y))},max:function(e){return n.Vector2D.Create(Math.max(this._x,e._x),Math.max(this._y,e._y))},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+")"},abs:function(){return n.Vector2D.Create(Math.abs(this._x),Math.abs(this._y))}},n.Line2D=function(e,t){e=new n.Vector2D(e),t=parseFloat(t);var r=e.length();t*=r,e=e.times(1/r),this.normal=e,this.w=t},n.Line2D.fromPoints=function(e,t){e=new n.Vector2D(e);var r=(t=new n.Vector2D(t)).minus(e).normal().negated().unit(),o=e.dot(r);return new n.Line2D(r,o)},n.Line2D.prototype={reverse:function(){return new n.Line2D(this.normal.negated(),-this.w)},equals:function(e){return e.normal.equals(this.normal)&&e.w==this.w},origin:function(){return this.normal.times(this.w)},direction:function(){return this.normal.normal()},xAtY:function(e){return(this.w-this.normal._y*e)/this.normal.x},absDistanceToPoint:function(e){var t=(e=new n.Vector2D(e)).dot(this.normal);return Math.abs(t-this.w)},intersectWithLine:function(e){var t=n.solve2Linear(this.normal.x,this.normal.y,e.normal.x,e.normal.y,this.w,e.w);return t=new n.Vector2D(t)},transform:function(e){var t=new n.Vector2D(0,0),r=this.normal.times(this.w),o=t.multiply4x4(e),i=this.normal.multiply4x4(e).minus(o),s=r.multiply4x4(e),a=i.dot(s);return new n.Line2D(i,a)}},n.Line3D=function(e,t){e=new n.Vector3D(e),t=new n.Vector3D(t),this.point=e,this.direction=t.unit()},n.Line3D.fromPoints=function(e,t){e=new n.Vector3D(e);var r=(t=new n.Vector3D(t)).minus(e);return new n.Line3D(e,r)},n.Line3D.fromPlanes=function(e,t){var r=e.normal.cross(t.normal),o=r.length();if(o<1e-10)throw new Error("Parallel planes");r=r.times(1/o);var i,s=Math.abs(r.x),a=Math.abs(r.y),l=Math.abs(r.z);if(s>=a&&s>=l){var u=n.solve2Linear(e.normal.y,e.normal.z,t.normal.y,t.normal.z,e.w,t.w);i=new n.Vector3D(0,u[0],u[1])}else if(a>=s&&a>=l){u=n.solve2Linear(e.normal.x,e.normal.z,t.normal.x,t.normal.z,e.w,t.w);i=new n.Vector3D(u[0],0,u[1])}else{u=n.solve2Linear(e.normal.x,e.normal.y,t.normal.x,t.normal.y,e.w,t.w);i=new n.Vector3D(u[0],u[1],0)}return new n.Line3D(i,r)},n.Line3D.prototype={intersectWithPlane:function(e){var t=(e.w-e.normal.dot(this.point))/e.normal.dot(this.direction);return this.point.plus(this.direction.times(t))},clone:function(e){return new n.Line3D(this.point.clone(),this.direction.clone())},reverse:function(){return new n.Line3D(this.point.clone(),this.direction.negated())},transform:function(e){var t=this.point.multiply4x4(e),r=this.point.plus(this.direction).multiply4x4(e).minus(t);return new n.Line3D(t,r)},closestPointOnLine:function(e){var t=(e=new n.Vector3D(e)).minus(this.point).dot(this.direction)/this.direction.dot(this.direction);return this.point.plus(this.direction.times(t))},distanceToPoint:function(e){e=new n.Vector3D(e);var t=this.closestPointOnLine(e);return e.minus(t).length()},equals:function(e){return!!this.direction.equals(e.direction)&&!(this.distanceToPoint(e.point)>1e-8)}},n.OrthoNormalBasis=function(e,t){t=arguments.length<2?e.normal.randomNonParallelVector():new n.Vector3D(t),this.v=e.normal.cross(t).unit(),this.u=this.v.cross(e.normal),this.plane=e,this.planeorigin=e.normal.times(e.w)},n.OrthoNormalBasis.GetCartesian=function(e,t){var r,o,i=e+"/"+t;if("X/Y"==i)r=[0,0,1],o=[1,0,0];else if("Y/-X"==i)r=[0,0,1],o=[0,1,0];else if("-X/-Y"==i)r=[0,0,1],o=[-1,0,0];else if("-Y/X"==i)r=[0,0,1],o=[0,-1,0];else if("-X/Y"==i)r=[0,0,-1],o=[-1,0,0];else if("-Y/-X"==i)r=[0,0,-1],o=[0,-1,0];else if("X/-Y"==i)r=[0,0,-1],o=[1,0,0];else if("Y/X"==i)r=[0,0,-1],o=[0,1,0];else if("X/Z"==i)r=[0,-1,0],o=[1,0,0];else if("Z/-X"==i)r=[0,-1,0],o=[0,0,1];else if("-X/-Z"==i)r=[0,-1,0],o=[-1,0,0];else if("-Z/X"==i)r=[0,-1,0],o=[0,0,-1];else if("-X/Z"==i)r=[0,1,0],o=[-1,0,0];else if("-Z/-X"==i)r=[0,1,0],o=[0,0,-1];else if("X/-Z"==i)r=[0,1,0],o=[1,0,0];else if("Z/X"==i)r=[0,1,0],o=[0,0,1];else if("Y/Z"==i)r=[1,0,0],o=[0,1,0];else if("Z/-Y"==i)r=[1,0,0],o=[0,0,1];else if("-Y/-Z"==i)r=[1,0,0],o=[0,-1,0];else if("-Z/Y"==i)r=[1,0,0],o=[0,0,-1];else if("-Y/Z"==i)r=[-1,0,0],o=[0,-1,0];else if("-Z/-Y"==i)r=[-1,0,0],o=[0,0,-1];else if("Y/-Z"==i)r=[-1,0,0],o=[0,1,0];else{if("Z/Y"!=i)throw new Error("CSG.OrthoNormalBasis.GetCartesian: invalid combination of axis identifiers. Should pass two string arguments from [X,Y,Z,-X,-Y,-Z], being two different axes.");r=[-1,0,0],o=[0,0,1]}return new n.OrthoNormalBasis(new n.Plane(new n.Vector3D(r),0),new n.Vector3D(o))},n.OrthoNormalBasis.Z0Plane=function(){var e=new n.Plane(new n.Vector3D([0,0,1]),0);return new n.OrthoNormalBasis(e,new n.Vector3D([1,0,0]))},n.OrthoNormalBasis.prototype={getProjectionMatrix:function(){return new n.Matrix4x4([this.u.x,this.v.x,this.plane.normal.x,0,this.u.y,this.v.y,this.plane.normal.y,0,this.u.z,this.v.z,this.plane.normal.z,0,0,0,-this.plane.w,1])},getInverseProjectionMatrix:function(){var e=this.plane.normal.times(this.plane.w);return new n.Matrix4x4([this.u.x,this.u.y,this.u.z,0,this.v.x,this.v.y,this.v.z,0,this.plane.normal.x,this.plane.normal.y,this.plane.normal.z,0,e.x,e.y,e.z,1])},to2D:function(e){return new n.Vector2D(e.dot(this.u),e.dot(this.v))},to3D:function(e){return this.planeorigin.plus(this.u.times(e.x)).plus(this.v.times(e.y))},line3Dto2D:function(e){var t=e.point,r=e.direction.plus(t),o=this.to2D(t),i=this.to2D(r);return n.Line2D.fromPoints(o,i)},line2Dto3D:function(e){var t=e.origin(),r=e.direction().plus(t),o=this.to3D(t),i=this.to3D(r);return n.Line3D.fromPoints(o,i)},transform:function(e){var t=this.plane.transform(e),r=this.u.transform(e),o=new n.Vector3D(0,0,0).transform(e),i=r.minus(o);return new n.OrthoNormalBasis(t,i)}},n.interpolateBetween2DPointsForY=function(e,t,n){var r,o=n-e.y,i=t.y-e.y;return i<0&&(o=-o,i=-i),r=o<=0?0:o>=i?1:i<1e-10?.5:o/i,e.x+r*(t.x-e.x)},n.reTesselateCoplanarPolygons=function(e,o){var i=e.length;if(i>0){for(var s=e[0].plane,a=e[0].shared,l=new n.OrthoNormalBasis(s),u=[],h=[],c={},p={},f={},v=0;v<i;v++){var d=e[v],g=[],m=-1;if((E=d.vertices.length)>0){for(var x,y,_=0;_<E;_++){var w,P=l.to2D(d.vertices[_].pos),V=Math.floor(P.y*(1/1e-5*10));V in f?w=f[V]:V+1 in f?w=f[V+1]:V-1 in f?w=f[V-1]:(w=P.y,f[V]=P.y),P=n.Vector2D.Create(P.x,w),g.push(P);var z=P.y;(0===_||z<x)&&(x=z,m=_),(0===_||z>y)&&(y=z,_),z in p||(p[z]={}),p[z][v]=!0}x>=y?(g=[],E=0,m=-1):(x in c||(c[x]=[]),c[x].push(v))}g.reverse(),m=E-m-1,u.push(g),h.push(m)}var D=[];for(var C in p)D.push(C);D.sort(t);for(var M=[],b=[],T=0;T<D.length;T++){for(var F,S=[],A=D[T],O=(C=Number(A),p[A]),B=0;B<M.length;++B){if(O[v=(X=M[B]).polygonindex]){for(var E=(g=u[v]).length,I=X.leftvertexindex,N=X.rightvertexindex;;){if((Z=I+1)>=E&&(Z=0),g[Z].y!=C)break;I=Z}if((Y=N-1)<0&&(Y=E-1),g[Y].y==C&&(N=Y),I!=X.leftvertexindex&&I==N)M.splice(B,1),--B;else X.leftvertexindex=I,X.rightvertexindex=N,X.topleft=g[I],X.topright=g[N],(Z=I+1)>=E&&(Z=0),X.bottomleft=g[Z],(Y=N-1)<0&&(Y=E-1),X.bottomright=g[Y]}}if(T>=D.length-1)M=[],F=null;else{var k=.5*(C+(F=Number(D[T+1]))),L=c[A];for(var R in L){E=(g=u[v=L[R]]).length;for(var q=h[v],j=q;;){if((_=j+1)>=E&&(_=0),g[_].y!=C)break;if(_==q)break;j=_}for(var G=q;;){if((_=G-1)<0&&(_=E-1),g[_].y!=C)break;if(_==j)break;G=_}var Z,Y;(Z=j+1)>=E&&(Z=0),(Y=G-1)<0&&(Y=E-1),r(M,{polygonindex:v,leftvertexindex:j,rightvertexindex:G,topleft:g[j],topright:g[G],bottomleft:g[Z],bottomright:g[Y]},function(e,t){var r=n.interpolateBetween2DPointsForY(e.topleft,e.bottomleft,k),o=n.interpolateBetween2DPointsForY(t.topleft,t.bottomleft,k);return r>o?1:r<o?-1:0})}}for(var H in M){E=(g=u[v=(X=M[H]).polygonindex]).length;var X,W=n.interpolateBetween2DPointsForY(X.topleft,X.bottomleft,C),U=n.Vector2D.Create(W,C);W=n.interpolateBetween2DPointsForY(X.topright,X.bottomright,C);var J=n.Vector2D.Create(W,C);W=n.interpolateBetween2DPointsForY(X.topleft,X.bottomleft,F);var K=n.Vector2D.Create(W,F);W=n.interpolateBetween2DPointsForY(X.topright,X.bottomright,F);var Q=n.Vector2D.Create(W,F),$={topleft:U,topright:J,bottomleft:K,bottomright:Q,leftline:n.Line2D.fromPoints(U,K),rightline:n.Line2D.fromPoints(Q,J)};if(S.length>0){var ee=S[S.length-1],te=$.topleft.distanceTo(ee.topright),ne=$.bottomleft.distanceTo(ee.bottomright);te<1e-5&&ne<1e-5&&($.topleft=ee.topleft,$.leftline=ee.leftline,$.bottomleft=ee.bottomleft,S.splice(S.length-1,1))}S.push($)}if(T>0){var re={},oe={};for(_=0;_<S.length;_++)for(var ie=S[_],se=0;se<b.length;se++){if(!oe[se])if((ue=b[se]).bottomleft.distanceTo(ie.topleft)<1e-5&&ue.bottomright.distanceTo(ie.topright)<1e-5){oe[se]=!0;te=ie.leftline.direction().x-ue.leftline.direction().x,ne=ie.rightline.direction().x-ue.rightline.direction().x;var ae=Math.abs(te)<1e-5,le=Math.abs(ne)<1e-5;(ae||te>=0)&&(le||ne>=0)&&(ie.outpolygon=ue.outpolygon,ie.leftlinecontinues=ae,ie.rightlinecontinues=le,re[se]=!0);break}}for(se=0;se<b.length;se++)if(!re[se]){var ue;(ue=b[se]).outpolygon.rightpoints.push(ue.bottomright),ue.bottomright.distanceTo(ue.bottomleft)>1e-5&&ue.outpolygon.leftpoints.push(ue.bottomleft),ue.outpolygon.leftpoints.reverse();var he=ue.outpolygon.rightpoints.concat(ue.outpolygon.leftpoints),ce=[];he.map(function(e){var t=l.to3D(e),r=new n.Vertex(t);ce.push(r)});var pe=new n.Polygon(ce,a,s);o.push(pe)}}for(_=0;_<S.length;_++){(ie=S[_]).outpolygon?(ie.leftlinecontinues||ie.outpolygon.leftpoints.push(ie.topleft),ie.rightlinecontinues||ie.outpolygon.rightpoints.push(ie.topright)):(ie.outpolygon={leftpoints:[],rightpoints:[]},ie.outpolygon.leftpoints.push(ie.topleft),ie.topleft.distanceTo(ie.topright)>1e-5&&ie.outpolygon.rightpoints.push(ie.topright))}b=S}}},n.fuzzyFactory=function(e,t){this.lookuptable={},this.multiplier=1/t},n.fuzzyFactory.prototype={lookupOrCreate:function(e,t){var n="",r=this.multiplier;if(e.forEach(function(e){var t=Math.round(e*r);n+=t+"/"}),n in this.lookuptable)return this.lookuptable[n];for(var o=t(e),i=e.map(function(e){var t=Math.floor(e*r);return[t+"/",t+1+"/"]}),s=1<<e.length,a=0;a<s;++a){var l=a;n="",i.forEach(function(e){n+=e[1&l],l>>=1}),this.lookuptable[n]=o}return o}},n.fuzzyCSGFactory=function(){this.vertexfactory=new n.fuzzyFactory(3,1e-5),this.planefactory=new n.fuzzyFactory(4,1e-5),this.polygonsharedfactory={}},n.fuzzyCSGFactory.prototype={getPolygonShared:function(e){var t=e.getHash();return t in this.polygonsharedfactory?this.polygonsharedfactory[t]:(this.polygonsharedfactory[t]=e,e)},getVertex:function(e){var t=[e.pos._x,e.pos._y,e.pos._z];return this.vertexfactory.lookupOrCreate(t,function(t){return e})},getPlane:function(e){var t=[e.normal._x,e.normal._y,e.normal._z,e.w];return this.planefactory.lookupOrCreate(t,function(t){return e})},getPolygon:function(e){var t=this.getPlane(e.plane),r=this.getPolygonShared(e.shared),o=this,i=e.vertices.map(function(e){return o.getVertex(e)}),s=[];if(i.length>0){var a=i[i.length-1].getTag();i.forEach(function(e){var t=e.getTag();t!=a&&s.push(e),a=t})}return s.length<3&&(s=[]),new n.Polygon(s,r,t)},getCSG:function(e){var t=this,r=[];return e.polygons.forEach(function(e){var n=t.getPolygon(e);n.vertices.length>=3&&r.push(n)}),n.fromPolygons(r)}},n.staticTag=1,n.getTag=function(){return n.staticTag++},n.Properties=function(){},n.Properties.prototype={_transform:function(e){var t=new n.Properties;return n.Properties.transformObj(this,t,e),t},_merge:function(e){var t=new n.Properties;return n.Properties.cloneObj(this,t),n.Properties.addFrom(t,e),t}},n.Properties.transformObj=function(e,t,r){for(var o in e)if("_transform"!=o&&"_merge"!=o){var i=e[o],s=i;"object"==typeof i&&("transform"in i&&"function"==typeof i.transform?s=i.transform(r):i instanceof Array?(s=[],n.Properties.transformObj(i,s,r)):i instanceof n.Properties&&(s=new n.Properties,n.Properties.transformObj(i,s,r))),t[o]=s}},n.Properties.cloneObj=function(e,t){for(var r in e)if("_transform"!=r&&"_merge"!=r){var o=e[r],i=o;if("object"==typeof o)if(o instanceof Array){i=[];for(var s=0;s<o.length;s++)i.push(o[s])}else o instanceof n.Properties&&(i=new n.Properties,n.Properties.cloneObj(o,i));t[r]=i}},n.Properties.addFrom=function(e,t){for(var r in t)"_transform"!=r&&"_merge"!=r&&(r in e&&"object"==typeof e[r]&&e[r]instanceof n.Properties&&"object"==typeof t[r]&&t[r]instanceof n.Properties?n.Properties.addFrom(e[r],t[r]):r in e||(e[r]=t[r]))},n.Connector=function(e,t,r){this.point=new n.Vector3D(e),this.axisvector=new n.Vector3D(t).unit(),this.normalvector=new n.Vector3D(r).unit()},n.Connector.prototype={normalized:function(){var e=this.axisvector.unit(),t=this.normalvector.cross(e).unit(),r=e.cross(t);return new n.Connector(this.point,e,r)},transform:function(e){var t=this.point.multiply4x4(e),r=this.point.plus(this.axisvector).multiply4x4(e).minus(t),o=this.point.plus(this.normalvector).multiply4x4(e).minus(t);return new n.Connector(t,r,o)},getTransformationTo:function(e,t,r){t=!!t,r=r?Number(r):0;var o=this.normalized();e=e.normalized();var i=n.Matrix4x4.translation(this.point.negated()),s=n.Plane.anyPlaneFromVector3Ds(new n.Vector3D(0,0,0),o.axisvector,e.axisvector),a=new n.OrthoNormalBasis(s),l=a.to2D(o.axisvector).angle(),u=a.to2D(e.axisvector).angle(),h=180*(u-l)/Math.PI;t&&(h+=180),i=(i=(i=i.multiply(a.getProjectionMatrix())).multiply(n.Matrix4x4.rotationZ(h))).multiply(a.getInverseProjectionMatrix());var c=o.transform(i),p=n.Plane.fromNormalAndPoint(e.axisvector,new n.Vector3D(0,0,0)),f=new n.OrthoNormalBasis(p);return l=f.to2D(c.normalvector).angle(),h=180*((u=f.to2D(e.normalvector).angle())-l)/Math.PI,h+=r,i=(i=(i=(i=i.multiply(f.getProjectionMatrix())).multiply(n.Matrix4x4.rotationZ(h))).multiply(f.getInverseProjectionMatrix())).multiply(n.Matrix4x4.translation(e.point))},axisLine:function(){return new n.Line3D(this.point,this.axisvector)},extend:function(e){var t=this.point.plus(this.axisvector.unit().times(e));return new n.Connector(t,this.axisvector,this.normalvector)}},n.ConnectorList=function(e){this.connectors_=e?e.slice():[]},n.ConnectorList.defaultNormal=[0,0,1],n.ConnectorList.fromPath2D=function(e,t,r){if(3===arguments.length)return n.ConnectorList._fromPath2DTangents(e,t,r);if(2==arguments.length)return n.ConnectorList._fromPath2DExplicit(e,t);throw"call with path2D and either 2 direction vectors, or a function returning direction vectors"},n.ConnectorList._fromPath2DTangents=function(e,t,r){var o,i=e.points.length,s=new n.ConnectorList([new n.Connector(e.points[0],t,n.ConnectorList.defaultNormal)]);return e.points.slice(1,i-1).forEach(function(t,r){o=e.points[r+2].minus(e.points[r]).toVector3D(0),s.appendConnector(new n.Connector(t.toVector3D(0),o,n.ConnectorList.defaultNormal))},this),s.appendConnector(new n.Connector(e.points[i-1],r,n.ConnectorList.defaultNormal)),s.closed=e.closed,s},n.ConnectorList._fromPath2DExplicit=function(e,t){var r=new n.ConnectorList(e.points.map(function(e,r){return new n.Connector(e.toVector3D(0),n.Vector3D.Create(1,0,0).rZ(function(e,t,n){return"function"==typeof e&&(e=e(t,n)),e}(t,e,r)),n.ConnectorList.defaultNormal)},this));return r.closed=e.closed,r},n.ConnectorList.prototype={setClosed:function(e){this.closed=!!closed},appendConnector:function(e){this.connectors_.push(e)},followWith:function(e){function t(e,t){return"function"==typeof e&&(e=e(t.point,t.axisvector,t.normalvector)),e}this.verify();var r,o=[],i=this.connectors_[this.connectors_.length-1],s=t(e,i);return this.connectors_.forEach(function(n,a){r=t(e,n),a||this.closed?o.push.apply(o,s._toWallPolygons({toConnector1:i,toConnector2:n,cag:r})):o.push.apply(o,r._toPlanePolygons({toConnector:n,flipped:!0})),a!=this.connectors_.length-1||this.closed||o.push.apply(o,r._toPlanePolygons({toConnector:n})),s=r,i=n},this),n.fromPolygons(o).reTesselated().canonicalized()},verify:function(){for(var e,t,n=0;n<this.connectors_.length-1;n++){if(e=this.connectors_[n],(t=this.connectors_[n+1]).point.minus(e.point).dot(e.axisvector)<=0)throw"Invalid ConnectorList. Each connectors position needs to be within a <90deg range of previous connectors axisvector";if(e.axisvector.dot(t.axisvector)<=0)throw"invalid ConnectorList. No neighboring connectors axisvectors may span a >=90deg angle"}}},n.Path2D=function(e,t){e=e||[];var r=null;(t=!!t)&&e.length>0&&(r=new n.Vector2D(e[e.length-1]));var o=[];e.map(function(e){e=new n.Vector2D(e);var t=!1;null!==r&&(t=e.distanceTo(r)<1e-5);t||o.push(e),r=e}),this.points=o,this.closed=t},n.Path2D.arc=function(e){for(var t=n.parseOptionAs2DVector(e,"center",0),r=n.parseOptionAsFloat(e,"radius",1),o=n.parseOptionAsFloat(e,"startangle",0),i=n.parseOptionAsFloat(e,"endangle",360),s=n.parseOptionAsInt(e,"resolution",n.defaultResolution2D),a=n.parseOptionAsBool(e,"maketangent",!1);i-o>=720;)i-=360;for(;i-o<=-720;)i+=360;var l,u=[],h=Math.abs(i-o);if(h<1e-5)l=n.Vector2D.fromAngle(o/180*Math.PI).times(r),u.push(l.plus(t));else{var c=Math.floor(s*h/360)+1,p=.5*c/h;p>.25&&(p=.25);for(var f=a?c+2:c,v=0;v<=f;v++){var d=v;a&&((d=(v-1)*(c-2*p)/c+p)<0&&(d=0),d>c&&(d=c));var g=o+d*(i-o)/c;l=n.Vector2D.fromAngle(g/180*Math.PI).times(r),u.push(l.plus(t))}}return new n.Path2D(u,!1)},n.Path2D.prototype={concat:function(e){if(this.closed||e.closed)throw new Error("Paths must not be closed");var t=this.points.concat(e.points);return new n.Path2D(t)},appendPoint:function(e){if(this.closed)throw new Error("Path must not be closed");e=new n.Vector2D(e);var t=this.points.concat([e]);return new n.Path2D(t)},appendPoints:function(e){if(this.closed)throw new Error("Path must not be closed");var t=this.points;return e.forEach(function(e){t.push(new n.Vector2D(e))}),new n.Path2D(t)},close:function(){return new n.Path2D(this.points,!0)},rectangularExtrude:function(e,t,n){return this.expandToCAG(e/2,n).extrude({offset:[0,0,t]})},expandToCAG:function(e,t){var n,r=[],i=this.points.length,s=0;this.closed&&i>2&&(s=-1);for(var a=s;a<i;a++){var l=a;l<0&&(l=i-1);var u=this.points[l],h=new o.Vertex(u);if(a>s){var c=new o.Side(n,h);r.push(c)}n=h}return o.fromSides(r).expandedShell(e,t)},innerToCAG:function(){if(!this.closed)throw new Error("The path should be closed!");return o.fromPoints(this.points)},transform:function(e){var t=this.points.map(function(t){return t.multiply4x4(e)});return new n.Path2D(t,this.closed)},appendBezier:function(e,t){if(arguments.length<2&&(t={}),this.closed)throw new Error("Path must not be closed");if(!(e instanceof Array))throw new Error("appendBezier: should pass an array of control points");if(e.length<1)throw new Error("appendBezier: need at least 1 control point");if(this.points.length<1)throw new Error("appendBezier: path must already contain a point (the endpoint of the path is used as the starting point for the bezier curve)");var r=n.parseOptionAsInt(t,"resolution",n.defaultResolution2D);r<4&&(r=4);var o=[],i=[];i.push(this.points[this.points.length-1]);for(var s=0;s<e.length;++s){var a=e[s];if(null===a){if(0!=s)throw new Error("appendBezier: null can only be passed as the first control point");if(e.length<2)throw new Error("appendBezier: null can only be passed if there is at least one more control point");var l;if("lastBezierControlPoint"in this)l=this.lastBezierControlPoint;else{if(this.points.length<2)throw new Error("appendBezier: null is passed as a control point but this requires a previous bezier curve or at least two points in the existing path");l=this.points[this.points.length-2]}a=this.points[this.points.length-1].times(2).minus(l)}else a=new n.Vector2D(a);i.push(a)}var u=i.length-1,h=1;for(s=0;s<=u;++s)s>0&&(h*=s),o.push(h);var c=[];for(s=0;s<=u;++s){var p=o[u]/(o[s]*o[u-s]);c.push(p)}var f=function(e){for(var t=1,r=Math.pow(1-e,u),o=1!=e?1/(1-e):1,s=new n.Vector2D(0,0),a=0;a<=u;++a){a==u&&(r=1);var l=c[a]*t*r;s=s.plus(i[a].times(l)),t*=e,r*=o}return s},v=[],d=[],g=u+1;for(s=0;s<g;++s){var m=s/(g-1),x=f(m);v.push(x),d.push(m)}for(var y=1,_=2*Math.PI/r,w=Math.sin(_);y<v.length-1;){var P=v[y].minus(v[y-1]).unit(),V=v[y+1].minus(v[y]).unit(),z=P.cross(V);if(Math.abs(z)>w){var D=d[y-1],C=d[y+1],M=D+1*(C-D)/3,b=D+2*(C-D)/3,T=f(M),F=f(b);v.splice(y,1,T,F),d.splice(y,1,M,b),--y<1&&(y=1)}else++y}v=this.points.concat(v.slice(1));var S=new n.Path2D(v);return S.lastBezierControlPoint=i[i.length-2],S},appendArc:function(e,t){if(arguments.length<2&&(t={}),this.closed)throw new Error("Path must not be closed");if(this.points.length<1)throw new Error("appendArc: path must already contain a point (the endpoint of the path is used as the starting point for the arc)");var r,o,i=n.parseOptionAsInt(t,"resolution",n.defaultResolution2D);if(i<4&&(i=4),"xradius"in t||"yradius"in t){if("radius"in t)throw new Error("Should either give an xradius and yradius parameter, or a radius parameter");r=n.parseOptionAsFloat(t,"xradius",0),o=n.parseOptionAsFloat(t,"yradius",0)}else o=r=n.parseOptionAsFloat(t,"radius",0);var s=n.parseOptionAsFloat(t,"xaxisrotation",0),a=n.parseOptionAsBool(t,"clockwise",!1),l=n.parseOptionAsBool(t,"large",!1),u=this.points[this.points.length-1];e=new n.Vector2D(e);var h=!a,c=[];if(0==r||0==o)c.push(e);else{r=Math.abs(r),o=Math.abs(o);var p=s*Math.PI/180,f=Math.cos(p),v=Math.sin(p),d=u.minus(e).times(.5),g=new n.Vector2D(f*d.x+v*d.y,-v*d.x+f*d.y),m=g.x*g.x/(r*r)+g.y*g.y/(o*o);if(m>1){var x=Math.sqrt(m);r*=x,o*=x}var y=Math.sqrt((r*r*o*o-r*r*g.y*g.y-o*o*g.x*g.x)/(r*r*g.y*g.y+o*o*g.x*g.x));h==l&&(y=-y);var _=new n.Vector2D(r*g.y/o,-o*g.x/r).times(y),w=new n.Vector2D(f*_.x-v*_.y,v*_.x+f*_.y).plus(u.plus(e).times(.5)),P=new n.Vector2D((g.x-_.x)/r,(g.y-_.y)/o),V=new n.Vector2D((-g.x-_.x)/r,(-g.y-_.y)/o),z=P.angleRadians(),D=V.angleRadians()-z;D%=2*Math.PI,!h&&D>0?D-=2*Math.PI:h&&D<0&&(D+=2*Math.PI);var C=Math.ceil(Math.abs(D)/(2*Math.PI)*i)+1;C<1&&(C=1);for(var M=1;M<=C;M++){var b=z+M/C*D,T=Math.cos(b),F=Math.sin(b),S=new n.Vector2D(f*r*T-v*o*F,v*r*T+f*o*F).plus(w);c.push(S)}}return c=this.points.concat(c),new n.Path2D(c)}},n.addTransformationMethodsToPrototype=function(e){e.mirrored=function(e){return this.transform(n.Matrix4x4.mirroring(e))},e.mirroredX=function(){var e=new n.Plane(n.Vector3D.Create(1,0,0),0);return this.mirrored(e)},e.mirroredY=function(){var e=new n.Plane(n.Vector3D.Create(0,1,0),0);return this.mirrored(e)},e.mirroredZ=function(){var e=new n.Plane(n.Vector3D.Create(0,0,1),0);return this.mirrored(e)},e.tr=function(e){return this.transform(n.Matrix4x4.translation(e))},e.scale=function(e){return this.transform(n.Matrix4x4.scaling(e))},e.rX=function(e){return this.transform(n.Matrix4x4.rotationX(e))},e.rY=function(e){return this.transform(n.Matrix4x4.rotationY(e))},e.rZ=function(e){return this.transform(n.Matrix4x4.rotationZ(e))},e.rotate=function(e,t,r){return this.transform(n.Matrix4x4.rotation(e,t,r))}},n.addCenteringToPrototype=function(e,t){e.center=function(e){(e=Array.prototype.map.call(arguments,function(e){return e})).length||(e=t.slice());var n=this.getBounds();return this.tr(t.map(function(t){return e.indexOf(t)>-1?-(n[0][t]+n[1][t])/2:0}))}};var o=function(){this.sides=[]};function i(e,t){return e.index-t.index}o.fromSides=function(e){var t=new o;return t.sides=e,t},o.fromEdges=function(e){for(var t=[],r=0;r<e.length;r++){var i=new n.Vector2D(e[r][0][0],e[r][0][1]),s=new o.Vertex(i),a=new n.Vector2D(e[r][1][0],e[r][1][1]),l=new o.Vertex(a);t.push(new o.Side(s,l))}var u=new o;return u.sides=t,u},o.fromPoints=function(e){var t=e.length;if(t<3)throw new Error("2D shape needs at least 3 points");var r=[],i=new n.Vector2D(e[t-1]),s=new o.Vertex(i);e.map(function(e){var t=new n.Vector2D(e),i=new o.Vertex(t),a=new o.Side(s,i);r.push(a),s=i});var a=o.fromSides(r);if(a.isSelfIntersecting())throw new Error("Polygon is self intersecting!");var l=a.area();if(Math.abs(l)<1e-5)throw new Error("Degenerate polygon! The polygon is too small to draw.");return l<0&&(a=a.flipped()),a=a.canonicalized()},o.fromPointsNoCheck=function(e){var t=[],r=new n.Vector2D(e[e.length-1]),i=new o.Vertex(r);return e.map(function(e){var r=new n.Vector2D(e),s=new o.Vertex(r),a=new o.Side(i,s);t.push(a),i=s}),o.fromSides(t)},o.fromFakeCSG=function(e){var t=e.polygons.map(function(e){return o.Side._fromFakePolygon(e)}).filter(function(e){return null!==e});return o.fromSides(t)},o.linesIntersect=function(e,t,r,o){if(t.equals(r)||o.equals(e)){if(o.minus(r).unit().plus(t.minus(e).unit()).length()<1e-5)return!0}else{var i=t.minus(e),s=o.minus(r);if(Math.abs(i.cross(s))<1e-9)return!1;var a=n.solve2Linear(-i.x,s.x,-i.y,s.y,e.x-r.x,e.y-r.y);if(a[0]>1e-6&&a[0]<.999999&&a[1]>1e-5&&a[1]<.999999)return!0}return!1},o.circle=function(e){e=e||{};var t,r=n.parseOptionAs2DVector(e,"center",[0,0]),i=n.parseOptionAsFloat(e,"radius",1),s=n.parseOptionAsInt(e,"resolution",n.defaultResolution2D),a=[];if(i<0)throw new Error("Radius should be positive.");if(i<5e-4)return new o;for(var l=0;l<=s;l++){var u=2*Math.PI*l/s,h=n.Vector2D.fromAngleRadians(u).times(i).plus(r),c=new o.Vertex(h);l>0&&a.push(new o.Side(t,c)),t=c}return o.fromSides(a)},o.rectangle=function(e){var t,r;if("corner1"in(e=e||{})||"corner2"in e){if("center"in e||"radius"in e)throw new Error("rectangle: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=n.parseOptionAs2DVector(e,"corner1",[0,0]),corner2=n.parseOptionAs2DVector(e,"corner2",[1,1]),t=corner1.plus(corner2).times(.5),r=corner2.minus(corner1).times(.5)}else t=n.parseOptionAs2DVector(e,"center",[0,0]),r=n.parseOptionAs2DVector(e,"radius",[1,1]);if(r.x<0||r.y<0)throw new Error("Dimension should be positive.");if(r.x<5e-4||r.y<5e-4)return console.log("Throwing out a zero-length rectangle."),new o;var i=new n.Vector2D(r.x,-r.y),s=[t.plus(r),t.plus(i),t.minus(r),t.minus(i)];return o.fromPoints(s)},o.roundedRectangle=function(e){var t,r;if("corner1"in(e=e||{})||"corner2"in e){if("center"in e||"radius"in e)throw new Error("roundedRectangle: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=n.parseOptionAs2DVector(e,"corner1",[0,0]),corner2=n.parseOptionAs2DVector(e,"corner2",[1,1]),t=corner1.plus(corner2).times(.5),r=corner2.minus(corner1).times(.5)}else t=n.parseOptionAs2DVector(e,"center",[0,0]),r=n.parseOptionAs2DVector(e,"radius",[1,1]);r=r.abs();var i=n.parseOptionAsFloat(e,"roundradius",.2),s=n.parseOptionAsInt(e,"resolution",n.defaultResolution2D),a=Math.min(r.x,r.y);a-=.1,i=Math.min(i,a),i=Math.max(0,i),r=new n.Vector2D(r.x-i,r.y-i);var l=o.rectangle({center:t,radius:r});return i>0&&(l=l.expand(i,s)),l},o.fromCompactBinary=function(e){if("CAG"!=e.class)throw new Error("Not a CAG");for(var t=[],r=e.vertexData,i=r.length/2,s=0,a=0;a<i;a++){var l=r[s++],u=r[s++],h=new n.Vector2D(l,u),c=new o.Vertex(h);t.push(c)}var p=[],f=e.sideVertexIndices.length/2;s=0;for(var v=0;v<f;v++){var d=e.sideVertexIndices[s++],g=e.sideVertexIndices[s++],m=new o.Side(t[d],t[g]);p.push(m)}var x=o.fromSides(p);return x.isCanonicalized=!0,x},o.prototype={toString:function(){var e="CAG ("+this.sides.length+" sides):\n";return this.sides.map(function(t){e+="  "+t.toString()+"\n"}),e},_toCSGWall:function(e,t){var r=this.sides.map(function(n){return n.toPolygon3D(e,t)});return n.fromPolygons(r)},_toVector3DPairs:function(e){var t=this.sides.map(function(e){var t=e.vertex0.pos,r=e.vertex1.pos;return[n.Vector3D.Create(t.x,t.y,0),n.Vector3D.Create(r.x,r.y,0)]});return void 0!==e&&(t=t.map(function(t){return t.map(function(t){return t.transform(e)})})),t},_toPlanePolygons:function(e){var t=e.flipped||!1,r=[0,0,0],o=[0,0,1],i=[0,1,0],s=new n.Connector(r,o,i),a=e.translation||r,l=e.axisVector||o,u=e.normalVector||i,h=e.toConnector||new n.Connector(a,l,u),c=s.getTransformationTo(h,!1,0),p=this.getBounds();p[0]=p[0].minus(new n.Vector2D(1,1)),p[1]=p[1].plus(new n.Vector2D(1,1));var f=this._toCSGWall(-1,1),v=n.fromPolygons([new n.Polygon([new n.Vertex(new n.Vector3D(p[0].x,p[0].y,0)),new n.Vertex(new n.Vector3D(p[1].x,p[0].y,0)),new n.Vertex(new n.Vector3D(p[1].x,p[1].y,0)),new n.Vertex(new n.Vector3D(p[0].x,p[1].y,0))])]);return t&&(v=v.invert()),(v=v.intersectSub(f)).polygons.filter(function(e){return Math.abs(e.plane.normal.z)>.99}).map(function(e){return e.transform(c)})},_toWallPolygons:function(e){var t=new n.Connector([0,0,0],[0,0,1],[0,1,0]),r=e.toConnector1,o=e.toConnector2;if(!(r instanceof n.Connector&&o instanceof n.Connector))throw"could not parse CSG.Connector arguments toConnector1 or toConnector2";if(e.cag&&e.cag.sides.length!=this.sides.length)throw"target cag needs same sides count as start cag";var i=e.cag||this,s=t.getTransformationTo(r,!1,0),a=t.getTransformationTo(o,!1,0),l=this._toVector3DPairs(s),u=i._toVector3DPairs(a),h=[];return l.forEach(function(e,t){h.push(new n.Polygon([new n.Vertex(u[t][1]),new n.Vertex(u[t][0]),new n.Vertex(e[0])])),h.push(new n.Polygon([new n.Vertex(u[t][1]),new n.Vertex(e[0]),new n.Vertex(e[1])]))}),h},union:function(e){var t;t=e instanceof Array?e:[e];var n=(n=this._toCSGWall(-1,1)).union(t.map(function(e){return e._toCSGWall(-1,1).reTesselated()}),!1,!1);return o.fromFakeCSG(n).canonicalized()},subtract:function(e){var t;t=e instanceof Array?e:[e];var n=this._toCSGWall(-1,1);return t.map(function(e){n=n.subtractSub(e._toCSGWall(-1,1),!1,!1)}),n=(n=n.reTesselated()).canonicalized(),n=(n=o.fromFakeCSG(n)).canonicalized()},intersect:function(e){var t;t=e instanceof Array?e:[e];var n=this._toCSGWall(-1,1);return t.map(function(e){n=n.intersectSub(e._toCSGWall(-1,1),!1,!1)}),n=(n=n.reTesselated()).canonicalized(),n=(n=o.fromFakeCSG(n)).canonicalized()},transform:function(e){var t=e.isMirroring(),n=this.sides.map(function(t){return t.transform(e)}),r=o.fromSides(n);return t&&(r=r.flipped()),r},taper:function(e,t){t<=0&&(t=1e-4);var r=this.getBounds(),i=0,s=0;e[0]?(i=r[1].x-r[0].x,s=r[0].x):(i=r[1].y-r[0].y,s=r[0].y);for(var a=[],l=[],u=0;u<this.sides.length;u++){var h=this.sides[u];e[0]&&(l[0]=[h.vertex0.pos.x,h.vertex0.pos.y*(1+(t-1)*(h.vertex0.pos.x-s)/i)],l[1]=[h.vertex1.pos.x,h.vertex1.pos.y*(1+(t-1)*(h.vertex1.pos.x-s)/i)]),e[1]&&(l[0]=[h.vertex0.pos.x*(1+(t-1)*(h.vertex0.pos.y-s)/i),h.vertex0.pos.y],l[1]=[h.vertex1.pos.x*(1+(t-1)*(h.vertex1.pos.y-s)/i),h.vertex1.pos.y]);var c=new o.Side(new o.Vertex(new n.Vector2D(l[0])),new o.Vertex(new n.Vector2D(l[1])));a.push(c)}return o.fromSides(a)},area:function(){var e=0;return this.sides.map(function(t){e+=t.vertex0.pos.cross(t.vertex1.pos)}),e*=.5},flipped:function(){var e=this.sides.map(function(e){return e.flipped()});return e.reverse(),o.fromSides(e)},getBounds:function(){var e,t=e=0===this.sides.length?new n.Vector2D(0,0):this.sides[0].vertex0.pos;return this.sides.map(function(n){e=(e=e.min(n.vertex0.pos)).min(n.vertex1.pos),t=(t=t.max(n.vertex0.pos)).max(n.vertex1.pos)}),[e,t]},isSelfIntersecting:function(e){for(var t=this.sides.length,n=0;n<t;n++)for(var r=this.sides[n],i=n+1;i<t;i++){var s=this.sides[i];if(o.linesIntersect(r.vertex0.pos,r.vertex1.pos,s.vertex0.pos,s.vertex1.pos))return e&&(OpenJsCad.log(r),OpenJsCad.log(s)),!0}return!1},expandedShell:function(e,t){(t=t||8)<4&&(t=4);var r=[],i={},s=this.canonicalized();for(var a in s.sides.map(function(t){var n=t.vertex1.pos.minus(t.vertex0.pos),s=n.length();if(s>1e-5){var a=(n=n.times(1/s)).normal().times(e),l=[t.vertex1.pos.plus(a),t.vertex1.pos.minus(a),t.vertex0.pos.minus(a),t.vertex0.pos.plus(a)],u=o.fromPoints(l);r.push(u);for(var h=0;h<2;h++){var c=0===h?t.vertex0.pos:t.vertex1.pos,p=0===h?t.vertex1.pos:t.vertex0.pos,f=c.x+" "+c.y;f in i||(i[f]=[]),i[f].push({p1:c,p2:p})}}}),i){var l,u,h=i[a],c=h[0].p1;if(2==h.length){var p=h[0].p2,f=h[1].p2;if(l=p.minus(c).angleDegrees(),(u=f.minus(c).angleDegrees())<l&&(u+=360),u>=l+360&&(u-=360),u<l+180){var v=u;u=l+360,l=v}l+=90,u-=90}else l=0,u=360;var d=u>l+359.999;if(d&&(l=0,u=360),u>l+1e-5){var g=[];d||g.push(c);var m=Math.round(t*(u-l)/360);m<1&&(m=1);for(var x=0;x<=m;x++){var y=l+x/m*(u-l);x==m&&(y=u);var _=c.plus(n.Vector2D.fromAngleDegrees(y).times(e));(!d||x>0)&&g.push(_)}var w=o.fromPointsNoCheck(g);r.push(w)}}var P=new o;return P=P.union(r)},expand:function(e,t){return this.union(this.expandedShell(e,t))},contract:function(e,t){return this.subtract(this.expandedShell(e,t))},extrudeInOrthonormalBasis:function(e,t){if(!(e instanceof n.OrthoNormalBasis))throw new Error("extrudeInPlane: the first parameter should be a CSG.OrthoNormalBasis");var r=this.extrude({offset:[0,0,t]}),o=e.getInverseProjectionMatrix();return r=r.transform(o)},extrudeInPlane:function(e,t,r){return this.extrudeInOrthonormalBasis(n.OrthoNormalBasis.GetCartesian(e,t),r)},extrude:function(e){if(0==this.sides.length)return new n;var t=n.parseOptionAs3DVector(e,"offset",[0,0,1]),r=n.parseOptionAsFloat(e,"twistangle",0),o=n.parseOptionAsInt(e,"twiststeps",n.defaultResolution3D),i=n.parseOptionAs2DVector(e,"scale",[1,1]),s=i.x,a=i.y;if(s<1e-4&&(s=1e-4),a<1e-4&&(a=1e-4),0==t.z)throw"offset cannot be orthogonal to Z axis";(0==r||o<1)&&(o=1);var l=n.Vector3D.Create(0,1,0),u=[];u=(u=u.concat(this._toPlanePolygons({translation:[0,0,0],normalVector:l,flipped:!(t.z<0)}))).concat(this._toPlanePolygons({translation:t,normalVector:l.rZ(r),flipped:t.z<0}));for(var h=0;h<o;h++){var c=new n.Connector(t.times(h/o),[0,0,t.z],l.rZ(h*r/o)),p=new n.Connector(t.times((h+1)/o),[0,0,t.z],l.rZ((h+1)*r/o));u=u.concat(this._toWallPolygons({toConnector1:c,toConnector2:p}))}var f=[],v=[];for(h=0;h<u.length;h++){v=[];for(var d=0;d<u[h].vertices.length;d++){var g=u[h].vertices[d].pos.z,m=u[h].vertices[d].pos._x*(1+(s-1)*g/t.z),x=u[h].vertices[d].pos._y*(1+(a-1)*g/t.z);v[d]=[m,x,g]}f[h]=new n.Polygon.cFP(v),f[h].shared=u[h].shared}return n.fromPolygons(f)},rotateExtrude:function(e){var t=n.parseOptionAsFloat(e,"angle",360),r=n.parseOptionAsInt(e,"resolution",n.defaultResolution3D);t=t>360?t%360:t;var o=[0,0,0],i=n.Vector3D.Create(0,1,0),s=[0,0,1],a=[],l=new n.Connector(o,i,s);if(t>0&&t<360){var u=new n.Connector(o,i.rZ(-t),s);a=(a=a.concat(this._toPlanePolygons({toConnector:l,flipped:!0}))).concat(this._toPlanePolygons({toConnector:u}))}for(var h,c=l,p=t/r,f=p;f<=t+1e-5;f+=p)h=new n.Connector(o,i.rZ(-f),s),a=a.concat(this._toWallPolygons({toConnector1:c,toConnector2:h})),c=h;return n.fromPolygons(a).reTesselated()},rotate_extrude:function(e){if(0==this.sides.length)return new n;var t=n.parseOptionAsInt(e,"faces",10),r=n.parseOptionAsInt(e,"twist",0),i=Math.abs(n.parseOptionAsInt(e,"radius",0)),s=n.parseOptionAsInt(e,"tsteps",0);t<3&&(t=3);var a=Math.ceil(s/t);a<1&&(a=1);var l=o.fromPoints([[-.001,1e5],[2e5,1e5],[2e5,-1e5],[-.001,-1e5]]),u=o.fromPoints([[.001,1e5],[-2e5,1e5],[-2e5,-1e5],[.001,-1e5]]),h=this.tr([i,0,0]),c=h.subtract(l),p=h.subtract(u);if(0!=c.sides.length)var f=c.mirroredX().union(p);else f=p;f=f.tr([-i,0,0]);for(var v=[],d=0;d<t+2;d++)y=new n.Matrix4x4.rotationZ(r/360*d/t*360),v[d]=f.transform(y),v[d]=v[d].tr([i,0,0]),v[d]=v[d].canonicalized();f=f.tr([i,0,0]);var g=[];for(d=0;d<t;d++)for(var m=0;m<f.sides.length;m++){var x,y,_=[],w=[];x=new n.Matrix4x4.rotationZ(d/t*360),y=new n.Matrix4x4.rotationZ((d+1)/t*360),_[0]=new n.Vector3D(v[d].sides[m].vertex0.pos.x,0,v[d].sides[m].vertex0.pos.y),_[1]=new n.Vector3D(v[d].sides[m].vertex1.pos.x,0,v[d].sides[m].vertex1.pos.y),_[2]=new n.Vector3D(v[d+1].sides[m].vertex1.pos.x,0,v[d+1].sides[m].vertex1.pos.y),_[3]=new n.Vector3D(v[d+1].sides[m].vertex0.pos.x,0,v[d+1].sides[m].vertex0.pos.y),_[0]=x.rightMultiply1x3Vector(_[0]),_[1]=x.rightMultiply1x3Vector(_[1]),_[2]=y.rightMultiply1x3Vector(_[2]),_[3]=y.rightMultiply1x3Vector(_[3]);for(var P=(_[3]._x-_[0]._x)/a,V=(_[3]._y-_[0]._y)/a,z=(_[3]._z-_[0]._z)/a,D=(_[2]._x-_[1]._x)/a,C=(_[2]._y-_[1]._y)/a,M=(_[2]._z-_[1]._z)/a,b=0;b<a;b++){w[0]=new n.Vector3D(_[0]._x+b*P,_[0]._y+b*V,_[0]._z+b*z),w[1]=new n.Vector3D(_[1]._x+b*D,_[1]._y+b*C,_[1]._z+b*M),w[2]=new n.Vector3D(_[1]._x+(b+1)*D,_[1]._y+(b+1)*C,_[1]._z+(b+1)*M),w[3]=new n.Vector3D(_[0]._x+(b+1)*P,_[0]._y+(b+1)*V,_[0]._z+(b+1)*z);var T=new n.Polygon([new n.Vertex(w[0]),new n.Vertex(w[1]),new n.Vertex(w[2])]),F=new n.Polygon([new n.Vertex(w[0]),new n.Vertex(w[2]),new n.Vertex(w[3])]);g.push(T),g.push(F)}}var S=n.fromPolygons(g);return S=(S=S.reTesselated()).canonicalized()},hull:function(e){o.ConvexHullPoint=function(e,t,n){this.index=e,this.angle=t,this.distance=n,this.compare=function(e){return this.angle<e.angle?-1:this.angle>e.angle?1:this.distance<e.distance?-1:this.distance>e.distance?1:0}},o.ConvexHull=function(){this.points=null,this.indices=null,this.getIndices=function(){return this.indices},this.clear=function(){this.indices=null,this.points=null},this.ccw=function(e,t,n){var r=(this.points[t].x-this.points[e].x)*(this.points[n].y-this.points[e].y)-(this.points[t].y-this.points[e].y)*(this.points[n].x-this.points[e].x);return r<1e-5?0:r},this.angle=function(e,t){return Math.atan2(this.points[t].y-this.points[e].y,this.points[t].x-this.points[e].x)},this.distance=function(e,t){return(this.points[t].x-this.points[e].x)*(this.points[t].x-this.points[e].x)+(this.points[t].y-this.points[e].y)*(this.points[t].y-this.points[e].y)},this.compute=function(e){if(this.indices=null,!(e.length<3)){this.points=e;for(var t=0,n=1;n<this.points.length;n++)this.points[n].y==this.points[t].y?this.points[n].x<this.points[t].x&&(t=n):this.points[n].y<this.points[t].y&&(t=n);var r=new Array,i=0,s=0;for(n=0;n<this.points.length;n++)n!=t&&((i=this.angle(t,n))<0&&(i+=Math.PI),s=this.distance(t,n),r.push(new o.ConvexHullPoint(n,i,s)));r.sort(function(e,t){return e.compare(t)});var a,l=new Array(this.points.length+1),u=2;for(n=0;n<this.points.length;n++)n!=t&&(l[u]=r[u-2].index,u++);l[0]=l[this.points.length],l[1]=t;var h=2;for(n=3;n<=this.points.length;n++){for(;this.ccw(l[h-1],l[h],l[n])<=0;)h--;h++,a=l[n],l[n]=l[h],l[h]=a}for(this.indices=new Array(h),n=0;n<h;n++)this.indices[n]=l[n+1]}}};var t=e,n=[];n.push(this);for(var r=0;r<t.length;r++)n.push(t[r]);var i=[],s=[];for(r=0;r<n.length;r++){if(!((e=n[r])instanceof o))throw"ERROR: don't mix 2D and 3D shapes in hull";for(var a=0;a<e.sides.length;a++){var l=e.sides[a].vertex0.pos.x,u=e.sides[a].vertex0.pos.y;s[l+","+u]||(i.push({x:l,y:u}),s[l+","+u]++)}}var h=new o.ConvexHull;h.compute(i);var c=h.getIndices();if(c&&c.length>0){var p=[];for(r=0;r<c.length;r++)p.push(i[c[r]]);return o.fromPoints(p)}},check:function(){var e=[];this.isSelfIntersecting(!0)&&e.push("Self intersects");var t={};for(var n in this.sides.map(function(e){function n(e){var n=e.x+" "+e.y;n in t||(t[n]=0),t[n]++}n(e.vertex0.pos),n(e.vertex1.pos)}),t){var r=t[n];1&r&&e.push("Uneven number of sides ("+r+") for point "+n)}var o=this.area();if(o<1e-5*1e-5&&e.push("Area is "+o),e.length>0){var i="";throw e.map(function(e){i+=e+"\n"}),new Error(i)}},canonicalized:function(){if(this.isCanonicalized)return this;var e=(new o.fuzzyCAGFactory).getCAG(this);return e.isCanonicalized=!0,e},toCompactBinary:function(){var e=this.canonicalized(),t=e.sides.length,n={},r=[],o=0,i=new Uint32Array(2*t),s=0;e.sides.map(function(e){[e.vertex0,e.vertex1].map(function(e){var t,a=e.getTag();a in n?t=n[a]:(t=o++,n[a]=t,r.push(e)),i[s++]=t})});var a=new Float64Array(2*o),l=0;return r.map(function(e){var t=e.pos;a[l++]=t._x,a[l++]=t._y}),{class:"CAG",sideVertexIndices:i,vertexData:a}},getOutlinePaths:function(){var e=this.canonicalized(),t={},r={};e.sides.map(function(e){var n=e.getTag();t[n]=e;var o=e.vertex0.getTag();o in r||(r[o]=[]),r[o].push(n)});for(var o=[];;){var i=null;for(var s in r){var a=r[s];i=a[0],a.splice(0,1),0===a.length&&delete r[s];break}if(null===i)break;for(var l=[],u=t[i],h=u.vertex0.getTag();;){l.push(u.vertex0.pos);var c=u.vertex1.getTag();if(c==h)break;if(!(c in r))throw new Error("Area is not closed!");var p=r[c],f=-1;if(1==p.length)f=0;else for(var v=null,d=u.direction().angleDegrees(),g=0;g<p.length;g++){var m=p[g],x=t[m].direction().angleDegrees()-d;x<-180&&(x+=360),x>=180&&(x-=360),(f<0||x>v)&&(f=g,v=x)}var y=p[f];p.splice(f,1),0===p.length&&delete r[c],u=t[y]}var _=new n.Path2D(l,!0);o.push(_)}return o},overCutInsideCorners:function(e){var t=this.canonicalized(),r={};t.sides.map(function(e){e.vertex0.getTag()in r||(r[e.vertex0.getTag()]={pos:e.vertex0.pos,from:[],to:[]}),r[e.vertex0.getTag()].to.push(e.vertex1.pos),e.vertex1.getTag()in r||(r[e.vertex1.getTag()]={pos:e.vertex1.pos,from:[],to:[]}),r[e.vertex1.getTag()].from.push(e.vertex0.pos)});var i=[];for(var s in r){var a=r[s];if(1==a.from.length&&1==a.to.length){var l=a.from[0],u=a.pos,h=a.to[0],c=u.minus(l).unit(),p=h.minus(u).unit();if(c.cross(p)<.001){var f=p.angleRadians()-c.angleRadians()+Math.PI;f<0?f+=2*Math.PI:f>=2*Math.PI&&(f-=2*Math.PI);for(var v=p.minus(c).unit(),d=30/180*Math.PI,g=e/Math.cos(d/2),m=u.plus(v.times(g)),x=f+v.angleRadians(),y=2*(Math.PI-f),_=2*Math.ceil(y/d/2),w=[m],P=0;P<=_;P++){var V=x+P/_*y,z=n.Vector2D.fromAngleRadians(V).times(g).plus(m);w.push(z)}i.push(o.fromPoints(w))}}}return t.subtract(i)}},o.Vertex=function(e){this.pos=e},o.Vertex.prototype={toString:function(){return"("+this.pos.x.toFixed(2)+","+this.pos.y.toFixed(2)+")"},getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e}},o.Side=function(e,t){if(!(e instanceof o.Vertex))throw new Error("Assertion failed");if(!(t instanceof o.Vertex))throw new Error("Assertion failed");this.vertex0=e,this.vertex1=t},o.Side._fromFakePolygon=function(e){if(e.vertices.forEach(function(e){if(!(e.pos.z>=-1.001&&e.pos.z<-.999||e.pos.z>=.999&&e.pos.z<1.001))throw"Assertion failed: _fromFakePolygon expects abs z values of 1"}),e.vertices.length<4)return null;var t=[],r=e.vertices.filter(function(e,n){if(e.pos.z>0)return t.push(n),!0}).map(function(e){return new n.Vector2D(e.pos.x,e.pos.y)});if(2!=r.length)throw"Assertion failed: _fromFakePolygon: not enough points found";var i=t[1]-t[0];if(1!=i&&3!=i)throw"Assertion failed: _fromFakePolygon: unknown index ordering";return 1==i&&r.reverse(),new o.Side(new o.Vertex(r[0]),new o.Vertex(r[1]))},o.Side.prototype={toString:function(){return this.vertex0+" -> "+this.vertex1},toPolygon3D:function(e,t){var r=[new n.Vertex(this.vertex0.pos.toVector3D(e)),new n.Vertex(this.vertex1.pos.toVector3D(e)),new n.Vertex(this.vertex1.pos.toVector3D(t)),new n.Vertex(this.vertex0.pos.toVector3D(t))];return new n.Polygon(r)},transform:function(e){var t=this.vertex0.pos.transform(e),n=this.vertex1.pos.transform(e);return new o.Side(new o.Vertex(t),new o.Vertex(n))},flipped:function(){return new o.Side(this.vertex1,this.vertex0)},direction:function(){return this.vertex1.pos.minus(this.vertex0.pos)},getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e},lengthSquared:function(){var e=this.vertex1.pos.x-this.vertex0.pos.x,t=this.vertex1.pos.y-this.vertex0.pos.y;return e*e+t*t},length:function(){return Math.sqrt(this.lengthSquared())}},o.fuzzyCAGFactory=function(){this.vertexfactory=new n.fuzzyFactory(2,1e-5)},o.fuzzyCAGFactory.prototype={getVertex:function(e){var t=[e.pos._x,e.pos._y];return this.vertexfactory.lookupOrCreate(t,function(t){return e})},getSide:function(e){var t=this.getVertex(e.vertex0),n=this.getVertex(e.vertex1);return new o.Side(t,n)},getCAG:function(e){var t=this,n=e.sides.map(function(e){return t.getSide(e)}).filter(function(e){return e.length()>1e-5});return o.fromSides(n)}},n.findLink=function(e,t,r){console.log("looping to find next link in chain");e.u;var o=e.v;if(o in t)for(var i=0;i<t[o].length;i++){var s=t[o][i],a=new n.Vector3D(e.u._x-e.v._x,e.u._y-e.v._y,e.u._z-e.v._z),l=new n.Vector3D(s.u._x-s.v._x,s.u._y-s.v._y,s.u._z-s.v._z),u=a.cross(l);if(Math.abs(u._x)<.001&&Math.abs(u._y)<.001&&Math.abs(u._z)<.001)return s}return null},n.isOn=function(e,t,r,o){return n.within(e,t,r)&&n.collinear(e,t,r,o)},n.fixUnpairedEdges=function(e,t,r,o,i,s,a,l){for(var u=!0,h=0,c=0;c<t.length+1&&(u?h=0:++h<100?c--:(console.log("I'm stopping working on this side.  I think it is busted."),h=0,u=!0),c!=t.length);c++){var p=t[c];if(!(s[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]].length>0)){var f=!1;[p.u._x,p.u._y,p.u._z]in i||(console.log("had to add a point to endsWith"),i[[p.u._x,p.u._y,p.u._z]]=[]);for(var v=0;v<i[[p.u._x,p.u._y,p.u._z]].length;v++){if([(V=i[[p.u._x,p.u._y,p.u._z]][v]).u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]in s||(console.log("had to add an edge to fixedEdges"),s[[V.u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]]=[]),!(s[[V.u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]]&&s[[V.u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]].length>0)&&(n.diffPoints(p.u,V.u)||n.diffPoints(p.v,V.v)))if(n.diffPoints(p.u,V.v)||n.diffPoints(p.v,V.u)){var d=new n.Vector3D(p.u._x-p.v._x,p.u._y-p.v._y,p.u._z-p.v._z),g=new n.Vector3D(V.u._x-V.v._x,V.u._y-V.v._y,V.u._z-V.v._z),m=d.cross(g);if(Math.abs(m._x)<1e-5&&Math.abs(m._y)<1e-5&&Math.abs(m._z)<1e-5&&n.diffPoints(p.u,V.u)&&n.diffPoints(p.v,V.u)&&n.isOn(p.u,p.v,V.u,1e-4))for(var x=e[p.face].vertices,y=0;y<x.length;y++)if(x[y].pos._x==p.u._x&&x[y].pos._y==p.u._y&&x[y].pos._z==p.u._z){var _=new n.Vector3D(V.u.x,V.u.y,V.u.z),w=new n.Vertex(_);if(f=!0,x.splice(y+1,0,w),f){if(s[[V.u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]].push(V),a++,r[[p.v._x,p.v._y,p.v._z,V.u._x,V.u._y,V.u._z]]){var P=r[[p.v._x,p.v._y,p.v._z,V.u._x,V.u._y,V.u._z]][0];s[[p.v._x,p.v._y,p.v._z,V.u._x,V.u._y,V.u._z]].push(P),s[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]].push(V),a+=2,u=!0}else p.u=V.u,r[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]]=[p],s[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]]=[],[p.u._x,p.u._y,p.u._z]in o||(o[[p.u._x,p.u._y,p.u._z]]=[]),[p.u._x,p.u._y,p.u._z]in i||(i[[p.u._x,p.u._y,p.u._z]]=[]),o[[p.u._x,p.u._y,p.u._z]].push(p),i[[p.v._x,p.v._y,p.v._z]].push(p),u=!1;break}}}else s[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]].push(p),s[[V.u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]].push(V),a+=2}if(!f)for(v=0;v<o[[p.v._x,p.v._y,p.v._z]].length;v++){var V;if(!(s[[(V=o[[p.v._x,p.v._y,p.v._z]][v]).u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]].length>0)&&(n.diffPoints(p.u,V.u)||n.diffPoints(p.v,V.v)))if(n.diffPoints(p.u,V.v)||n.diffPoints(p.v,V.u)){d=new n.Vector3D(p.u._x-p.v._x,p.u._y-p.v._y,p.u._z-p.v._z),g=new n.Vector3D(V.u._x-V.v._x,V.u._y-V.v._y,V.u._z-V.v._z),m=d.cross(g);if(Math.abs(m._x)<1e-5&&Math.abs(m._y)<1e-5&&Math.abs(m._z)<1e-5&&n.diffPoints(p.u,V.v)&&n.diffPoints(p.v,V.v)&&n.isOn(p.u,p.v,V.v,1e-4))for(x=e[p.face].vertices,y=0;y<x.length;y++)if(x[y].pos._x==p.u._x&&x[y].pos._y==p.u._y&&x[y].pos._z==p.u._z){_=new n.Vector3D(V.v.x,V.v.y,V.v.z),w=new n.Vertex(_);if(f=!0,x.splice(y+1,0,w),s[[V.u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]].push(V),a++,r[[V.v._x,V.v._y,V.v._z,p.u._x,p.u._y,p.u._z]]){if(r[[V.v._x,V.v._y,V.v._z,p.u._x,p.u._y,p.u._z]].length>1)P=r[[V.v._x,V.v._y,V.v._z,p.u._x,p.u._y,p.u._z]][0];s[[V.v._x,V.v._y,V.v._z,p.u._x,p.u._y,p.u._z]].push(P),s[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]].push(V),a+=2,u=!0}else p.v=V.v,r[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]]=[p],s[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]]=[],[p.v._x,p.v._y,p.v._z]in i||(i[[p.v._x,p.v._y,p.v._z]]=[]),i[[p.v._x,p.v._y,p.v._z]].push(p),o[[p.u._x,p.u._y,p.u._z]].push(p),u=!1;break}}else s[[p.u._x,p.u._y,p.u._z,p.v._x,p.v._y,p.v._z]].push(p),s[[V.u._x,V.u._y,V.u._z,V.v._x,V.v._y,V.v._z]].push(V),a+=2}u||f||(u=!0)}}return a},n.collinear=function(e,t,r,o){var i=new n.Vector3D(e._x-t._x,e._y-t._y,e._z-t._z),s=new n.Vector3D(t._x-r._x,t._y-r._y,t._z-r._z);r=i.cross(s);return Math.abs(r._x)<o&&Math.abs(r._y)<o&&Math.abs(r._z)<o},n.within=function(e,t,n){return e.x!=t.x?e.x>=n.x&&n.x>=t.x||e.x<=n.x&&n.x<=t.x:e.y!=t.y?e.y>=n.y&&n.y>=t.y||e.y<=n.y&&n.y<=t.y:e.z!=t.z?e.z>=n.z&&n.z>=t.z||e.z<=n.z&&n.z<=t.z:void 0},n.diffPoints=function(e,t){return Math.abs(e._x-t._x)>1e-8||(Math.abs(e._y-t._y)>1e-8||Math.abs(e._z-t._z)>1e-8)},n.addTransformationMethodsToPrototype(n.prototype),n.addTransformationMethodsToPrototype(n.Vector2D.prototype),n.addTransformationMethodsToPrototype(n.Vector3D.prototype),n.addTransformationMethodsToPrototype(n.Vertex.prototype),n.addTransformationMethodsToPrototype(n.Plane.prototype),n.addTransformationMethodsToPrototype(n.Polygon.prototype),n.addTransformationMethodsToPrototype(n.Line3D.prototype),n.addTransformationMethodsToPrototype(n.Connector.prototype),n.addTransformationMethodsToPrototype(n.Path2D.prototype),n.addTransformationMethodsToPrototype(n.Line2D.prototype),n.addTransformationMethodsToPrototype(o.prototype),n.addTransformationMethodsToPrototype(o.Side.prototype),n.addTransformationMethodsToPrototype(n.OrthoNormalBasis.prototype),n.addCenteringToPrototype(n.prototype,["x","y","z"]),n.addCenteringToPrototype(o.prototype,["x","y"]),n.Polygon2D=function(e){var t=o.fromPoints(e);this.sides=t.sides},n.Polygon2D.prototype=o.prototype,e.CSG=n,e.CAG=o}(this);