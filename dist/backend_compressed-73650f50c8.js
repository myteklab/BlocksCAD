"use strict";var Blockscad=Blockscad||{};Blockscad.Auth=Blockscad.Auth||{},Blockscad.Toolbox=Blockscad.Toolbox||{};var BSUtils=BSUtils||{},Blockly=Blockly||{},BlocklyStorage=BlocklyStorage||{};function searchTable(t){$("#projTable tr").each(function(e,o){if(e>0){var s=!1;$(o).find(".sb").each(function(e,o){if(new RegExp(t,"i").test($(o).text()))return s=!0,!1}),1==s?$(o).removeClass("hidden"):$(o).addClass("hidden")}})}function pad(t,e){for(var o=""+t;o.length<e;)o="0"+o;return o}function timeSince(t,e){var o=Math.floor((new Date-t)/1e3)+e,s=Math.floor(o/31536e3),c=new Date(t),a=c.getDay(),l=["January","February","March","April","May","June","July","August","September","October","November","December"][c.getMonth()],n=c.getFullYear();return(s=Math.floor(o/2592e3))>1?l+" "+a+", "+n:(s=Math.floor(o/86400))>1?Blockscad.Msg.LAST_MODIFIED_DAYS.replace("%1",s):(s=Math.floor(o/3600))>1?Blockscad.Msg.LAST_MODIFIED_HOURS.replace("%1",s):((s=Math.floor(o/60))<0&&(s=0),Blockscad.Msg.LAST_MODIFIED_MINUTES.replace("%1",s))}function dataURLtoBlob(t){for(var e=t.split(","),o=e[0].match(/:(.*?);/)[1],s=atob(e[1]),c=s.length,a=new Uint8Array(c);c--;)a[c]=s.charCodeAt(c);return new Blob([a],{type:o})}function createCookie(t,e,o){var s="";if(o){var c=new Date;c.setTime(c.getTime()+24*o*60*60*1e3),s="; expires="+c.toUTCString()}document.cookie=t+"="+e+s+"; path=/"}function readCookie(t){for(var e=t+"=",o=document.cookie.split(";"),s=0;s<o.length;s++){for(var c=o[s];" "==c.charAt(0);)c=c.substring(1,c.length);if(0==c.indexOf(e))return c.substring(e.length,c.length)}return null}function md5cycle(t,e){var o=t[0],s=t[1],c=t[2],a=t[3];o=ff(o,s,c,a,e[0],7,-680876936),a=ff(a,o,s,c,e[1],12,-389564586),c=ff(c,a,o,s,e[2],17,606105819),s=ff(s,c,a,o,e[3],22,-1044525330),o=ff(o,s,c,a,e[4],7,-176418897),a=ff(a,o,s,c,e[5],12,1200080426),c=ff(c,a,o,s,e[6],17,-1473231341),s=ff(s,c,a,o,e[7],22,-45705983),o=ff(o,s,c,a,e[8],7,1770035416),a=ff(a,o,s,c,e[9],12,-1958414417),c=ff(c,a,o,s,e[10],17,-42063),s=ff(s,c,a,o,e[11],22,-1990404162),o=ff(o,s,c,a,e[12],7,1804603682),a=ff(a,o,s,c,e[13],12,-40341101),c=ff(c,a,o,s,e[14],17,-1502002290),o=gg(o,s=ff(s,c,a,o,e[15],22,1236535329),c,a,e[1],5,-165796510),a=gg(a,o,s,c,e[6],9,-1069501632),c=gg(c,a,o,s,e[11],14,643717713),s=gg(s,c,a,o,e[0],20,-373897302),o=gg(o,s,c,a,e[5],5,-701558691),a=gg(a,o,s,c,e[10],9,38016083),c=gg(c,a,o,s,e[15],14,-660478335),s=gg(s,c,a,o,e[4],20,-405537848),o=gg(o,s,c,a,e[9],5,568446438),a=gg(a,o,s,c,e[14],9,-1019803690),c=gg(c,a,o,s,e[3],14,-187363961),s=gg(s,c,a,o,e[8],20,1163531501),o=gg(o,s,c,a,e[13],5,-1444681467),a=gg(a,o,s,c,e[2],9,-51403784),c=gg(c,a,o,s,e[7],14,1735328473),o=hh(o,s=gg(s,c,a,o,e[12],20,-1926607734),c,a,e[5],4,-378558),a=hh(a,o,s,c,e[8],11,-2022574463),c=hh(c,a,o,s,e[11],16,1839030562),s=hh(s,c,a,o,e[14],23,-35309556),o=hh(o,s,c,a,e[1],4,-1530992060),a=hh(a,o,s,c,e[4],11,1272893353),c=hh(c,a,o,s,e[7],16,-155497632),s=hh(s,c,a,o,e[10],23,-1094730640),o=hh(o,s,c,a,e[13],4,681279174),a=hh(a,o,s,c,e[0],11,-358537222),c=hh(c,a,o,s,e[3],16,-722521979),s=hh(s,c,a,o,e[6],23,76029189),o=hh(o,s,c,a,e[9],4,-640364487),a=hh(a,o,s,c,e[12],11,-421815835),c=hh(c,a,o,s,e[15],16,530742520),o=ii(o,s=hh(s,c,a,o,e[2],23,-995338651),c,a,e[0],6,-198630844),a=ii(a,o,s,c,e[7],10,1126891415),c=ii(c,a,o,s,e[14],15,-1416354905),s=ii(s,c,a,o,e[5],21,-57434055),o=ii(o,s,c,a,e[12],6,1700485571),a=ii(a,o,s,c,e[3],10,-1894986606),c=ii(c,a,o,s,e[10],15,-1051523),s=ii(s,c,a,o,e[1],21,-2054922799),o=ii(o,s,c,a,e[8],6,1873313359),a=ii(a,o,s,c,e[15],10,-30611744),c=ii(c,a,o,s,e[6],15,-1560198380),s=ii(s,c,a,o,e[13],21,1309151649),o=ii(o,s,c,a,e[4],6,-145523070),a=ii(a,o,s,c,e[11],10,-1120210379),c=ii(c,a,o,s,e[2],15,718787259),s=ii(s,c,a,o,e[9],21,-343485551),t[0]=add32(o,t[0]),t[1]=add32(s,t[1]),t[2]=add32(c,t[2]),t[3]=add32(a,t[3])}function cmn(t,e,o,s,c,a){return e=add32(add32(e,t),add32(s,a)),add32(e<<c|e>>>32-c,o)}function ff(t,e,o,s,c,a,l){return cmn(e&o|~e&s,t,e,c,a,l)}function gg(t,e,o,s,c,a,l){return cmn(e&s|o&~s,t,e,c,a,l)}function hh(t,e,o,s,c,a,l){return cmn(e^o^s,t,e,c,a,l)}function ii(t,e,o,s,c,a,l){return cmn(o^(e|~s),t,e,c,a,l)}function md51(t){var e,o=t.length,s=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)md5cycle(s,md5blk(t.substring(e-64,e)));t=t.substring(e-64);var c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)c[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(c[e>>2]|=128<<(e%4<<3),e>55)for(md5cycle(s,c),e=0;e<16;e++)c[e]=0;return c[14]=8*o,md5cycle(s,c),s}function md5blk(t){var e,o=[];for(e=0;e<64;e+=4)o[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return o}Blockscad.Auth.serverURL="https://api.blockscad3d.com",Blockscad.Auth.getUserURL=Blockscad.Auth.serverURL+"/users/me.json",Blockscad.Auth.loginURL=Blockscad.Auth.serverURL+"/users/auth.json",Blockscad.Auth.registerURL=Blockscad.Auth.serverURL+"/users.json",Blockscad.Auth.usernameCheckURL=Blockscad.Auth.serverURL+"/users/exists.json",Blockscad.Auth.createProjectURL=Blockscad.Auth.serverURL+"/projects.json",Blockscad.Auth.updateProjectURL=Blockscad.Auth.serverURL+"/projects/",Blockscad.Auth.listProjectURL=Blockscad.Auth.serverURL+"/projects.json",Blockscad.Auth.shareProjectURL=Blockscad.Auth.serverURL+"/projects/{project_id}/mark-public.json",Blockscad.Auth.unshareProjectURL=Blockscad.Auth.serverURL+"/projects/{project_id}/mark-private.json",Blockscad.Auth.tokenLoginURL=Blockscad.Auth.serverURL+"/users/tokenauth.json",Blockscad.Auth.myClassesUrl="edu/",Blockscad.Auth.adminDashURL="edu/admin",Blockscad.Auth.getProjectRefUrl=Blockscad.Auth.serverURL+"/projects/<pid>/ref.json",Blockscad.Auth.submitProjectUrl=Blockscad.Auth.serverURL+"/projects/<pid>/submit.json",Blockscad.Auth.addNotesProjectUrl=Blockscad.Auth.serverURL+"/projects/<pid>/add-notes.json",Blockscad.Auth.getAssignmentInstanceURL=Blockscad.Auth.serverURL+"/classrooms/cid/get_assignment_instance.json",Blockscad.Auth.getAssignmentByIdURL=Blockscad.Auth.serverURL+"/assignments/<aid>.json",Blockscad.Auth.signedRequestURL=Blockscad.Auth.serverURL+"/projects/<pid>/get_signed_url.json",Blockscad.Auth.updateStlURL=Blockscad.Auth.serverURL+"/projects/<pid>/update_stl_path.json",Blockscad.Auth.updateProjectTimeURL=Blockscad.Auth.serverURL+"/projects/<pid>/add_time.json",Blockscad.Auth.updateUserTimeURL=Blockscad.Auth.serverURL+"/users/me/add_time.json",Blockscad.Auth.getProjectLastSaveTimeURL=Blockscad.Auth.serverURL+"/projects/<pid>/last_save.json",Blockscad.Auth.redeemTRCouponURL=Blockscad.Auth.serverURL+"/users/access_code_plan.json",Blockscad.Auth.projectId=0,Blockscad.Auth.assignmentId=0,Blockscad.Auth.projectParent=0,Blockscad.Auth.isLoggedIn=0,Blockscad.Auth.uid=0,Blockscad.Auth.atok="",Blockscad.Auth.isLimited=!0,Blockscad.Auth.user="",Blockscad.Auth.teacher_edit=0,Blockscad.Auth.class_id=0,Blockscad.Auth.class_name="",Blockscad.Auth.example_solution=0,Blockscad.Auth.starting_blocks=0,Blockscad.Auth.init=function(){$.ajaxSetup({statusCode:{401:function(t){console.log("401: unauthorized user.  Running notLoggedIn().",t),Blockscad.Auth.notLoggedIn()},403:function(t){console.log("403: unauthorized user.  Running notLoggedIn().",t),Blockscad.Auth.notLoggedIn()}}}),Blockscad.Auth.fromPolar(),BSUtils.getStringParamFromUrl("teacheredit","").length&&(Blockscad.Auth.teacher_edit=!0);var t=location.hash.slice(1);if(t&&t.match(/^access_token=/)){history.replaceState({},"BlocksCAD","/editor/"),t=t.replace(/^access_token=/,""),Blockscad.Auth.thingiverseToken=t.replace(/^access_token=/,"");var e="";e+='<div id="tv-modal" class="modal fade" data-keyboard="false" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="upload-progress-modal" aria-hidden="true">\n',e+='  <div class="modal-dialog">\n',e+='    <div class="modal-content">\n',e+='          <div class="modal-header">\n',e+='            <h2 class="modal-title">'+Blockscad.Msg.UPLOADING+"</h2>\n",e+="          </div>\n",e+='          <div id="tv-message-body" class="modal-body">\n',e+='              <h3><img id=busy src="imgs/busy2.gif">&nbsp;&nbsp;'+Blockscad.Msg.BUILDING_STL_FOR_UPLOAD+" </h3>",e+="          </div>\n",e+='          <div id="tv-message-footer" class="modal-footer">\n',e+="              <h4>"+Blockscad.Msg.UPLOAD_REDIRECT.replace("%1","Thingiverse")+"</h4>",e+="          </div>\n",e+="  </div>\n",e+="</div>\n",$("body").append(e),$("#tv-modal").modal("show"),Blockscad.Auth.getUserInfo(),console.log("my blockscad database auth token is:",Blockscad.Auth.atok),Blockscad.Auth.tvLoadFromStorage(),Blockscad.Auth.uploadTVProjectNew()}t&&t.match("myprojects")&&window.setTimeout(function(){Blockscad.Auth.listProject(),history.replaceState({},"BlocksCAD","/editor/")},200);var o=window.location;Blockscad.Auth.baseUrl=o.protocol+"//"+o.host+"/",$("#login-area").on("click","#reg-button",function(){var t=Blockscad.Auth.baseUrl+"account/register?from=editor";/*removed register*/}),$("#accessModal").on("shown.bs.modal",function(t){$(".access-post").html(""),$(".access-school-site-title").hide(),$(".access-school-title").hide(),$(".grade-checkboxes").hide(),$(".prompt-account").hide(),$("#access-code-input").focus()}),$("#access-code-form").on("submit",function(t){t.preventDefault(),t.stopPropagation(),$(".access-post").html(""),$(".access-school-site-title").hide(),$(".access-school-title").hide(),$(".grade-checkboxes").hide(),$(".prompt-account").hide(),$("#access-code-input").val($("#access-code-input").val().replace(/\s+/g,""));var e=$("#access-code-form").serializeArray().reduce(function(t,e){return t[e.name]=e.value,t},{});e.code=e.code.toUpperCase(),$.ajax({url:Blockscad.Auth.serverURL+"/sites/sitecode.json?code="+e.code,type:"GET",success:function(t){var e=!1;t.expires&&(new Date(t.expires).getTime()<(new Date).getTime()&&(e=!0));if(e)$("#access-code-form .form-control").css("border","solid 2px #D0021B"),$(".access-error").html("Access code has expired");else{$(".access-post").html(""),$(".prompt-account").html(""),$(".access-school-site-title").html("<strong>"+t.district+"</strong"),$(".access-school-site-title").show(),$(".access-school-title").show();var o=t.schools;if(o&&(o=o.split(",")),o&&o.length&&o.length>1){o.sort(function(t,e){return t.toLowerCase().localeCompare(e.toLowerCase())});$('<input type="text" name="choose-school" id="school-select" list="schoollist" style="width:200px">').appendTo(".access-post");var s=$('<datalist id="schoollist" title="Your School">').appendTo(".access-post");$(o).each(function(){s.append($("<option>").attr("value",this).text(this))})}else o?($(".access-school-title").append(" <strong>"+t.schools+"</strong>"),$(".grade-checkboxes").show()):($(".access-school-title").hide(),$(".grade-checkboxes").show())}},error:function(t,e,o){404==t.status&&(console.log("invalid code"),$("#access-code-form .form-control").css("border","solid 2px #D0021B"),$(".access-error").html(Blockscad.Msg.INVALID_ACCESS_CODE))}})})},Blockscad.Auth.startAutosaveTimer=function(){Blockscad.Auth.teacher_edit||Blockscad.Auth.autosaveTimerId||(Blockscad.Auth.autosaveTimerId=setInterval(function(){Blockscad.needToSave&&BlocklyStorage.autoBackupBlocks()},3e4))},Blockscad.Auth.stopAutosaveTimer=function(){clearInterval(Blockscad.Auth.autosaveTimerId),Blockscad.Auth.autosaveTimerId=!1},Blockscad.Auth.downloadProjectFailed=function(t){console.log("failed to download project (from downloadProjectFailed):",t)},Blockscad.Auth.checkForProjectUpdate=function(t,e,o){return new Promise(function(s,c){var a="";Blockscad.Auth.teacher_edit&&Blockscad.Auth.class_id&&(a="?classroom_id="+Blockscad.Auth.class_id),$.ajax({type:"GET",url:Blockscad.Auth.getProjectLastSaveTimeURL.replace("<pid>",t)+a,timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){var c,a,l=moment(t.now);if(t.lastSaved?(c=moment(t.lastSaved),a=moment.duration(l.diff(c))):(c=null,a=moment.duration(2,"years")),a.asSeconds()+3<e.asSeconds()&&(Blockscad.Auth.downloadProject(Blockscad.Auth.projectId,0,0,Blockscad.Auth.class_id,!0,Blockscad.Auth.teacher_edit).catch(function(t){Blockscad.Auth.downloadProjectFailed(t)}),s("downloaded")),Blockscad.Auth.teacher_edit&&o&&c){var n=Math.round(a.asMinutes());n<0&&(n=0),n<10?bootbox.alert("Warning: this project was saved "+n+" minutes ago.  It is likely the student is editing it. Student saves will overwrite your changes - hold off on editing this project."):n<30&&bootbox.alert("This project was saved "+n+" minutes ago.  It is probably safe for you to edit it.  Save often.  Student saves made while you are editing will overwrite your changes.")}},fail:function(t){c(t)}})})},Blockscad.Auth.setPrintNotes=function(t,e){$.ajax({type:"GET",url:Blockscad.Auth.getProjectRefUrl.replace("<pid>",t),timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){e.val(t.submitNotes)},fail:function(t){}})},Blockscad.Auth.sendLogoutCommand=function(){Blockscad.clearProject(),Blockscad.Auth.atok="",Blockscad.Auth.uid=0,Blockscad.Auth.user="";(window.localStorage.removeItem("community-user"),createCookie("token","",-1),gapi&&gapi.auth2)&&gapi.auth2.getAuthInstance().signOut().then(function(){console.log("User signed out.")});return"Turkey"==Blockscad.Auth.cookie_country&&(Blockscad.Auth.inTurkeyPopup(),$("#tr-footer").show()),Blockscad.Auth.notLoggedIn(),!1},Blockscad.Auth.clearThingiverseToken=function(){if(Blockscad.Auth.thingiverseToken=null,Blockscad.Auth.tvpid=null,"localStorage"in window){var t=window.location.href.split("#")[0],e=(t=t.split("?")[0])+"tvpid";window.localStorage.removeItem(e);var o=t+"tvat";window.localStorage.removeItem(o)}},Blockscad.Auth.notLoggedIn=function(){Blockscad.Auth.isLoggedIn=0,Blockscad.Auth.projectId=0,Blockscad.Auth.assignmentId=0,Blockscad.Auth.assignmentDueDateString="",Blockscad.Auth.instructionsString="",Blockscad.Auth.thingiverseToken=null,Blockscad.Auth.tvpid=null,Blockscad.Auth.clearThingiverseToken(),$("#login-area").html('<div id="save-indicator" class="save-indicator"></div><div id="save-message" class="save-message"></div><button type="button" id="bigsavebutton" class="btn-default btn btn-lg" style="margin-top:2px;">'+Blockscad.Msg.SAVE_BUTTON+'</button><button type="button" id="reg-button" class="btn-default btn-big" >'+Blockscad.Msg.REGISTER_BUTTON+"</button>\n<button type='button' id='login-button' class='btn-default btn-big' data-toggle='modal' data-target='#login-user' >"+Blockscad.Msg.LOGIN_BUTTON+"</button>"),$("#file-menu").html('<li><a href="#" class="new-project">'+Blockscad.Msg.NEW+'</a></li>\n<li class="divider"></li>\n<li><a href="#" id="saveLocal">'+Blockscad.Msg.SAVE_BLOCKS_LOCAL+'</a></li>\n<li>\n<input type="file" accept=".xml" id="loadLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'loadLocal\').click(); return false">'+Blockscad.Msg.LOAD_BLOCKS_LOCAL+'</a>\n</li>\n<li class="divider"></li>\n<li>\n<input type="file" accept=".xml" id="importLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'importLocal\').click(); return false">'+Blockscad.Msg.IMPORT_BLOCKS_LOCAL+'</a>\n</li>\n<input type="file" accept=".stl" id="importStl" style="visibility: hidden; width: 1px; height: 1px" />\n<li class="divider"></li>\n<li><a href="#" id="saveOpenscad">'+Blockscad.Msg.SAVE_SCAD_LOCAL+"</a></li>\n"),Blockscad.Auth.unsetTeacherEdit(),Blockscad.Auth.unsetTeInfo(),console.log("resetting to adv toolbox"),Blockscad.Toolbox.catIDs=[],Blockscad.workspace.updateToolbox(Blockscad.Toolbox.adv),Blockscad.Toolbox.setCatColors()},Blockscad.Auth.setTercToolbox=function(){3!=Blockscad.Auth.user.site_id&&3!=Blockscad.Auth.user.site_student||(Blockscad.Toolbox.catIDs=[],Blockscad.workspace.updateToolbox(Blockscad.Toolbox.adv_w_triangles),Blockscad.Toolbox.setCatColors())},Blockscad.Auth.loggedIn=function(t){Blockscad.Auth.isLoggedIn=1,Blockscad.Auth.isLimited=t.isLimited||t.isEduLimited;var e="";e=t.display_name.length>2?t.display_name:t.username,Blockscad.Auth.teacher_edit&&(Blockscad.Auth.startTeacherPolling(),Blockscad.Auth.setTeInfo());var o="";t.isAdmin&&(o=' <li><a href="#" class="adminDashList">Admin Controls</a></li>\n'),$("#login-area").html('<div id="save-indicator" class="save-indicator"></div><div id="save-message" class="save-message"></div><button type="button" id="bigsavebutton" class="btn-default btn btn-lg" style="margin-top:2px;">'+Blockscad.Msg.SAVE_BUTTON+'</button><ul class="nav navbar-nav navbar-right">\n<li class="dropdown">\n<a href="#" id="username-menu" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">'+e+'<span class="caret"></span></a>\n<ul class="dropdown-menu" role="menu">\n <li><a href="'+Blockscad.Auth.baseUrl+'community/profile" id="changeProfile">'+Blockscad.Msg.MY_PROFILE+'</a></li>\n <li><a href="#" class="projectList">'+Blockscad.Msg.MY_PROJECTS+'</a></li>\n <li><a href="#" class="classList">'+Blockscad.Msg.MY_CLASSES+"</a></li>\n"+o+'<li class="divider"></li>\n<li><a href="#" id="menuLogout">'+Blockscad.Msg.LOGOUT_BUTTON+"</a></li>\n</ul>\n</li>\n</ul>\n"),$("#file-menu").html('<li><a href="#" class="projectList">'+Blockscad.Msg.MY_PROJECTS+'</a></li>\n<li><a href="#" class="new-project">'+Blockscad.Msg.NEW+'</a></li>\n<li><a href="#" id="saveProject">'+Blockscad.Msg.SAVE_BUTTON+'</a></li>\n<li><a href="#" id="saveAsProject">'+Blockscad.Msg.SAVE_BLOCKS_AS_COPY+'</a></li>\n<li class="divider"></li>\n<li><a href="#" id="saveLocal">'+Blockscad.Msg.SAVE_BLOCKS_LOCAL+'</a></li>\n<li>\n<input type="file" accept=".xml" id="loadLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'loadLocal\').click(); return false">'+Blockscad.Msg.LOAD_BLOCKS_LOCAL+'</a>\n</li>\n<li class="divider"></li>\n<li>\n<input type="file" accept=".xml" id="importLocal" style="visibility: hidden; width: 1px; height: 1px" />\n<a href="#" onclick="document.getElementById(\'importLocal\').click(); return false">'+Blockscad.Msg.IMPORT_BLOCKS_LOCAL+'</a>\n</li>\n<input type="file" accept=".stl" id="importStl" style="visibility: hidden; width: 1px; height: 1px" />\n<li class="divider"></li>\n<li><a href="#" id="saveOpenscad">'+Blockscad.Msg.SAVE_SCAD_LOCAL+"</a></li>\n")},Blockscad.Auth.checkForUser=function(){Blockscad.Auth.getUserInfo(),Blockscad.Auth.uid>0&&Blockscad.Auth.atok.length>5?$.ajax({type:"GET",url:Blockscad.Auth.getUserURL,timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){Blockscad.Auth.user=t,Blockscad.Auth.loggedIn(t),Blockscad.Auth.getProj()},fail:function(t){Blockscad.Auth.getProj()}}):(Blockscad.Auth.notLoggedIn(),Blockscad.Auth.getProj())},Blockscad.Auth.goToMyClasses=function(){Blockscad.Auth.userIsGood()?Blockscad.needToSave&&Blockscad.Auth.projectId>=0?(Blockscad.Auth.stopAutosaveTimer(),promptForSave().then(function(t){"cancel"!=t&&("nosave"==t&&(Blockscad.setSaveNeeded(!1),Blockscad.Auth.saveTimes()),"save"==t&&Blockscad.saveBlocks(),window.location=Blockscad.Auth.baseUrl+Blockscad.Auth.myClassesUrl)}).catch(function(t){console.log("caught an error in goToMyClasses.  result is:"+t)})):(Blockscad.Auth.saveTimes(),window.location=Blockscad.Auth.baseUrl+Blockscad.Auth.myClassesUrl):Blockscad.Auth.resetUser()},Blockscad.Auth.goToAdminDash=function(){Blockscad.Auth.userIsGood()?Blockscad.needToSave&&Blockscad.Auth.projectId>=0?(Blockscad.Auth.stopAutosaveTimer(),promptForSave().then(function(t){"cancel"!=t&&("nosave"==t&&(Blockscad.setSaveNeeded(!1),Blockscad.Auth.saveTimes()),"save"==t&&Blockscad.saveBlocks(),window.location=Blockscad.Auth.baseUrl+Blockscad.Auth.adminDashURL)}).catch(function(t){console.log("caught an error in goToAdminDash.  result is:"+t)})):(Blockscad.Auth.saveTimes(),window.location=Blockscad.Auth.baseUrl+Blockscad.Auth.adminDashURL):Blockscad.Auth.resetUser()},Blockscad.Auth.listProject=function(){Blockscad.Auth.userIsGood()?Blockscad.needToSave&&Blockscad.Auth.projectId>=0?(Blockscad.Auth.stopAutosaveTimer(),promptForSave().then(function(t){"cancel"!=t&&("nosave"==t&&(Blockscad.setSaveNeeded(!1),Blockscad.Auth.saveTimes()),"save"==t&&Blockscad.saveBlocks(),setTimeout(Blockscad.Auth.getActualList,300))}).catch(function(t){console.log("caught an error in new project.  result is:"+t)})):(Blockscad.Auth.saveTimes(),Blockscad.Auth.getActualList()):Blockscad.Auth.resetUser()},Blockscad.Auth.getActualList=function(){$("#projList").html("<img id=busy src='imgs/busy2.gif'>"),$("#editView").addClass("hidden"),$("#projectView").removeClass("hidden"),$("#list-more").addClass("hidden"),$("#bigsavebutton").addClass("hidden"),Blockscad.Auth.listPage=1;var t="";t="?userId="+Blockscad.Auth.uid,t+="&pageSize=20",t+="&page=1",t+="&sortBy=updatedOn",$.ajax({type:"GET",url:Blockscad.Auth.listProjectURL+t,timeout:9e3,headers:{Authorization:Blockscad.Auth.atok,"Cache-Control":"max-age=0"},success:function(t){var e=t.projects[0],o=t;if(e)$.ajax({url:e.thumbnailImageUrl,type:"GET",timeout:2e3,success:function(t){var e=Blockscad.Auth.createProjList(o.projects);$("#projList").html(e),$("#editView").addClass("hidden"),$("#projectView").removeClass("hidden"),o.total-o.page*o.pageSize>0?$("#list-more").removeClass("hidden"):$("#list-more").addClass("hidden"),$("#bigsavebutton").addClass("hidden"),$("#ptsearch").keyup()},error:function(t,e){var s=Blockscad.Auth.createProjList(o.projects);$("#projList").html(s),$("#editView").addClass("hidden"),$("#projectView").removeClass("hidden"),o.total-o.page*o.pageSize>0?$("#list-more").removeClass("hidden"):$("#list-more").addClass("hidden"),$("#bigsavebutton").addClass("hidden"),$("#ptsearch").keyup()}});else{var s=Blockscad.Auth.createProjList(o.projects);$("#projList").html(s),$("#editView").addClass("hidden"),$("#projectView").removeClass("hidden"),o.total-o.page*o.pageSize>0?$("#list-more").removeClass("hidden"):$("#list-more").addClass("hidden"),$("#bigsavebutton").addClass("hidden"),$("#ptsearch").keyup()}},fail:function(t){console.log("list fail: ",t)}})},Blockscad.Auth.listMoreProject=function(){if(Blockscad.Auth.userIsGood()){Blockscad.Auth.listPage++;var t="";t="?userId="+Blockscad.Auth.uid,t+="&pageSize=20",t+="&page="+Blockscad.Auth.listPage,t+="&sortBy=updatedOn",$.ajax({type:"GET",url:Blockscad.Auth.listProjectURL+t,timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){var e=Blockscad.Auth.createProjList(t.projects);$("#projList").append(e),t.total-t.page*t.pageSize>0?$("#list-more").removeClass("hidden"):$("#list-more").addClass("hidden"),$("#ptsearch").keyup()},fail:function(t){console.log("fail: ",t)}})}else Blockscad.Auth.resetUser()},Blockscad.Auth.saveBlocksToAccount=function(t){return new Promise(function(e,o){var s=$("#project-name").val();""==s&&(s=Blockscad.Msg.PROJECT_NAME_DEFAULT),Blockscad.Auth.saveThing(s,t).then(function(){e("saved from saveBlocksToAccount")}).catch(function(){$("#bigsavebutton").prop("disabled",!1)})})},Blockscad.Auth.saveThing=function(t,e){return new Promise(function(o,s){if(console.log("in SaveThing"),Blockscad.Auth.userIsGood()){if(Blockscad.setSaveNeeded(!1),Blockscad.Auth.teacher_edit){var c=moment(),a=moment.duration(c.diff(Blockscad.Auth.myLastTime));Blockscad.Auth.checkForProjectUpdate(Blockscad.Auth.projectId,a).then(function(t){});for(var l=Blockscad.workspace.getTopBlocks(),n=0;n<l.length;n++)"bs_message"==l[n].type&&(l[n].setDeletable(!1),l[n].setEditable(!1))}window.setTimeout(function(){$("#save-message").html(Blockscad.Msg.SAVE_IN_PROGRESS),$("#save-indicator").html("")},0),$("#bigsavebutton").prop("disabled",!0),window.setTimeout(function(){$("#bigsavebutton").prop("disabled",!1)},3e3);var i=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()),d=Blockly.Xml.domToText(i);0!=d.lastIndexOf("<xml xmlns",0)&&(console.log("can't save - invalid xml"),s("save failed - invalid xml"));var r=Base64.toBase64(RawDeflate.deflate(Base64.utob(d))),u=Blockscad.Auth.processSessionHistory(Blockscad.Auth.sessionHistory),h={};if(h.title=t,h.version=Blockscad.version,h.time_spent=Math.round(TimeMe.getTimeOnCurrentPageInSeconds()),h.time_spent<3&&(h.time_spent=0),isNaN(h.time_spent)&&(h.time_spent=0,console.log("the time spent was NaN.  Why?")),TimeMe.resetRecordedPageTime("blockscad_editor"),TimeMe.startTimer("blockscad_editor"),Blockscad.Auth.class_id&&Blockscad.Auth.teacher_edit&&(h.classroom_id=Blockscad.Auth.class_id),h.body=r,h.session_history=u,d.match(/triangle_..._3d/)&&(h.special_blocks="triangle"),Blockscad.Auth.projectParent&&(h.inspiredBy=Blockscad.Auth.projectParent),"none"!=Blockscad.gProcessor.thumbnail&&(h.thumbnailImage=Blockscad.gProcessor.thumbnail.split(",")[1],h.altImage=Blockscad.gProcessor.imgStrip.split(",")[1],h.image=Blockscad.gProcessor.img.split(",")[1]),Blockscad.Auth.projectId){var k=Blockscad.Auth.projectId+".json";$.ajax({url:Blockscad.Auth.updateProjectURL+k,type:"PUT",data:JSON.stringify(h),timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){if(Blockscad.Auth.projectId!=t.projectId&&console.log("project id coming back from update doesn't match!"),Blockscad.Auth.projectId=t.projectId,Blockscad.Auth.teacher_edit){Blockscad.Auth.myLastTime=moment(t.savedOn);for(var e=Blockscad.workspace.getTopBlocks(),s=0;s<e.length;s++)"bs_message"==e[s].type&&(e[s].setDeletable(!0),e[s].setEditable(!0))}Blockscad.setSaveNeeded(!1),$("#save-message").html(Blockscad.Msg.SAVE_COMPLETE),Blockscad.Auth.saveSTL(Blockscad.Auth.projectId),setTimeout(function(){$("#save-message").html(""),$("#bigsavebutton").prop("disabled",!1)},1500),o("saved")},error:function(t,o){console.log("prup fail: ",t.status),$("#save-message").html(Blockscad.Msg.SAVE_FAILED),1!=e&&Blockscad.Auth.saveFailedPopup(),$("#bigsavebutton").prop("disabled",!1),setTimeout(function(){$("#save-message").html(""),Blockscad.setSaveNeeded(!0)},2e3),s("save failed")}})}else $.ajax({url:Blockscad.Auth.createProjectURL,type:"POST",data:JSON.stringify(h),timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){Blockscad.Auth.projectId=t.projectId,Blockscad.setSaveNeeded(!1),$("#projectPageLink").show(),$("#projectPageLink").attr("href",Blockscad.Auth.baseUrl+"community/projects/"+Blockscad.Auth.projectId),$("#save-message").html(Blockscad.Msg.SAVE_COMPLETE),Blockscad.Auth.saveSTL(Blockscad.Auth.projectId),setTimeout(function(){$("#save-message").html(""),$("#bigsavebutton").prop("disabled",!1)},1500),o("saved")},error:function(t,o){console.log("prcr fail: ",t.status),$("#save-message").html(Blockscad.Msg.SAVE_FAILED),1!=e&&Blockscad.Auth.saveFailedPopup(),$("#bigsavebutton").prop("disabled",!1),setTimeout(function(){$("#save-message").html(""),Blockscad.setSaveNeeded(!0)},2e3),s("save failed")}}),$("#save-message").html(""),$("#bigsavebutton").prop("disabled",!1)}else Blockscad.Auth.resetUser()})},Blockscad.Auth.saveFailedPopup=function(){bootbox.confirm({size:"small",title:Blockscad.Msg.SAVE_FAILED,message:Blockscad.Msg.SAVE_BLOCKS_LOCAL+"?",callback:function(t){t&&(Blockscad.saveBlocksLocal(),Blockscad.setSaveNeeded(!0))}})},Blockscad.Auth.inTurkeyPopup=function(){if($("#trcode").on("input",function(){$("#tr-code-error").text("")}),$("#tr-modal-close").on("click",function(){e.preventDefault(),e.stopPropagation(),window.location.href="https://blockscad3d.com/tr/home"}),$("#tr-modal").on("click","#tr-submit",function(t){t.preventDefault(),t.stopPropagation(),$("#tr-code-error").text("");var e=$("#trcode").val();if(!e||e.length<8)$("#tr-code-error").text(Blockscad.Msg.INVALID_ACCESS_CODE);else{var o=e.trim().toLowerCase();$.ajax({url:Blockscad.Auth.redeemTRCouponURL,type:"PUT",timeout:9e3,data:JSON.stringify({code:o}),headers:{Authorization:Blockscad.Auth.atok},success:function(t){console.log("redeem success!, check for user plan:",t);var e={token:Blockscad.Auth.atok,user:t};if(console.log(JSON.stringify(e)),"localStorage"in window){window.localStorage.setItem("community-user",JSON.stringify(e))}$("#tr-modal").modal("hide")},error:function(t,e,o){$("#tr-code-error").text(Blockscad.Msg.INVALID_ACCESS_CODE)}})}}),Blockscad.Auth.user&&Blockscad.Auth.user.userId){console.log("TR logged in"),$("#tr-footer").hide();var t=!1;if(console.log("user data:",Blockscad.Auth.user.plan_id),console.log("user"),console.log(Blockscad.Auth.user),Blockscad.Auth.user.plan_id&&Blockscad.Auth.user.plan_id.startsWith("ind_")){var o=Blockscad.Auth.user.plan_id.split("_")[2];new Date<new Date(o)&&(t=!0)}t||$("#tr-modal").modal("show")}else $("#tr-body").addClass("disableDiv"),$("#tr-modal").modal("show")},Blockscad.Auth.saveTimes=function(t){var e;Blockscad.Auth.user&&Blockscad.Auth.user.userId&&((e=t||Math.round(TimeMe.getTimeOnCurrentPageInSeconds()))<3||(TimeMe.resetRecordedPageTime("blockscad_editor"),TimeMe.startTimer("blockscad_editor"),Blockscad.Auth.projectId&&$.ajax({url:Blockscad.Auth.updateProjectTimeURL.replace("<pid>",Blockscad.Auth.projectId),type:"PUT",data:JSON.stringify({time_spent:e}),timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){},fail:function(t){}}),$.ajax({url:Blockscad.Auth.updateUserTimeURL,type:"PUT",data:JSON.stringify({time_spent:e}),timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){},fail:function(t){}})))},Blockscad.Auth.saveSTL=function(t){if("none"!=Blockscad.gProcessor.stl){var e=new window.FileReader;e.readAsDataURL(Blockscad.gProcessor.stl),e.onloadend=function(){var o=e.result.split(",")[1],s=Blockscad.gProcessor.stl,c=md5(o);Blockscad.Auth.getSignedRequest(t,c,s)}}},Blockscad.Auth.saveOtherSTL=function(){},Blockscad.Auth.getSignedRequest=function(t,e,o){var s="?file_hash="+e;Blockscad.Auth.class_id&&Blockscad.Auth.teacher_edit&&(s+="&classroom_id="+Blockscad.Auth.class_id),$.ajax({url:Blockscad.Auth.signedRequestURL.replace("<pid>",t)+s,type:"GET",timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(e){Blockscad.Auth.uploadStl(o,e.data,e.url,t)},fail:function(t){console.log("failed to getSignedRequest:",t)}})},Blockscad.Auth.uploadStl=function(t,e,o,s){var c=new XMLHttpRequest;c.open("POST",e.url);var a=new FormData;for(var l in e.fields)a.append(l,e.fields[l]);a.append("file",t),c.onreadystatechange=function(){4===c.readyState&&(200===c.status||204===c.status||(console.log("Could not upload file."),$.ajax({url:Blockscad.Auth.updateStlURL.replace("<pid>",s),type:"PUT",timeout:9e3,data:JSON.stringify({stl_path:"projects/empty.stl",classroom_id:Blockscad.Auth.class_id}),headers:{Authorization:Blockscad.Auth.atok},success:function(t){},fail:function(t){console.log("efailed to update stl_storage_path:",t)}})))},c.send(a)},Blockscad.Auth.saveAsCopyToAccount=function(){Blockscad.Auth.teacher_edit?Blockscad.Auth.saveCopy():Blockscad.Auth.saveBlocksToAccount(!0).then(function(){Blockscad.Auth.saveCopy()})},Blockscad.Auth.saveCopy=function(){var t=$("#project-name").val();""==t&&(t=Blockscad.Msg.PROJECT_NAME_DEFAULT),t+=" copy",$("#project-name").val(t),Blockscad.Auth.clearCurrentProject(),Blockscad.setSaveNeeded(!0),Blockscad.Auth.saveBlocksToAccount(!0),Blockscad.Auth.unsetTeacherEdit()},Blockscad.Auth.resetUser=function(){Blockscad.Auth.notLoggedIn(),$("#login-button").click()},Blockscad.Auth.getUserInfo=function(){if("localStorage"in window){var t=window.localStorage["community-user"];if(t){var e=JSON.parse(t);if(e.token&&e.user)return Blockscad.Auth.atok=e.token,Blockscad.Auth.uid=e.user.userId,void(Blockscad.Auth.user=e.user)}}Blockscad.Auth.atok="",Blockscad.Auth.uid=0,Blockscad.Auth.user=""},Blockscad.Auth.setUserInfo=function(){},Blockscad.Auth.clearCurrentProject=function(){Blockscad.Auth.projectId=0,Blockscad.Auth.projectParent=0,Blockscad.Auth.assignmentId=0,Blockscad.Auth.assignmentDueDateString="",Blockscad.Auth.instructionsString="",Blockscad.Auth.unsetAssignmentProps()},Blockscad.Auth.createProjTable=function(t){var e="";return e+=Blockscad.Auth.createProjList(t)},Blockscad.Auth.createProjList=function(t){for(var e="",o=0;o<t.length;o++){var s=t[o],c=new Date(s.updatedOn),a=""+c.getFullYear()+pad(c.getMonth(),2)+pad(c.getDay(),2)+pad(c.getHours(),2)+pad(c.getMinutes(),2)+pad(c.getSeconds(),2);if(e+="<tr style='height:82px'>\n",e+="  <td style='padding:0px;border:1px solid #ddd;min-width:80px'><a href='"+Blockscad.Auth.baseUrl+"community/projects/"+s.projectId+"'><img src=\""+s.thumbnailImageUrl+"\" style='width:82px'/></a></td>\n",e+="  <td class='sb' style='position:relative'>\n",e+='  <div class="top">',s.assignment&&(e+="<span class='adue'>"+Blockscad.Msg.LESSON+"</span>"),e+='<a href="'+Blockscad.Auth.baseUrl+"community/projects/"+s.projectId+'" class="proj-link">'+s.title+"</a></div>\n",e+='  <div class="bottom"><a href="#" style="padding-left:20px;padding-right:20px"class="proj-to-download btn btn-default" data-id="'+s.projectId.toString()+'">'+Blockscad.Msg.PROJECT_LIST_EDIT_BUTTON+"</a></div>\n",e+="  </td>\n",e+="  <td sorttable_customkey='"+a+"'>"+timeSince(c,178)+"</td>\n",Blockscad.Auth.isLimited||Blockscad.Auth.isEduLimited)if(Blockscad.Auth.user&&Blockscad.Auth.user.classesAsStudent.length>0){if(e+="<td>",s.assignment&&s.assignment.due_date){if("tr"==BSUtils.LANG)l=moment(s.assignment.due_date).format("D/M/YYYY");else l=moment(s.assignment.due_date).format("M/D/YYYY");"Invalid date"==l&&(l=Blockscad.Msg.LESSON),e+='<p style="margin-bottom:1px"><span class="adue">'+Blockscad.Msg.DUE_DATE+": "+l+"</span></p>"}e+='<p><a href="#" class="proj-submit btn btn-default">'+Blockscad.Msg.SUBMIT_BUTTON+"</a></p>",e+="</td>",e+="<td>",e+='<p><a href="#" class="proj-add-notes btn btn-default">'+Blockscad.Msg.PRINT_NOTES+"</a></p>",e+="</td>"}else e+="<td></td><td></td>";else if(s.isShared?(e+='    <td style="white-space:nowrap">\n',e+=Blockscad.Auth.createShareCell(s.projectId,s.like_count,s.comment_count,s.view_count,s.derived_project_count),e+="    </td>\n"):e+='    <td style="white-space:nowrap"><button class="share btn btn-default" data-id="'+s.projectId.toString()+'">'+Blockscad.Msg.PROJECT_LIST_SHARE_BUTTON+"</button></td>\n",Blockscad.Auth.user.classesAsStudent.length>0){if(e+="<td>",s.assignment&&s.assignment.due_date){if("tr"==BSUtils.LANG)var l=moment(s.assignment.due_date).format("D/M/YYYY");else var l=moment(s.assignment.due_date).format("M/D/YYYY");"Invalid date"==l&&(l=Blockscad.Msg.LESSON),e+='<span class="adue">'+Blockscad.Msg.DUE_DATE+": "+l+"</span><br>"}s.submittedOn?e+='<a href="#" class="proj-submit btn btn-default">'+Blockscad.Msg.RESUBMIT_BUTTON+"</a>":e+='<a href="#" class="proj-submit btn btn-default">'+Blockscad.Msg.SUBMIT_BUTTON+"</a>",e+='<br><a href="#" class="proj-add-notes btn btn-default">'+Blockscad.Msg.PRINT_NOTES+"</a>",e+="</td>"}else e+='     <td style="text-align:center">',e+='<div class="btn-group">',e+='  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">',e+='   <span style="font-size:1.3em;color:#909090" class="glyphicon glyphicon-upload"></span> Upload to... <span class="caret"></span>',e+="  </button>",e+='  <ul class="dropdown-menu" role="menu">',e+='    <li><a class="dropdown-item upload-th" href="#" data-id="'+s.projectId.toString()+'">Thingiverse</a></li>',e+='    <li><a class="dropdown-item" href="https://my.makerbot.com/print?file_url='+encodeURI(s.stlUrl)+' "target="_blank">My Makerbot</a></li>',e+="  </ul>",e+="</div>",e+="</td>\n";e+="     <td>",s.assignment||(e+="  <button class='delbtn btn btn-default'>"+Blockscad.Msg.PROJECT_LIST_DELETE_BUTTON+"</button>\n"),e+="</tr>\n"}return e},Blockscad.Auth.createShareCell=function(t,e,o,s,c){var a="";return a+='        <div class="row">\n',a+='            <div class="col-xs-6"><img src="imgs/star.svg" onerror="L" width=13px > : '+e+"</div>\n",a+='            <div class="col-xs-6"><img src="imgs/comment-solid.svg" onerror="C" width=13px > : '+o+"</div>\n",a+="        </div>\n",a+='        <div class="row">\n',a+='            <div class="col-xs-6"><img src="imgs/eye.svg" onerror="V" width=13px > : '+s+"</div>\n",a+='            <div class="col-xs-6"><img src="imgs/copy.svg" onerror="D" width=13px > : '+c+"</div>\n",a+="        </div>\n",a+='        <div class="row">\n',a+='            <button class="unshare btn btn-default" style="margin-left:14px; padding-top:3px; padding-bottom:3px; margin-top:5px"',a+='data-id="'+t.toString()+'">'+Blockscad.Msg.PROJECT_LIST_UNSHARE_BUTTON+"</button>\n",a+="        </div>\n"},Blockscad.Auth.userIsGood=function(){if("localStorage"in window){var t=window.localStorage["community-user"];if(t&&t.length){var e=JSON.parse(t),o=e.token,s=e.user.userId;if(o==Blockscad.Auth.atok&&s==Blockscad.Auth.uid)return!0}}return!1},Blockscad.Auth.shareProject=function(t,e){$(e).prop("disabled",!0),window.setTimeout(function(){$(e).prop("disabled",!1)},2500),$.ajax({type:"PUT",url:Blockscad.Auth.updateProjectURL+t+"/mark-public.json",timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){var o=Blockscad.Auth.createShareCell(t.projectId,t.likeCount,t.commentCount,t.viewCount,t.derivedProjectCount);$(e).closest("td").html(o)},fail:function(t){console.log("failed to share project!",t)}})},Blockscad.Auth.unshareProject=function(t,e){$(e).prop("disabled",!0),window.setTimeout(function(){$(e).prop("disabled",!1)},2500),$.ajax({type:"PUT",url:Blockscad.Auth.updateProjectURL+t+"/mark-private.json",timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(t){$(e).closest("td").html('<button class="share btn btn-default"data-id="'+t.projectId.toString()+'">'+Blockscad.Msg.PROJECT_LIST_SHARE_BUTTON+"</button>")},fail:function(t){console.log("failed to unshare project!",t)}})},Blockscad.Auth.loadProject=function(t,e){Blockly.mainWorkspace.clear(),Blockscad.gProcessor.clearViewer(),$("#displayBlocks").click(),$("#projectView").addClass("hidden"),$("#editView").removeClass("hidden"),$("#bigsavebutton").removeClass("hidden");var o=Blockly.Xml.textToDom(t);Blockly.mainWorkspace.clear(),Blockscad.recordHistory=!1,Blockly.Xml.domToWorkspace(o,Blockly.getMainWorkspace()),setTimeout(function(){Blockscad.recordHistory=!0},10),Blockscad.clearStlBlocks(),Blockscad.workspace.clearUndo(),setTimeout(function(){Blockscad.setSaveNeeded(!1)},120),$("#projectView").addClass("hidden"),$("#project-name").val(e)},Blockscad.Auth.unsetTeacherEdit=function(){if(Blockscad.Auth.teacher_edit=null,Blockscad.Auth.class_id=null,Blockscad.Auth.class_name="",Blockscad.Auth.authorDisplayName=null,Blockscad.Auth.secondsSpent=null,Blockscad.Auth.inspiredBy=null,Blockscad.Auth.rebuildToolbox(!1),Blockscad.Auth.stopTeacherPolling(),Blockscad.Auth.unsetTeInfo(),Blockscad.workspace)for(var t=Blockscad.workspace.getTopBlocks(),e=0;e<t.length;e++)"bs_message"==t[e].type&&(t[e].setDeletable(!1),t[e].setEditable(!1))},Blockscad.Auth.downloadProject=function(t,e,o,s,c,a){return new Promise(function(l,n){o&&o.parent().next().html("<img id=busy src='imgs/busy2.gif'>");var i="";s&&(i+="?cid="+s),a||"undefined"==a||Blockscad.Auth.unsetTeacherEdit(),$.ajax({type:"GET",url:Blockscad.Auth.updateProjectURL+t+".json"+i,timeout:9e3,headers:{Authorization:Blockscad.Auth.atok},success:function(i){Blockscad.Auth.saveTimes(),c&&console.log("downloaded a project:",i);var d=i.body;d&&d.match(/^http/)?$.ajax({url:i.body,type:"GET",timeout:9e3,success:function(r){i.body=r,(d=r).match(/^http/)?$.ajax({url:i.body,type:"GET",timeout:9e3,success:function(r){console.log("S3 has a link for the body, this is wrong, but see if there is actual code at the link"),i.body=r,(d=r).match(/^http/)?(console.log("Nope.  No actual code here."),n("fail: invalid xml")):(console.log("Yup!  I have actual code here!  Lets use it."),Blockscad.Auth.processDownloadedProject(i,t,e,o,s,c,a),l(i))},error:function(t,e){console.log("AWS xml file not found: "+t.status+". "),t.status=404,n("fail")}}):(Blockscad.Auth.processDownloadedProject(i,t,e,o,s,c,a),l(i))},error:function(t,e){console.log("AWS xml file not found: "+t.status+". "),t.status=404,n("fail")}}):(Blockscad.Auth.processDownloadedProject(i,t,e,o,s,c,a),l(i));i.sessionHistoryUrl;$.ajax({url:i.sessionHistoryUrl,type:"GET",timeout:9e3,success:function(t){Blockscad.Auth.unprocessSessionHistory(t)},error:function(t,e){console.log("AWS sessionHistory file not found: "+t.status+". "),t.status=404,n("fail")}})},error:function(t,e){console.log("couldn't get project from backend: "+t.status+". "),n("fail")}})})},Blockscad.Auth.processSessionHistory=function(t){var e=Blockscad.saveSessionHistory(t);return Base64.toBase64(RawDeflate.deflate(Base64.utob(e)))},Blockscad.Auth.unprocessSessionHistory=function(t){var e=Base64.btou(RawDeflate.inflate(Base64.fromBase64(t)));Blockscad.Auth.sessionHistory=[];for(var o=e.split(/\n/),s=0;s<o.length-1;s++)Blockscad.Auth.sessionHistory.push(Blockly.Events.fromJson(JSON.parse(o[s]),Blockscad.workspace))},Blockscad.Auth.processDownloadedProject=function(t,e,o,s,c,a,l){var n=Base64.btou(RawDeflate.inflate(Base64.fromBase64(t.body))),i=t.title;if(o?(i+=" Remix",Blockscad.Auth.projectId=0,Blockscad.Auth.projectParent=e):(Blockscad.Auth.projectId=e,Blockscad.Auth.projectParent=0),Blockscad.Auth.loadProject(n,i),t.assignment_id&&t.assignment){Blockscad.Auth.assignmentId=t.assignment_id;var d=moment(t.assignment.due_date).format("M/D/YYYY");"tr"==Blockscad.pLang&&(d=moment(t.assignment.due_date).format("D/M/YYYY")),d="Invalid date"==d?Blockscad.Msg.LESSON:Blockscad.Msg.DUE_DATE+": "+d,Blockscad.Auth.assignmentDueDateString=d,t.assignment.instructionsUrl&&t.assignment.instructionsUrl.length>5?Blockscad.Auth.instructionsString='<a href="'+t.assignment.instructionsUrl+'" type="button" class="btn-blue btn-blue-big" target="_blank">'+Blockscad.Msg.L_STUDENT_INSTRUCTIONS+"</a>":Blockscad.Auth.instructionsString="",Blockscad.Auth.setAssignmentProps()}else Blockscad.Auth.assignmentId=0,Blockscad.Auth.assignmentDueDateString="",Blockscad.Auth.instructionsString="",Blockscad.Auth.unsetAssignmentProps();Blockscad.Auth.teacher_edit?(Blockscad.Auth.authorDisplayName=t.author.display_name,t.inspiredBy&&(Blockscad.Auth.inspiredBy=t.inspiredBy.projectId),Blockscad.Auth.secondsSpent=t.secondsSpent,Blockscad.Auth.setTeInfo()):Blockscad.Auth.unsetTeInfo(),Blockscad.Auth.projectId?($("#projectPageLink").show(),$("#projectPageLink").attr("href",Blockscad.Auth.baseUrl+"community/projects/"+Blockscad.Auth.projectId)):$("#projectPageLink").hide(),window.dispatchEvent(new Event("resize"))},Blockscad.Auth.setTeInfo=function(){var t="";t+='<div class="te-info">',t+="<div>"+Blockscad.Auth.class_name+"</div>",t+="<div>"+Blockscad.Auth.authorDisplayName+':&nbsp;<span class="glyphicon glyphicon-time" style="padding-right:5px"></span>',t+=Blockscad.Auth.getTimeSpentString(Blockscad.Auth.secondsSpent)+"&nbsp;",Blockscad.Auth.inspiredBy&&(t+=' <a href="'+Blockscad.Auth.baseUrl+"community/projects/"+Blockscad.Auth.inspiredBy+'" class="btn btn-blue btn-blue-narrow" target="_blank">Inspired By</a>'),t+="</div>",t+="</div>",$("#main").append(t)},Blockscad.Auth.unsetTeInfo=function(){$(".te-info")&&$(".te-info").remove()},Blockscad.Auth.setTeacherEdit=function(){Blockscad.Auth.rebuildToolbox(!0),Blockscad.Auth.startTeacherPolling(),Blockscad.Auth.setTeInfo();for(var t=Blockscad.workspace.getTopBlocks(),e=0;e<t.length;e++)"bs_message"==t[e].type&&(t[e].setDeletable(!0),t[e].setEditable(!0))},Blockscad.Auth.getProj=function(){var t=BSUtils.getStringParamFromUrl("project",""),e=BSUtils.getStringParamFromUrl("from",""),o=BSUtils.getStringParamFromUrl("exampleSolution",""),s=BSUtils.getStringParamFromUrl("example_solution",""),c=BSUtils.getStringParamFromUrl("startingBlocks","");"polar"==e&&(e="");var a=BSUtils.getStringParamFromUrl("teacheredit",""),l=BSUtils.getStringParamFromUrl("cid",""),n=BSUtils.getStringParamFromUrl("cname","");if(Blockscad.Auth.example_solution=0,Blockscad.Auth.starting_blocks=0,e.length)Blockscad.Auth.downloadProject(e,!0).catch(function(t){Blockscad.Auth.downloadProjectFailed(t)}),history.replaceState({},"BlocksCAD","/editor/");else if(Blockscad.Auth.fromPolar&&Blockscad.Auth.polarGet)console.log("this is a project to get from polar.");else if(t.length)Blockscad.Auth.downloadProject(t).catch(function(t){Blockscad.Auth.downloadProjectFailed(t)}),history.replaceState({},"BlocksCAD","/editor/");else if(a.length&&l.length)Blockscad.Auth.teacher_edit=!0,Blockscad.Auth.class_id=l,Blockscad.Auth.class_name=n,Blockscad.Auth.downloadProject(a,!1,null,l,!1,!0).catch(function(t){Blockscad.Auth.downloadProjectFailed(t)}),Blockscad.Auth.projectId=a,Blockscad.Auth.myLastTime=moment(),Blockscad.Auth.checkForProjectUpdate(Blockscad.Auth.projectId,moment.duration(0),!0),Blockscad.Auth.setTeacherEdit(),history.replaceState({},"BlocksCAD","/editor/");else if(o||s){if(console.log("I got an example solution:"+o+","+s),Blockscad.Auth.example_solution=!0,history.replaceState({},"BlocksCAD","/editor/"),o&&"localStorage"in window&&(d=window.localStorage.exampleSolution,r=window.localStorage.solutionTitle),Blockscad.Auth.unsetTeacherEdit(),d&&d.length&&!s){var i=Base64.btou(RawDeflate.inflate(Base64.fromBase64(d)));Blockscad.Auth.saveTimes(),Blockscad.Auth.loadProject(i,r),Blockscad.Auth.projectId=0,Blockscad.Auth.projectParent=0,Blockscad.Auth.assignmentId=0,Blockscad.Auth.assignmentDueDateString="",Blockscad.Auth.instructionsString="",Blockscad.doRender()}else{(u=o.trim())||(u=s.trim()),$.ajax({url:Blockscad.Auth.getAssignmentByIdURL.replace("<aid>",u),type:"GET",timeout:9e3,success:function(t){var e=t.example_solution,o=t.title,s=Base64.btou(RawDeflate.inflate(Base64.fromBase64(e)));Blockscad.Auth.saveTimes(),Blockscad.Auth.loadProject(s,o),Blockscad.Auth.projectId=0,Blockscad.Auth.projectParent=0,Blockscad.Auth.assignmentId=0,Blockscad.Auth.assignmentDueDateString="",Blockscad.Auth.instructionsString="",Blockscad.doRender()},error:function(t,e){console.log("ajax error: "+e+". couldn't get assignment by ID.")}})}window.localStorage.exampleSolution="",window.localStorage.solutionTitle=""}else if(c){var d,r;console.log("I got starting blocks:"+c),Blockscad.Auth.starting_blocks=!0,history.replaceState({},"BlocksCAD","/editor/"),Blockscad.Auth.unsetTeacherEdit();var u=c.trim();$.ajax({url:Blockscad.Auth.getAssignmentByIdURL.replace("<aid>",u),type:"GET",timeout:9e3,success:function(t){if(Blockscad.Auth.user&&Blockscad.Auth.user.isPremium||t.free){var e=t.body,o=t.title,s=Base64.btou(RawDeflate.inflate(Base64.fromBase64(e)));Blockscad.Auth.saveTimes(),Blockscad.Auth.loadProject(s,o),Blockscad.Auth.projectId=0,Blockscad.Auth.projectParent=0,Blockscad.Auth.assignmentId=0,Blockscad.Auth.assignmentDueDateString="",t.instructionsUrl&&t.instructionsUrl.length>5&&(console.log("got instructions"),Blockscad.Auth.instructionsString='<a href="'+t.instructionsUrl+'" type="button" class="btn-blue btn-blue-big" target="_blank">Instructions</a>',Blockscad.Auth.setAssignmentProps()),Blockscad.doRender()}else bootbox.alert("You don't have permissions to view this project."),Blockscad.clearProject()},error:function(t,e){console.log("ajax error: "+e+". couldn't get assignment by ID."),Blockscad.clearProject()}})}},Blockscad.Auth.rebuildToolbox=function(t){Blockscad.workspace&&(Blockscad.Toolbox.createToolbox(t),Blockscad.Toolbox.catIDs=[],3==Blockscad.Auth.user.site_id||3==Blockscad.Auth.user.site_student?Blockscad.workspace.updateToolbox(Blockscad.Toolbox.adv_w_triangles):$("#advancedToolbox").hasClass("hidden")?Blockscad.workspace.updateToolbox(Blockscad.Toolbox.adv):$("#simpleToolbox").hasClass("hidden")?Blockscad.workspace.updateToolbox(Blockscad.Toolbox.sim):Blockscad.workspace.updateToolbox(Blockscad.Toolbox.advExp),Blockscad.Toolbox.setCatColors())},Blockscad.Auth.fromPolar=function(){var t=BSUtils.getStringParamFromUrl("from","");Blockscad.Auth.fromPolar=!1;var e=window.location.href.split("#")[0],o=(e=e.split("?")[0])+"frompolar",s=(new Date).getTime(),c=BSUtils.getStringParamFromUrl("xml","");if(t.length&&"polar"==t)Blockscad.Auth.fromPolar=!0,window.localStorage.setItem(o,s),history.replaceState({},"BlocksCAD","/editor/");else{var a=window.localStorage[o];a&&"undefined"!=a&&s-Number(a)<36e5&&(Blockscad.Auth.fromPolar=!0)}c.length&&(Blockscad.Auth.polarGet=c,c=decodeURIComponent(c),$.ajax({url:c,type:"GET",timeout:9e3,success:function(t){Blockscad.Auth.polarResult=(new XMLSerializer).serializeToString(t),Blockscad.Auth.loadProject(Blockscad.Auth.polarResult,"Untitled")},error:function(t,e){Blockscad.Auth.polarResult="ajax error: "+e+". couldn't get xml file from Polar."}}))},Blockscad.Auth.pcSaveStl=function(t){return new Promise(function(e,o){$.ajax({url:"https://polar3d.com/api/s3/blockscad?redirect=login&type=handoff_part&ext=stl&",type:"GET",timeout:9e3,headers:{Authorization:"blockscad"},success:function(s){var c=s[0].signed_url,a=s[0].public_url,l=s[0].content_type;$.ajax({url:c,type:"PUT",timeout:9e3,data:t,processData:!1,contentType:l,success:function(t){e(a)},fail:function(t){o(t),console.log("got a fail back from polar when trying to get PUT url:",t)}})},fail:function(t){o(t),console.log("got a fail back from polar when trying to get PUT url:",t)}})})},Blockscad.Auth.pcSaveFile=function(t,e){return new Promise(function(o,s){var c=e.signed_url,a=e.public_url,l=e.content_type;$.ajax({url:c,type:"PUT",timeout:9e3,data:t,processData:!1,contentType:l,success:function(){o(a)},fail:function(){s("polar failed to save this file:",a),console.log("got a fail back from polar when trying to save file")}})})},Blockscad.Auth.pcUploadProject=function(t,e){var o="https://polar3d.com/handoff/object";o+="?name="+encodeURI($("#project-name").val()),o+="&description="+encodeURI("This project was made in BlocksCAD at www.blockscad3d.com.");var s=window.open("","_blank"),c=Blockly.Xml.workspaceToDom(Blockly.getMainWorkspace()),a=Blockly.Xml.domToText(c),l=new Blob([a],{type:"text/plain;charset=utf-8"});Blockscad.Auth.pcGetPutUrl().then(function(e){return Promise.all([Blockscad.Auth.pcSaveFile(t,e[0]),Blockscad.Auth.pcSaveFile(l,e[1])])}).then(function(e){o+="&url="+encodeURI(e[0]),o+="&fileName="+encodeURI($("#project-name").val()+".stl"),o+="&ext=stl",o+="&fileSize="+t.size,o+="&fileSource=blockscad",o+="&opaqueData="+encodeURI(e[1]),o+="&url="+encodeURI(e[1]),o+="&fileName="+encodeURI($("#project-name").val()+".xml"),o+="&ext=xml",o+="&fileSize="+l.size,o+="&fileSource=blockscad",o+="&opaqueData="+encodeURI(e[1]),s.location=o}).catch(function(t){console.log("upload to polar failed with:",t)})},Blockscad.Auth.pcGetPutUrl=function(){return new Promise(function(t,e){$.ajax({url:"https://polar3d.com/api/s3/blockscad?redirect=login&type=object_part&ext=stl&type=object_part&ext=xml",type:"GET",timeout:9e3,headers:{Authorization:"blockscad"},success:function(e){t(e)},fail:function(t){e(t),console.log("got a fail back from polar when trying to get PUT url:",t)}})})},Blockscad.Auth.tvLoadFromStorage=function(){var t=window.location.href.split("#")[0],e=(t=t.split("?")[0])+"tvpid";window.localStorage[e]&&(Blockscad.Auth.tvpid=window.localStorage[e],console.log("got a tvpid from localstorage:",Blockscad.Auth.tvpid))},Blockscad.Auth.openThingiverse=function(t,e){e.prop("disabled",!0),window.setTimeout(function(){e.prop("disabled",!1)},2500);var o=window.location.href.split("#")[0];o=o.split("?")[0],Blockscad.Auth.tvpid=t;var s=o+"tvpid";window.localStorage.setItem(s,Blockscad.Auth.tvpid),window.open("https://www.thingiverse.com/login/oauth/authorize?client_id=2f020a100726e5a656ec&response_type=token","_blank")},Blockscad.Auth.TVgetUserInfo=function(){return new Promise(function(t,e){$.ajax({url:"https://api.thingiverse.com/users/me",type:"GET",timeout:9e3,headers:{Authorization:"Bearer "+Blockscad.Auth.thingiverseToken},success:function(e){t(e.name)},fail:function(t){console.log("thingiverse token verify fail!:",t),e("fail")}})})},Blockscad.Auth.TVgetFileDirection=function(t,e,o){return new Promise(function(s,c){$.ajax({type:"POST",url:"https://api.thingiverse.com/things/"+t.id+"/files",timeout:9e3,headers:{Authorization:"Bearer "+Blockscad.Auth.thingiverseToken},data:JSON.stringify({filename:e}),success:function(t){s([t,e,o])},fail:function(t){console.log("failed to get address to post file to AWS:",e),c([t,e,o])}})})},Blockscad.Auth.TVsendFileToAWS=function(t){return new Promise(function(e,o){var s=t[0],c=t[1],a=t[2],l=s.fields.success_action_redirect,n=new FormData;n.append("AWSAccessKeyId",s.fields.AWSAccessKeyId),n.append("bucket",s.fields.bucket),n.append("key",s.fields.key),n.append("acl",s.fields.acl),n.append("policy",s.fields.policy),n.append("signature",s.fields.signature),n.append("success_action_redirect",s.fields.success_action_redirect),n.append("Content-Type",s.fields["Content-Type"]),n.append("Content-Disposition",s.fields["Content-Disposition"]),n.append("file",a,c),$.ajax({url:s.action,type:"POST",data:n,contentType:!1,processData:!1,success:function(t){e(l)},fail:function(t){o("AWS sent back fail")},error:function(t,o){e(l)}})})},Blockscad.Auth.TVuploadFile=function(t,e,o){return new Promise(function(s,c){Blockscad.Auth.TVgetFileDirection(t,e,o).then(Blockscad.Auth.TVsendFileToAWS).then(function(t){$.ajax({url:t,type:"POST",headers:{Authorization:"Bearer "+Blockscad.Auth.thingiverseToken},success:function(t){s("a finalize done!")},fail:function(t){c("finalize fail")},error:function(t,e){console.log("ajax error: trying to finalize file with Thingiverse"),s(finalize_redirect)}})}).catch(function(t){console.log("thingaverse posting to amazon failed with:",t)})})},Blockscad.Auth.TVcreateThing=function(t){return new Promise(function(e,o){var s="";t.description&&"null"!=t.description&&(s+=t.description),s+="\nThis thing was made with BlocksCAD\n",s+="\nTo edit this project at BlocksCAD: ",s+="download the .xml file and load it at: "+Blockscad.Auth.baseUrl+"editor\n";var c={name:t.title,category:"Models",tags:t.tags,description:s,instructions:"","is-wip":!1,license:"cc-nc-sa"};$.ajax({url:"https://api.thingiverse.com/things/",type:"POST",timeout:9e3,headers:{Authorization:"Bearer "+Blockscad.Auth.thingiverseToken},data:JSON.stringify(c),success:function(t){Blockscad.Auth.finalTvId=t.id,e(t)},fail:function(t){o(t)}})})},Blockscad.Auth.uploadTVProjectNew=function(){var t=Blockscad.Auth.tvpid;Blockscad.Auth.TVgetUserInfo(),Blockscad.Auth.downloadProject(t,!1,null).then(function(t){return new Promise(function(e,o){document.body.addEventListener("renderDone",function(o){Blockscad.Auth.tvstl=Blockscad.gProcessor.currentObject.toStlBinary({webBlob:!0}),Blockscad.Auth.tvimg=dataURLtoBlob(Blockscad.gProcessor.img),setTimeout(function(){$("#tv-message-body").html('<h3><img id=busy src="imgs/busy2.gif">&nbsp;&nbsp;Sending files to Thingiverse</h3>')},0),e(t)},!1),setTimeout(Blockscad.doRender,800)})}).then(function(t){Blockscad.Auth.TVpInfo=t;var e=Base64.btou(RawDeflate.inflate(Base64.fromBase64(t.body)));return Blockscad.Auth.TVblockfileblob=new Blob([e],{type:"text/xml"}),Promise.all([Blockscad.Auth.TVcreateThing(t)])}).then(function(t){var e=t[0],o=[Blockscad.Auth.TVuploadFile(e,Blockscad.Auth.TVpInfo.title+".xml",Blockscad.Auth.TVblockfileblob)];return Blockscad.Auth.tvimg&&o.push(Blockscad.Auth.TVuploadFile(e,Blockscad.Auth.TVpInfo.title+".jpg",Blockscad.Auth.tvimg)),Blockscad.Auth.tvstl&&o.push(Blockscad.Auth.TVuploadFile(e,Blockscad.Auth.TVpInfo.title+".stl",Blockscad.Auth.tvstl)),Promise.all(o)}).then(function(t){setTimeout(function(){$("#tv-message-body").html("<h4>Edit your Thing on Thingiverse, then Publish it</h4>")},0),setTimeout(function(){$("#tv-message-footer").html("<h4>Connecting to Thingiverse...</h4>")},0),setTimeout(function(){window.location.replace("https://www.thingiverse.com/thing:"+Blockscad.Auth.finalTvId+"/edit")},1)})},Blockscad.Auth.startTeacherPolling=function(){Blockscad.Auth.teacher_polling||(Blockscad.Auth.teacher_polling=setInterval(function(){if(document.hasFocus()){var t=moment(),e=moment.duration(t.diff(Blockscad.Auth.myLastTime));Blockscad.Auth.checkForProjectUpdate(Blockscad.Auth.projectId,e)}},3e4))},Blockscad.Auth.stopTeacherPolling=function(){clearInterval(Blockscad.Auth.teacher_polling)};var hex_chr="0123456789abcdef".split("");function rhex(t){for(var e="",o=0;o<4;o++)e+=hex_chr[t>>8*o+4&15]+hex_chr[t>>8*o&15];return e}function hex(t){for(var e=0;e<t.length;e++)t[e]=rhex(t[e]);return t.join("")}function md5(t){return hex(md51(t))}function add32(t,e){return t+e&4294967295}if("5d41402abc4b2a76b9719d911017c592"!=md5("hello")){function add32(t,e){var o=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(o>>16)<<16|65535&o}}