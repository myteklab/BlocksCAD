var Blockscad=Blockscad||{};Blockscad.Auth=Blockscad.Auth||{};var CSG=CSG||{},CAG=CAG||{};Blockscad.Viewer=function(e,t,r,i,s){this.isZspace=s;this.init_normal_viewer(e,t,r,s)},Blockscad.Viewer.prototype={init_normal_viewer:function(e,t,r,i){var s=this,o=new THREE.PerspectiveCamera(45,t/r,.1,100);o.up.set(0,0,1),o.position.set(100,-100,30),o.lookAt(new THREE.Vector3(0,0,0)),this.camera=o,this.camera.near=.001,this.camera.far=1e5;var n=new THREE.Scene;n.background=new THREE.Color(16777215),this.scene=n;var a=new THREE.DirectionalLight;a.position.set(40,90,0),o.add(a);var c=new THREE.AmbientLight(10066329);n.add(c),n.add(o);let l=document.createElement("canvas"),h=l.getContext("webgl",{antialias:!0,preserveDrawingBuffer:!0,alpha:!0,xrCompatible:i});var d=new THREE.WebGLRenderer({canvas:l,context:h});d.setPixelRatio(window.devicePixelRatio),d.setSize(t,r),d.outputEncoding=THREE.sRGBEncoding,this.renderer=d,this.containerelement=e,this._startwidth=t,this._startheight=r,$(this.containerelement).append(this.renderer.domElement);var u=new Blockscad.ViewportController(this.camera,this.renderer.xr);this.viewController=u,this.scene.add(this.viewController),console.log("isZSpace =",i),"undefined"!=typeof navigator&&i&&"xr"in navigator&&"function"==typeof navigator.xr.isSessionSupported?navigator.xr.isSessionSupported("immersive-vr").then(e=>{e?(console.log("I have an eligible machine"),this.renderer.xr.enabled=!0,this.renderer.xr.setReferenceSpaceType("local"),this.renderer.xr.isPresenting?s.zSpaceInit():(this.renderer.xr.addEventListener("sessionstart",function(){s.zSpaceInit()}),this.vrButton=VRButton.createButton(this.renderer),document.body.appendChild(this.vrButton)),this.renderer.xr.addEventListener("sessionend",function(){s.onZSpaceEnd()})):(console.log("don't support VR, not trying to set it up"),s.fallbackInit())}).catch(e=>{console.error("Failed to check if XR session is supported:",e),s.fallbackInit()}):(console.log("don't support VR, not trying to set it up"),s.fallbackInit());s=this;this.planeMesh=s.createPlaneMesh(),this.group=new THREE.Object3D,this.scene.add(this.group),this.scene.add(this.planeMesh),this.setDraggable(this.group),this.group.frustumCulled=!1,this.group.name="draggable group";var p=new THREE.TrackballControls(o,d.domElement);p.rotateSpeed=1.6,p.minDistance=1.8,p.staticMoving=!0,p.addEventListener("change",function(){s.onFallbackUpdate()}),this.controls=p,s.onDraw(),s.onFallbackUpdate(),Blockscad.onresize()},animate:function(){},onKeyDown:function(e){"Enter"===e.key&&(this.lookMtxIdx=(this.lookMtxIdx+1)%this.lookMtxs.length)," "===e.key&&(this.focusPtIdx=(this.focusPtIdx+1)%this.focusPts.length),this.camToVportMtx=new THREE.Matrix4,this.vportToCamMtx=new THREE.Matrix4;for(var t=0;t<16;t++)this.camToVportMtx.elements[t]=this.effect.zspace.cameraToViewportMatrix[t];this.vportToCamMtx.getInverse(this.camToVportMtx),this.camera.matrix.copy(this.identityMtx).setPosition(this.focusPts[this.focusPtIdx]),this.camera.matrix.multiply(this.lookMtxs[this.lookMtxIdx]),this.camera.matrix.multiply(this.vScaleMtx),this.camera.matrix.multiply(this.camToVportMtx),this.camera.matrixWorldNeedsUpdate=!0,this.camera.updateMatrixWorld()},setCsg:function(e,t){this.mesh=t?Blockscad.Viewer.csgToMesh(e,this.defaultColor,!0):Blockscad.Viewer.csgToMesh(e,this.defaultColor,!1),this.setDraggable(this.mesh),this.mesh.frustumCulled=!1,this.mesh.name="draggable mesh",this.group.add(this.mesh),this.stylusPointer&&this.stylusPointer.intersectables.push(this.mesh),this.onDraw()},rendered_resize:function(e,t){if(console.log("in rendered_resize, bad!"),this.renderer)if(this.zSession){this.momentaryZSpaceStereoSuppression(),this.camera.aspect=e/(t-3),this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t-3);var r=this.renderDiv.getBoundingClientRect();this.canvas.style.top=r.top+"px",this.canvas.style.left=r.left+"px"}else this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.renderer.render(this.scene,this.camera)},viewReset:function(e){if(e)var t=e;else t=document.getElementById("viewMenu").value;Blockscad.zSpaceDisplay?"diagonal"==t?this.controls.reset([60,-65,40],this.group):"top"==t?this.controls.reset([.1,-.1,90],this.group):"bottom"==t?this.controls.reset([.1,-.1,-90],this.group):"right"==t?this.controls.reset([0,-90,0],this.group):"front"==t?this.controls.reset([90,0,0],this.group):"left"==t?this.controls.reset([0,90,0],this.group):"back"==t&&this.controls.reset([-90,0,0],this.group):"diagonal"==t?this.controls.reset([100,-100,30],this.group):"top"==t?(this.camera.position.set(.1,-.1,90),this.camera.lookAt(new THREE.Vector3(0,0,0))):"bottom"==t?(this.camera.position.set(.1,-.1,-90),this.camera.lookAt(new THREE.Vector3(0,0,0))):"right"==t?(this.camera.position.set(0,-90,0),this.camera.lookAt(new THREE.Vector3(0,0,0))):"front"==t?(this.camera.position.set(90,0,0),this.camera.lookAt(new THREE.Vector3(0,0,0))):"left"==t?(this.camera.position.set(0,90,0),this.camera.lookAt(new THREE.Vector3(0,0,0))):"back"==t&&(this.camera.position.set(-90,0,0),this.camera.lookAt(new THREE.Vector3(0,0,0))),this.onDraw()},clear:function(){this.mesh&&(this.group.remove(this.mesh),this.stylusPointer&&this.stylusPointer.intersectables.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.mesh=void 0),this.onDraw()},zoomOut:function(){this.controls.zoomCameraKey(!1)},zoomIn:function(){this.controls.zoomCameraKey(!0)},onDraw:function(e,t,r,i,s,o){if(t||(t=0),e&&this.mesh){t+=3*Math.PI/4;var n=this.bsph,a=this.bbox,c=1.3-(a[1].z-a[0].z)/(2*n.radius),l=2.6*n.radius;this.camera.position.set(n.center.x+l*Math.sin(t),n.center.y+l*Math.cos(t),n.center.z+c*l/2),this.camera.lookAt(new THREE.Vector3(n.center.x,n.center.y,n.center.z))}if(this.onFallbackUpdate(),e){var h=[];if(h[0]=this.renderer.domElement.toDataURL("image/jpeg",e),s&&o)return void o.drawImage(this.renderer.domElement,i*Blockscad.rpicSize[0],0);var d=document.createElement("canvas"),u=d.getContext("2d");d.height=.5*this.renderer.domElement.height,d.width=.5*this.renderer.domElement.height,u.drawImage(this.renderer.domElement,0,0,d.width,d.height);var p=document.createElement("canvas"),m=p.getContext("2d");return p.height=.5*d.height,p.width=.5*d.width,m.drawImage(d,0,0,.5*d.width,.5*d.height),h[1]=p.toDataURL("image/jpeg",e),h}if(r)return this.renderer.domElement.toDataURL("image/jpeg",r)},takePic:function(e,t){return console.log("in takePic with :"+e+" , "+t),this.onDraw(e,t)},takeAnimatedGif:function(e,t){for(var r=[],i=0;i<t;i+=1){var s=-i*(2*Math.PI/t);r[i]=this.onDraw(e,s,0)}return r},takeRotatingPic:function(e,t){var r=document.createElement("canvas");r.width=Blockscad.rpicSize[0]*t,r.height=Blockscad.rpicSize[0];for(var i=r.getContext("2d"),s=0;s<t;s++){var o=-s*(2*Math.PI/t);this.onDraw(e,o,0,s,r,i)}return r.toDataURL("image/jpeg",.9)},takeCameraPic:function(e){return this.onDraw(0,0,e)},createPlaneMesh:function(){for(var e=new THREE.BufferGeometry,t=new THREE.BufferGeometry,r=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),i=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:!0,opacity:.4}),s=[0,0,0,100,0,0,0,0,0,0,100,0,0,0,0,0,0,73],o=[1,0,0,1,0,0,0,.7,0,0,.7,0,.1,.1,.5,.1,.1,.5],n=[],a=[],c=-100;c<0;c++)c%2&&(s.push(c,0,0),s.push(c+1,0,0),o.push(1,0,0),o.push(1,0,0),s.push(0,c,0),s.push(0,c+1,0),o.push(0,.7,0),o.push(0,.7,0),c>-73&&c<73&&(s.push(0,0,c),s.push(0,0,c+1),o.push(.1,.1,.5),o.push(.1,.1,.5)));for(var l=-100;l<=100;l++)l%10&&0!==l&&(n.push(-100,l,0),a.push(.8,.8,.8),n.push(100,l,0),a.push(.8,.8,.8),n.push(l,-100,0),a.push(.8,.8,.8),n.push(l,100,0),a.push(.8,.8,.8),l<73&&l>-73&&(n.push(-.5,0,l),a.push(.8,.8,.8),n.push(.5,0,l),a.push(.8,.8,.8),n.push(0,-.5,l),a.push(.8,.8,.8),n.push(0,.5,l),a.push(.8,.8,.8)));for(l=10;l<=100;l+=10)0!==l&&(s.push(-100,l,0),o.push(.6,.6,.6),s.push(100,l,0),o.push(.6,.6,.6),s.push(l,-100,0),o.push(.6,.6,.6),s.push(l,100,0),o.push(.6,.6,.6),s.push(-100,-l,0),o.push(.6,.6,.6),s.push(100,-l,0),o.push(.6,.6,.6),s.push(-l,-100,0),o.push(.6,.6,.6),s.push(-l,100,0),o.push(.6,.6,.6)),l<73&&(s.push(-1,0,l),o.push(.6,.6,.6),s.push(1,0,l),o.push(.6,.6,.6),s.push(0,-1,l),o.push(.6,.6,.6),s.push(0,1,l),o.push(.6,.6,.6),s.push(-1,0,-l),o.push(.6,.6,.6),s.push(1,0,-l),o.push(.6,.6,.6),s.push(0,-1,-l),o.push(.6,.6,.6),s.push(0,1,-l),o.push(.6,.6,.6));s.push(102.5,-2.5,0),s.push(107.5,2.5,0),s.push(102.5,2.5,0),s.push(107.5,-2.5,0),s.push(-2.5,110,0),s.push(0,107.5,0),s.push(0,107.5,0),s.push(2.5,110,0),s.push(0,102.5,0),s.push(0,107.5,0),s.push(-2.5,0,200/2.8+7.5),s.push(2.5,0,200/2.8+7.5),s.push(-2.5,0,200/2.8+2.5),s.push(2.5,0,200/2.8+2.5),s.push(-2.5,0,200/2.8+2.5),s.push(2.5,0,200/2.8+7.5);for(c=0;c<16;c++)o.push(0,0,0);e.setAttribute("position",new THREE.Float32BufferAttribute(s,3)),e.setAttribute("color",new THREE.Float32BufferAttribute(o,3)),e.computeBoundingSphere(),t.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),t.setAttribute("color",new THREE.Float32BufferAttribute(a,3)),t.computeBoundingSphere();var h=new THREE.LineSegments(e,r),d=new THREE.LineSegments(t,i);h.frustumCulled=!1,d.frustumCulled=!1;var u=new THREE.Group;return u.add(h),u.add(d),u},onBeforeRender:function(){this.viewController.update(),this.stylusPointer&&this.stylusPointer.update(),this.updateAlignment()},onRender:function(){this.renderer.render(this.scene,this.camera)},onUpdate:function(){this.onBeforeRender(),this.onRender()},onFallbackBeforeRender:function(){this.viewController.update()},onFallbackRender:function(){this.renderer.render(this.scene,this.camera)},onFallbackUpdate:function(){this.onFallbackBeforeRender(),this.onFallbackRender()},zSpaceInit:function(){var e=this;e.viewReset("diagonal"),this.stylusPointer=new Blockscad.StylusPointer(e.viewController,e.renderer.xr),this.mesh&&this.stylusPointer.intersectables.push(this.mesh),this.yaw=0,this.pitch=175,e.applyXRRotation(),this.viewController.position.set(0,0,0),this.viewController.viewerScale=1125,this.stylusPointer.addEventListener("hoverEnter",function(e){e.pointer._beamVisual.material.color.setHex(65535)}),this.stylusPointer.addEventListener("hoverExit",function(e){e.pointer._beamVisual.material.color.setHex(6094684)}),this.margin=15,null==this.exitButton?(this.initExitButton(),this.stylusPointer.intersectables.push(this.exitButton),this.exitButton.addEventListener("dragBegin",e=>{this.renderer.xr.getSession().end()})):this.exitButton.visible=!0,this.renderer.setAnimationLoop(function(){e.onUpdate()}),this.renderer.render(this.scene,this.camera)},onZSpaceEnd:function(){var e=this;console.log("in OnZspaceEnd"),this.renderer.dispose(),this.renderer=null,$(this.containerelement).empty();let t=document.createElement("canvas"),r=t.getContext("webgl",{antialias:!0,preserveDrawingBuffer:!0,alpha:!0,xrCompatible:!0});var i=new THREE.WebGLRenderer({canvas:t,context:r});i.setPixelRatio(window.devicePixelRatio),i.setSize(this._startwidth,this._startheight),i.outputEncoding=THREE.sRGBEncoding,this.renderer=i,console.log("can I set up the regular canvas now?"),console.log(this.renderer.domElement),$(this.containerelement).append(this.renderer.domElement),this.scene.remove(this.viewController),this.viewController=null;var s=new Blockscad.ViewportController(this.camera,this.renderer.xr);this.viewController=s,this.scene.add(this.viewController),this.stylusPointer=null,this.renderer.xr.enabled=!0,this.renderer.xr.setReferenceSpaceType("local"),this.viewController.webXRManager=this.renderer.xr,this.renderer.xr.addEventListener("sessionstart",function(){e.zSpaceInit()}),this.renderer.xr.addEventListener("sessionend",function(){e.onZSpaceEnd()}),document.body.removeChild(this.vrButton),this.vrButton=VRButton.createButton(this.renderer),document.body.appendChild(this.vrButton),this.exitButton=null,this.controls=null;var o=new THREE.TrackballControls(this.camera,this.renderer.domElement);o.rotateSpeed=1.6,o.minDistance=1.8,o.staticMoving=!0,o.addEventListener("change",function(){e.onFallbackUpdate()}),this.controls=o,console.log("got this far"),e.onDraw(),e.onFallbackUpdate(),Blockscad.onresize(),this.fallbackInit()},fallbackInit:function(){console.log("initializing fallback render view")},initExitButton:function(){var e=document.createElement("CANVAS");e.width=512,e.height=512;var t=e.getContext("2d");t.fillStyle="lightgray",t.lineCap="round",t.fillRect(0,0,512,512),t.strokeStyle="0x606060",t.lineWidth=50,t.beginPath(),t.moveTo(80,80),t.lineTo(432,432),t.moveTo(80,432),t.lineTo(432,80),t.stroke();let r=new THREE.BoxGeometry(.02,.02,.005),i=new THREE.MeshLambertMaterial({color:"lightgray",transparent:!0,opacity:.9}),s=new THREE.MeshLambertMaterial({map:new THREE.CanvasTexture(e),transparent:!0,opacity:.9});this.exitButton=new THREE.Mesh(r,[i,i,i,i,s,s]),this.exitButton.frustumCulled=!1,this.viewController.add(this.exitButton)},updateAlignment:function(){let e=this.viewController.width-this.viewController.metersPerPixelWidth*this.margin*12,t=this.viewController.height-this.viewController.metersPerPixelHeight*this.margin*12;this.exitButton.position.set(e/2,-t/2,0)},onWindowResize:function(e,t){this.renderer.xr.isPresenting||(e&&(width=e),t&&(height=t),this.camera.aspect=width/height,this.camera.updateProjectionMatrix(),this.renderer.setSize(width,height),this.viewController.update(),this.renderer.render(this.scene,this.camera))},initViewController:function(){this.viewController=new ViewportController(this.camera,this.renderer.xr)},setDraggable(e){e.dragPointer=null,e.dragOffset=new THREE.Matrix4,e.addEventListener("dragBegin",Blockscad.Draggable.prototype.dragBegin.bind(e)),e.addEventListener("dragUpdate",Blockscad.Draggable.prototype.dragUpdate.bind(e)),e.addEventListener("dragEnd",Blockscad.Draggable.prototype.dragEnd.bind(e))},applyXRRotation:function(){let e=(new THREE.Quaternion).setFromEuler(new THREE.Euler(0,this.yaw/360*(2*Math.PI),0)),t=(new THREE.Quaternion).setFromEuler(new THREE.Euler(this.pitch/360*(2*Math.PI)-Math.PI/2,0,0));this.viewController.quaternion.multiplyQuaternions(e,t)}},Blockscad.Viewer.csgToMesh=function(e,t,r){var i=e.canonicalized();return this.geometry=this.csgToGeometry(i,t),this.material=new THREE.MeshPhongMaterial({color:11184810,shininess:70,specular:1052688,vertexColors:THREE.FaceColors}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh},Blockscad.Viewer.makeTHREEgeometry=function(e,t){t||(t=[1,.50196,1,1]);for(var r=e.toTriangles(),i=new THREE.BufferGeometry,s=[],o=[],n=[],a=0;a<r.length;a++){r[a].vertices.length;var c,l=r[a].plane.normal,h=r[a];c=h.shared&&h.shared.color?h.shared.color:h.color?h.color:t;for(var d=0;d<r[a].vertices.length;d++)s.push(r[a].vertices[d].pos.x,r[a].vertices[d].pos.y,r[a].vertices[d].pos.z),o.push(l.x,l.y,l.z),n.push(c[0],c[1],c[2])}function u(){this.array=null}return i.setAttribute("position",new THREE.Float32BufferAttribute(s,3).onUpload(u)),i.setAttribute("normal",new THREE.Float32BufferAttribute(o,3).onUpload(u)),i.setAttribute("color",new THREE.Float32BufferAttribute(n,3).onUpload(u)),i.computeBoundingSphere(),i},Blockscad.Viewer.csgToGeometry=function(e,t){t||(t=[1,.5,1]);for(var r,i,s,o,n,a,c,l=e.toPolygons(),h=new THREE.Geometry,d=l.length,u={},p=t,m=0;m<d;m++){i=(r=l[m]).vertices.length,p=r.shared&&r.shared.color?r.shared.color:r.color?r.color:t;for(var g=2;g<i;g++){if(a=r.vertices[0],void 0!==u[(a=new THREE.Vector3(a.pos.x,a.pos.y,a.pos.z)).x+","+a.y+","+a.z]?s=u[a.x+","+a.y+","+a.z]:(h.vertices.push(a),s=u[a.x+","+a.y+","+a.z]=h.vertices.length-1),a=r.vertices[g-1],void 0!==u[(a=new THREE.Vector3(a.pos.x,a.pos.y,a.pos.z)).x+","+a.y+","+a.z]?o=u[a.x+","+a.y+","+a.z]:(h.vertices.push(a),o=u[a.x+","+a.y+","+a.z]=h.vertices.length-1),a=r.vertices[g],void 0!==u[(a=new THREE.Vector3(a.pos.x,a.pos.y,a.pos.z)).x+","+a.y+","+a.z]?n=u[a.x+","+a.y+","+a.z]:(h.vertices.push(a),n=u[a.x+","+a.y+","+a.z]=h.vertices.length-1),p.length)var f=new THREE.Color(p[0],p[1],p[2]);else f=new THREE.Color(t[0],t[1],t[2]);c=new THREE.Face3(s,o,n,new THREE.Vector3(r.plane.normal.x,r.plane.normal.y,r.plane.normal.z),f),h.faces.push(c)}}return h},Blockscad.Viewer.csgToMeshesOLD=function(e,t,r){for(var i=e.canonicalized(),s=new GL.Mesh({normals:!0,colors:!0}),o=[s],n={},a=[],c=[],l=[],h={},d=0,u=i.toPolygons(),p=u.length,m=0;m<p;m++){var g,f=u[m];if((g=f.shared&&f.shared.color?f.shared.color:f.color?f.color:t).length<4&&g.push(1),Blockscad.Auth.thingiverseToken&&Blockscad.Auth.thingiverseToken.length>10&&r){g[0]=parseFloat(g[0].toFixed(2)),g[1]=parseFloat(g[1].toFixed(2)),g[2]=parseFloat(g[2].toFixed(2)),g[3]=parseFloat(g[3].toFixed(1));var v=g.toString();v in h||(h[v]=1,d++)}for(var w=f.vertices.map(function(e){var t,r=e.getTag();return t=a.length,n[r]=t,a.push([e.pos.x,e.pos.y,e.pos.z]),c.push(g),t}),b=2;b<w.length;b++)l.push([w[0],w[b-1],w[b]]);a.length>65e3&&(s.triangles=l,s.vertices=a,s.colors=c,s.computeWireframe(),s.computeNormals(),s=new GL.Mesh({normals:!0,colors:!0}),l=[],c=[],a=[],o.push(s))}return s.triangles=l,s.vertices=a,s.colors=c,s.computeWireframe(),s.computeNormals(),Blockscad.gProcessor.currentObjectMulticolor=d>1,o},Blockscad.makeAbsoluteUrl=function(e,t){if(!e.match(/^[a-z]+\:/i)){var r=t.split("/");r.length>0&&r.splice(r.length-1,1);var i=e.split("/"),s=r.concat(i),o=[];s.map(function(e){".."==e?o.length>0&&o.splice(o.length-1,1):o.push(e)}),e="";for(var n=0;n<o.length;n++)n>0&&(e+="/"),e+=o[n]}return e},Blockscad.isChrome=function(){return navigator.userAgent.search("Chrome")>=0},Blockscad.parseCodeInWorker=function(e,t,r){try{var i=openscadOpenJscadParser.parse(e);if(!i||!i.length)throw new Error("parser produced no output at all");self.postMessage({cmd:"parsed",err:i}),Blockscad.runMainInWorker(i)}catch(e){var s=e.toString();self.postMessage({cmd:"errorParse",err:s})}},Blockscad.runMainInWorker=function(e){var t=new Function(e);try{if("function"!=typeof t)throw new Error("Your code has an error somewhere.  Parsing your blocks failed.");var r=t();if("object"!=typeof r[0]||!(r[0]instanceof CSG||r[0]instanceof CAG))throw new Error("Nothing to Render!");var i=r[0];if(1==r.length){var s=i.toCompactBinary();self.postMessage({cmd:"finalMesh",result:s})}else{var o=r[0],n=r.slice(1),a=(o=o.union(n)).toCompactBinary();self.postMessage({cmd:"finalMesh",result:a}),r=null}}catch(e){var c=e.toString();self.postMessage({cmd:"error",err:c})}},Blockscad.parseBlockscadScriptSync=function(e,t){var r="//SYNC\n";return r+="_includePath = "+JSON.stringify(_includePath)+";\n",r+=e,r+="return main();",r+="function include(fn) {if(0) {_csg_libraries.push(fn);} else if(0) {var url = _includePath!=='undefined'?_includePath:'./';var index = url.indexOf('index.html');if(index!=-1) {url = url.substring(0,index);}importScripts(url+fn);} else {var xhr = new XMLHttpRequest();xhr.open('GET',_includePath+fn,false);console.log('include:'+_includePath+fn);xhr.onload = function() {var src = this.responseText;eval(src);};xhr.onerror = function() {};xhr.send();}}",new Function(r)()},Blockscad.parseBlockscadScriptASync=function(e,t){var r=document.location.href.replace(/\?.*$/,""),i=r=r.replace(/#.*$/,""),s="//ASYNC\n";s+="var _csg_baseurl="+JSON.stringify(r)+";\n";s+="\n\n\n\n//// The following code was added by BlocksCAD:\n",s+="var _csg_baselibraries="+JSON.stringify(["dist/viewer_compressed-f7940b1422.js","opentype/dist/opentype.min.js","blockscad/underscore.js","dist/openscad-openjscad-translator-c39f44b612.js","dist/csg_compressed-ea5407529e.js","dist/formats_compressed-5279859f68.js"])+";\n",s+="var _csg_libraries="+JSON.stringify([])+";\n",s+="var _csg_blockscadurl="+JSON.stringify(i)+";\n",s+="var _csg_makeAbsoluteURL="+Blockscad.makeAbsoluteUrl.toString()+";\n",s+="_csg_baselibraries = _csg_baselibraries.map(function(l){return _csg_makeAbsoluteURL(l,_csg_blockscadurl);});\n",s+="_csg_libraries = _csg_libraries.map(function(l){return _csg_makeAbsoluteURL(l,_csg_baseurl);});\n",s+="_csg_baselibraries.map(function(l){importScripts(l)});\n",s+="_csg_libraries.map(function(l){importScripts(l)});\n",s+="self.addEventListener('message', function(e) {if(e.data && e.data.cmd == 'render'){",s+="Blockscad.resolution = "+Blockscad.resolution+";",s+="Blockscad.csg_filename = e.data.csg_filename;",s+="Blockscad.csg_commands = e.data.csg_commands;",s+="Blockscad.fonts = {};",s+="var fontkeys = e.data.fontkeys;",s+="var fontdata = e.data.fontdata;",s+="for (var i = 0; i < fontkeys.length; i++) {",s+="  Blockscad.fonts[fontkeys[i]] = opentype.parse(fontdata[i]); }",s+="  Blockscad.parseCodeInWorker(e.data.data);",s+="}},false);\n";var o=Blockscad.textToBlobUrl(s);if(!window.Worker)throw new Error("Your browser doesn't support Web Workers. Please try the Chrome or Firefox browser instead.");var n=new Worker(o);n.onmessage=function(e){if(e.data)if("rendered"==e.data.cmd||"finalMesh"==e.data.cmd){var r,i=e.data.result.class;if("CSG"==i)r=CSG.fromCompactBinary(e.data.result);else{if("CAG"!=i)throw new Error("cannot parse final result");r=CAG.fromCompactBinary(e.data.result)}t(e.data.cmd,r)}else"error"==e.data.cmd?t(e.data.err,null):"errorParse"==e.data.cmd?($("#error-message").html(e.data.err),$("#error-message").addClass("has-error"),t(e.data.err,null)):"parsed"==e.data.cmd?$("#render-ongoing").html(Blockscad.Msg.RENDER_IN_PROGRESS+'<img id=busy src="imgs/busy2.gif">'):"log"==e.data.cmd&&console.log(e.data.txt)},n.onerror=function(e){var r="Error in line "+e.lineno+": "+e.message;t(r,null)};var a=[],c=[];for(var l in Blockscad.fonts)a.push(l),c.push(Blockscad.fonts[l]);return n.postMessage({cmd:"render",data:e,fontkeys:a,fontdata:c,csg_filename:Blockscad.csg_filename,csg_commands:Blockscad.csg_commands}),n},Blockscad.getWindowURL=function(){if(window.URL)return window.URL;if(window.webkitURL)return window.webkitURL;throw new Error("Your browser doesn't support window.URL")},Blockscad.textToBlobUrl=function(e){var t=Blockscad.getWindowURL(),r=new Blob([e]),i=t.createObjectURL(r);if(!i)throw new Error("createObjectURL() failed");return i},Blockscad.revokeBlobUrl=function(e){if(window.URL)window.URL.revokeObjectURL(e);else{if(!window.webkitURL)throw new Error("Your browser doesn't support window.URL");window.webkitURL.revokeObjectURL(e)}},Blockscad.AlertUserOfUncaughtExceptions=function(){window.onerror=function(e,t,r){e=e.replace(/^Uncaught /i,""),alert(e+"\n\n("+t+" line "+r+")")}},Blockscad.Processor=function(e,t){this.containerdiv=e,this.onchange=t,this.viewerdiv=null,this.picdiv=null,this.viewer=null,this.picviewer=null,this.rpicviewer=null,this.initialViewerDistance=100,this.processing=!1,this.currentObject=null,this.hasValidCurrentObject=!1,this.currentObjectMulticolor=!1,this.hasOutputFile=!1,this.worker=null,this.paramDefinitions=[],this.paramControls=[],this.script=null,this.hasError=!1,this.debugging=!1,this.thumbnail="none",this.imgStrip="none",this.img="none",this.stl="none";this.createCommonElements(),console.log("should I try zSpace: ",Blockscad.tryzSpace),console.log("what about navigator.xr: ",null!=navigator.xr),this.createMainViewer(Blockscad.tryzSpace)},Blockscad.setUpZspaceInterface=function(){$("#viewerButtons").addClass("big-viewerButtons").removeClass("reg-viewerButtons"),$(".vbut").addClass("bigvbut").removeClass(".vbut"),$(".renderbut").addClass("big-renderbut").removeClass(".renderbut"),$(".abortbut").addClass("big-abortbut").removeClass(".abortbut"),$(".renderPane").addClass("big-renderPane").removeClass("renderPane"),$(".render-ongoing").addClass("big-render-ongoing").removeClass(".render-ongoing"),$(".defaultColor").hide(),setTimeout(function(){$(".sp-preview").addClass("big-sp-preview").removeClass("sp-preview"),$(".defaultColor").show()},350),$("#cameraButton").hide(),$("#viewMenu").hide(),$("#viewerDefaults").hide(),Blockscad.onresize()},Blockscad.Processor.convertToSolid=function(e){if("object"!=typeof e||!(e instanceof CAG||e instanceof CSG))throw new Error("Cannot convert to solid");return e instanceof CAG&&(e=e.extrude({offset:[0,0,.1]})),e},Blockscad.Processor.prototype={createCommonElements:function(){for(var e=this;this.containerdiv.children.length>7;)this.containerdiv.removeChild(7);var t=document.createElement("div");t.setAttribute("id","picdiv"),t.style.width=Blockscad.picSize[0]+"px",t.style.height=Blockscad.picSize[1]+"px",t.style.top="0px",t.style.right="10px",t.style.position="absolute",t.style.zIndex="-1",document.getElementById("blocklyDiv").appendChild(t),this.picdiv=t;var r=document.createElement("div");r.setAttribute("id","rpicdiv"),r.style.width=Blockscad.rpicSize[0]+"px",r.style.height=Blockscad.rpicSize[1]+"px",r.style.top="300px",r.style.right="300px",r.style.position="absolute",r.style.zIndex="-1",document.getElementById("blocklyDiv").appendChild(r),this.rpicdiv=r;try{this.picviewer=new Blockscad.Viewer(this.picdiv,t.offsetWidth,t.offsetHeight,this.initialViewerDistance,!1),this.picviewer.planeMesh.visible=!1,this.picviewer.scene.remove(this.picviewer.planeMesh)}catch(e){console.log("failing to create picviewer"),this.picdiv.innerHTML="<b><br><br>Error: "+e.toString()+"</b><br><br>BlocksCAD currently requires Google Chrome or Firefox with WebGL enabled"}$("#picdiv").addClass("hidden");try{this.rpicviewer=new Blockscad.Viewer(this.rpicdiv,r.offsetWidth,r.offsetHeight,this.initialViewerDistance,!1),this.rpicviewer.planeMesh.visible=!1,this.rpicviewer.scene.remove(this.rpicviewer.planeMesh)}catch(e){console.log("failing to create rpicviewer"),this.rpicdiv.innerHTML="<b><br><br>Error: "+e.toString()+"</b><br><br>BlocksCAD currently requires Google Chrome or Firefox with WebGL enabled"}$("#rpicdiv").addClass("hidden"),this.abortbutton=document.getElementById("abortButton"),this.renderbutton=document.getElementById("renderButton"),this.ongoingrender=document.getElementById("render-ongoing"),this.abortbutton.onclick=function(t){e.abort()},this.formatDropdown=document.getElementById("render-type"),this.formatDropdown.onchange=function(t){e.currentFormat=e.formatDropdown.options[e.formatDropdown.selectedIndex].value,e.updateDownloadLink()},this.generateOutputFileButton=document.getElementById("stlButton"),this.generateOutputFileButton.onclick=function(t){setTimeout(function(){$("#stlButton").prop("disabled",!0)},0),e.generateOutputFile()},this.enableItems()},createMainViewer:function(e){var t=document.createElement("div");t.id="oldStyleViewer",t.style.width="100%",t.style.height="100%",t.style.top="0px",t.style.position="absolute",this.containerdiv.appendChild(t),this.viewerdiv=t;try{this.viewer=new Blockscad.Viewer(this.viewerdiv,t.offsetWidth,t.offsetHeight,this.initialViewerDistance,e)}catch(e){this.viewerdiv.innerHTML="<b><br><br>Error: "+e.toString()+"</b><br><br>BlocksCAD currently requires Google Chrome or Firefox with WebGL enabled"}},setCurrentObject:function(e,t){var r=Blockscad.Processor.convertToSolid(e);if(this.currentObject=e,this.hasValidCurrentObject=!0,this.picviewer&&(this.picviewer.bbox=r.getBounds(),this.picviewer.bsph=r.getBoundingSphere(),this.picviewer.setCsg(r,!1)),this.rpicviewer&&(this.rpicviewer.bbox=r.getBounds(),this.rpicviewer.bsph=r.getBoundingSphere(),this.rpicviewer.setCsg(r,!1)),this.viewer&&this.viewer.setCsg(r,!0),t){for($("#stl_buttons").removeClass("hidden");this.formatDropdown.options.length>0;)this.formatDropdown.options.remove(0);var i=this;this.supportedFormatsForCurrentObject().forEach(function(e){var t=document.createElement("option");t.setAttribute("value",e),t.appendChild(document.createTextNode(i.formatInfo(e).displayName)),i.formatDropdown.options.add(t)}),this.updateDownloadLink()}},selectedFormat:function(){return this.formatDropdown.options[this.formatDropdown.selectedIndex].value},selectedFormatInfo:function(){return this.formatInfo(this.selectedFormat())},updateDownloadLink:function(){var e=this.selectedFormatInfo().extension;this.generateOutputFileButton.innerHTML=Blockscad.Msg.GENERATE_STL+" "+e.toUpperCase(),"Thingiverse"==this.selectedFormatInfo().displayName&&(this.generateOutputFileButton.innerHTML="Upload to Thingiverse"),"Polar Cloud"==this.selectedFormatInfo().displayName&&(this.generateOutputFileButton.innerHTML='<span style="font-size:1.3em;color:#909090" class="glyphicon glyphicon-upload"></span>  Polar Cloud')},clearViewer:function(){this.clearOutputFile(),this.viewer.mesh&&(this.viewer.group.remove(this.viewer.mesh),this.viewer.mesh.geometry.dispose(),this.viewer.mesh.material.dispose(),this.viewer.mesh=void 0),this.picviewer&&this.picviewer.mesh&&(this.picviewer.group.remove(this.picviewer.mesh),this.picviewer.mesh.geometry.dispose(),this.picviewer.mesh.material.dispose(),this.picviewer.mesh=void 0),this.rpicviewer&&this.rpicviewer.mesh&&(this.rpicviewer.group.remove(this.rpicviewer.mesh),this.rpicviewer.mesh.geometry.dispose(),this.rpicviewer.mesh.material.dispose(),this.rpicviewer.mesh=void 0),this.hasValidCurrentObject=!1,this.currentObjectMulticolor=!1,this.thumbnail="none",this.imgStrip="none",this.img="none",this.stl="none",$("#stl_buttons").addClass("hidden"),this.enableItems(),this.viewer.onDraw()},clearMesh:function(){this.viewer.mesh&&(this.viewer.group.remove(this.viewer.mesh),this.viewer.mesh.geometry.dispose(),this.viewer.mesh.material.dispose(),this.viewer.mesh=void 0),this.picviewer.mesh&&(this.picviewer.group.remove(this.picviewer.mesh),this.picviewer.mesh.geometry.dispose(),this.picviewer.mesh.material.dispose(),this.picviewer.mesh=void 0),this.rpicviewer.mesh&&(this.rpicviewer.group.remove(this.rpicviewer.mesh),this.rpicviewer.mesh.geometry.dispose(),this.rpicviewer.mesh.material.dispose(),this.rpicviewer.mesh=void 0)},abort:function(){this.processing&&($("#renderButton").prop("disabled",!1),$("#render-ongoing").html(Blockscad.Msg.PARSE_IN_PROGRESS+'<img id=busy src="imgs/busy2.gif">'),this.processing=!1,this.worker.terminate(),this.enableItems(),this.onchange&&this.onchange())},enableItems:function(){this.abortbutton.style.display=this.processing?"inline-block":"none",this.renderbutton.style.display=this.processing?"none":"inline-block",this.ongoingrender.style.display=this.processing?"inline-block":"none"},setError:function(e){this.hasError=""!=e,$("#error-message").text(e),this.enableItems()},setDebugging:function(e){this.debugging=e},setBlockscad:function(e){this.script=e,this.rebuildSolid()},rebuildSolid:function(){this.abort(),this.setError(""),this.clearViewer(),this.processing=!0,$("#renderButton").html(Blockscad.Msg.RENDER_BUTTON),$("#renderButton").prop("disabled",!1),this.enableItems();var e=this,t=this.debugging;if(!t)try{this.worker=Blockscad.parseBlockscadScriptASync(e.script,function(t,r){if(t&&"finalMesh"==t){if($("#render-ongoing").html(Blockscad.Msg.PARSE_IN_PROGRESS+'<img id=busy src="imgs/busy2.gif">'),e.processing=!1,e.setCurrentObject(r,!0),e.picviewer){var i=e.picviewer.takePic(Blockscad.picQuality,0,1);e.img=i[0],e.thumbnail=i[1],e.imgStrip=e.rpicviewer.takeRotatingPic(1,Blockscad.numRotPics)}r instanceof CSG&&e.generateBinaryStl(),e.processing=!1,e.worker=null}else if(t&&"rendered"==t){$("#render-ongoing").html('Prepare for Download...<img id=busy src="imgs/busy2.gif">'),e.setCurrentObject(r,!1);i=e.picviewer.takePic(Blockscad.picQuality,0,1);e.img=i[0],e.thumbnail=i[1],e.imgStrip=e.rpicviewer.takeRotatingPic(1,Blockscad.numRotPics),r instanceof CSG&&e.generateBinaryStl()}else console.log("what is going on?"),console.log("error in proc"+t),e.processing=!1,e.worker=null,e.setError(t);e.onchange&&e.onchange(),e.enableItems();var s=new Event("renderDone");document.body.dispatchEvent(s)})}catch(e){console.log("async failed, try sync compute, error: "+e.message),t=!0}if(t){try{var r=Blockscad.parseBlockscadScriptSync(this.script,this.debugging);e.setCurrentObject(r),e.processing=!1}catch(t){e.processing=!1;var i=t.stack;i||(i=t.toString()),e.setError(i)}e.enableItems(),e.onchange&&e.onchange()}},hasSolid:function(){return this.hasValidCurrentObject},isProcessing:function(){return this.processing},clearOutputFile:function(){this.hasOutputFile&&(this.outputFileBlobUrl&&(Blockscad.revokeBlobUrl(this.outputFileBlobUrl),this.outputFileBlobUrl=null),this.enableItems(),this.onchange&&this.onchange())},generateOutputFile:function(){this.clearOutputFile(),this.hasValidCurrentObject&&this.generateAndSaveRenderedFile()},currentObjectToBlob:function(e){if(e)t=e;else var t=this.selectedFormat();var r,i=null;if("stla"==t)console.log("about to repair meshy.  Number of polygons:",this.currentObject.polygons.length),"MS"!=Blockscad.browser&&this.currentObject.meshRepair(),r=this.currentObject.toStlString(),r=new Blob([r],{type:"text/plain; charset=utf-8"});else if("stlb"==t||"pc"==t)"MS"!=Blockscad.browser&&this.currentObject.meshRepair(),console.log("finished repairing mesh.  Number of polygons:",this.currentObject.polygons.length),r=this.currentObject.toStlBinary({webBlob:!0});else if("amf"==t)r=this.currentObject.toAMFString({producer:"BlocksCAD "+Blockscad.version,date:new Date}),r=new Blob([r],{type:"text/plain; charset=utf-8"});else if("x3d"==t)r=this.currentObject.toX3D(),r=new Blob([r],{type:"text/plain; charset=utf-8"});else if("dxf"==t)r=this.currentObject.toDxf(),r=new Blob([r],{type:"text/plain; charset=utf-8"});else{if("obj"!=t)throw new Error("Not supported");var s=this.currentObject.toObj();i=s[1],r=s[0],r=new Blob([r],{type:"text/plain; charset=utf-8"}),i=new Blob([i],{type:"text/plain; charset=utf-8"})}return i?[r,i]:r},supportedFormatsForCurrentObject:function(){var e=[];if(this.currentObject instanceof CSG)e=["stlb","stla","x3d","obj","amf"];else{if(!(this.currentObject instanceof CAG))throw new Error("Not supported");e=["dxf"]}return!Blockscad.standalone&&this.currentObject instanceof CSG&&(Blockscad.Auth.fromPolar?e.unshift("pc"):e.push("pc")),e},formatInfo:function(e){return{stla:{displayName:"STL (ASCII)",extension:"stl",mimetype:"application/sla"},obj:{displayName:"OBJ (ASCII)",extension:"obj",mimetype:"application/sla"},stlb:{displayName:"STL (Binary)",extension:"stl",mimetype:"application/sla"},amf:{displayName:"AMF",extension:"amf",mimetype:"application/amf+xml"},x3d:{displayName:"X3D",extension:"x3d",mimetype:"model/x3d+xml"},dxf:{displayName:"DXF",extension:"dxf",mimetype:"application/dxf"},tv:{displayName:"Thingiverse",extension:"stl",mimetype:"application/sla"},pc:{displayName:"Polar Cloud",extension:"stl",mimetype:"application/sla"}}[e]},generateBinaryStl:function(){this.stl=this.currentObjectToBlob("stlb")},generateAndSaveRenderedFile:function(){var e=this.currentObjectToBlob(),t=null;e.length&&(t=e[1],e=e[0]),setTimeout(function(){$("#stlButton").prop("disabled",!1)},0);var r=this.selectedFormatInfo().extension,i=$("#project-name").val();"Thingiverse"==this.selectedFormatInfo().displayName&&Blockscad.Auth.openThingiverse(e,i),"Polar Cloud"==this.selectedFormatInfo().displayName?Blockscad.Auth.pcUploadProject(e,i):i?(saveAs(e,i+"."+r),t&&saveAs(t,i+".mtl")):($("#message-text").html("<h4>"+Blockscad.Msg.SAVE_FAILED+" "+Blockscad.Msg.SAVE_FAILED_PROJECT_NAME+".</h4>"),$("#message-modal").modal())}},Blockscad.pathToPoints=function(e,t,r,i){var s=[],o=[],n=[];i||(i=1);var a,c,l,h,d,u,p,m,g,f,v=2*i;if(t>2&&(v=t),v>12&&(v=12),e&&e.commands&&e.commands.length>0)for(var w=0,b=[],y=0;y<e.commands.length;y++)switch(e.commands[y].type){case"M":n.length>2&&o.push(n),n=[],s.push([e.commands[y].x,-1*e.commands[y].y]),n.push(w++),b=[e.commands[y].x,-1*e.commands[y].y];break;case"L":s.push([e.commands[y].x,-1*e.commands[y].y]),n.push(w++),b=[e.commands[y].x,-1*e.commands[y].y];break;case"C":a=[e.commands[y].x,-1*e.commands[y].y],c=[e.commands[y].x1,-1*e.commands[y].y1],l=[e.commands[y].x2,-1*e.commands[y].y2];for(var E=1;E<=v;E++)u=E/v,h=b[0]*Math.pow(1-u,3)+3*c[0]*Math.pow(1-u,2)*u+3*l[0]*Math.pow(1-u,1)*u*u+a[0]*Math.pow(u,3),d=b[1]*Math.pow(1-u,3)+3*c[1]*Math.pow(1-u,2)*u+3*l[1]*Math.pow(1-u,1)*u*u+a[1]*Math.pow(u,3),h!=b[0]||d!=b[1]?(s.push([h,d]),n.push(w++)):console.log("throwing out a duplicate point");b=a;break;case"Q":a=[e.commands[y].x,-1*e.commands[y].y],c=[e.commands[y].x1,-1*e.commands[y].y1];for(E=1;E<=v;E++)u=E/v,h=b[0]*Math.pow(1-u,2)+2*c[0]*Math.pow(1-u,1)*u+a[0]*Math.pow(u,2),d=b[1]*Math.pow(1-u,2)+2*c[1]*Math.pow(1-u,1)*u+a[1]*Math.pow(u,2),h!=b[0]||d!=b[1]?(s.push([h,d]),n.push(w++)):console.log("throwing out a duplicate point in Q");b=a;break;case"Z":n.length>2&&(o.push(n),n=[])}if(s.length<3&&(s=[]),r){p=s[0][0],g=s[0][0],m=s[0][1],f=s[0][1];for(y=1;y<s.length;y++)p=Math.min(p,s[y][0]),m=Math.min(m,s[y][1]),g=Math.max(g,s[y][0]),f=Math.max(f,s[y][1]);var B=g-(g-p)/2,k=f-(f-m)/2;for(y=0;y<s.length;y++)s[y][0]-=B,s[y][1]-=k}return[s,o]};