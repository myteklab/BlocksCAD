"undefined"!=typeof module&&(CSG=require(lib+"csg.js").CSG,CAG=require(lib+"csg.js").CAG,Blob=require(lib+"Blob.js").Blob),function(n){CSG.prototype.toX3D=function(){var n={},t=[],e={};this.polygons.map(function(r){var o=0,i=0,a=1;r.shared&&r.shared.color&&(o=r.shared.color[0],i=r.shared.color[1],a=r.shared.color[2]);for(var s,l=[],c=r.vertices.length,p=0;p<c;p++)(s=r.vertices[p]).getTag()in e||(t.push(s.pos._x.toString()+" "+s.pos._y.toString()+" "+s.pos._z.toString()),e[s.getTag()]=t.length-1),l.push(e[s.getTag()]);var d=l.join(" "),h=o.toString()+" "+i.toString()+" "+a.toString();h in n||(n[h]=[]),n[h].push(d)});var r=document.implementation.createDocumentType("X3D","ISO//Web3D//DTD X3D 3.1//EN","http://www.web3d.org/specifications/x3d-3.1.dtd"),o=document.implementation.createDocument(null,"X3D",r);o.insertBefore(o.createProcessingInstruction("xml",'version="1.0" encoding="UTF-8"'),o.doctype);var i=o.getElementsByTagName("X3D")[0];i.setAttribute("profile","Interchange"),i.setAttribute("version","3.1"),i.setAttribute("xsd:noNamespaceSchemaLocation","http://www.web3d.org/specifications/x3d-3.1.xsd"),i.setAttribute("xmlns:xsd","http://www.w3.org/2001/XMLSchema-instance");var a=o.createElement("Scene");i.appendChild(a);var s=!1;for(var l in n){var c=n[l],p=o.createElement("Shape");a.appendChild(p);var d=o.createElement("Appearance");p.appendChild(d);var h=o.createElement("Material");d.appendChild(h),h.setAttribute("diffuseColor",l),h.setAttribute("ambientIntensity","1.0");var u=o.createElement("IndexedFaceSet");p.appendChild(u),u.setAttribute("solid","true"),u.setAttribute("coordIndex",c.join(" -1 ")+" -1");var v=o.createElement("Coordinate");u.appendChild(v),s?v.setAttribute("USE","coords_mesh"):(v.setAttribute("DEF","coords_mesh"),v.setAttribute("point",t.join(" ")),s=!0)}var g=(new XMLSerializer).serializeToString(o);return new Blob([g],{type:"model/x3d+xml"})},CSG.prototype.toStlBinary=function(){var n=new ArrayBuffer(4),t=new Int32Array(n,0,1),e=new Int8Array(n,0,4);if(t[0]=287454020,68!=e[0])throw new Error("Binary STL output is currently only supported on little-endian (Intel) processors");var r=0;this.polygons.map(function(n){var t=n.vertices.length;r+=t>=3?t-2:0});for(var o=new Uint8Array(80),i=0;i<80;i++)o[i]=65;var a=new Uint32Array(1);a[0]=r;var s=new ArrayBuffer(50*r),l=new Int8Array(s),c=new ArrayBuffer(50),p=new Int8Array(c),d=new Float32Array(c,0,12),h=new Uint16Array(c,48,1),u=0;return this.polygons.map(function(n){for(var t=n.vertices.length,e=0;e<t-2;e++){var r=n.plane.normal;d[0]=r._x,d[1]=r._y,d[2]=r._z;for(var o=3,i=0;i<3;i++){var a=i+(i>0?e:0),s=n.vertices[a].pos;d[o++]=s._x,d[o++]=s._y,d[o++]=s._z}h[0]=0,l.set(p,u),u+=50}}),new Blob([o.buffer,a.buffer,s],{type:"application/sla"})},CSG.prototype.toStlString=function(){var n="solid csg.js\n";return this.polygons.map(function(t){n+=t.toStlString()}),n+="endsolid csg.js\n",new Blob([n],{type:"application/sla"})},CSG.Vector3D.prototype.toStlString=function(){return this._x+" "+this._y+" "+this._z},CSG.Vertex.prototype.toStlString=function(){return"vertex "+this.pos.toStlString()+"\n"},CSG.Polygon.prototype.toStlString=function(){var n="";if(this.vertices.length>=3)for(var t=this.vertices[0].toStlString(),e=0;e<this.vertices.length-2;e++)n+="facet normal "+this.plane.normal.toStlString()+"\nouter loop\n",n+=t,n+=this.vertices[e+1].toStlString(),n+=this.vertices[e+2].toStlString(),n+="endloop\nendfacet\n";return n},CSG.prototype.toObj=function(){for(var n="# OBJ file\n",t="# OBJ material file\n",e={},r="",o={},i=1,a=0,s=0,l=0,c=null,p="",d="",h={},u=0;u<this.polygons.length;u++){(c=this.polygons[u]).shared&&c.shared.color?(a=c.shared.color[0],s=c.shared.color[1],l=c.shared.color[2]):(a=0,s=0,l=0),d=a.toFixed(6)+" "+s.toFixed(6)+" "+l.toFixed(6),colorName=(255*a).toFixed(0)+"_"+(255*s).toFixed(0)+"_"+(255*l).toFixed(0),o[colorName]||(o[colorName]="",h[colorName]="",h[colorName]+="newmtl "+colorName+"\n",h[colorName]+="Ka "+d+"\n",h[colorName]+="Kd "+d+"\n",h[colorName]+="illum 1 \n\n"),o[colorName]+="f ";for(var v=0;v<this.polygons[u].vertices.length;v++){var g=c.vertices[v];e[p="v "+g.pos._x+" "+g.pos._y+" "+g.pos._z+"\n"]?o[colorName]+=e[p]+" ":(e[p]=i.toString(),r+=p,o[d]+=i.toString()+" ",i++)}o[d]+="\n"}for(u in n+=r,o)n+="g "+u+"\n",n+=o[u];for(u in h)t+=h[u];return[n,t]},CAG.PathsToDxf=function(n){var t="999\nDXF generated by OpenJsCad\n";return t+="  0\nSECTION\n  2\nHEADER\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nTABLES\n",t+="  0\nTABLE\n  2\nLTYPE\n  70\n1\n",t+="  0\nLTYPE\n  2\nCONTINUOUS\n  3\nSolid Line\n  72\n65\n  73\n0\n  40\n0.0\n",t+="  0\nENDTAB\n",t+="  0\nTABLE\n  2\nLAYER\n  70\n1\n",t+="  0\nLAYER\n  2\nOpenJsCad\n  62\n7\n  6\ncontinuous\n",t+="  0\nENDTAB\n",t+="  0\nTABLE\n  2\nSTYLE\n  70\n0\n  0\nENDTAB\n",t+="  0\nTABLE\n  2\nVIEW\n  70\n0\n  0\nENDTAB\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nBLOCKS\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nENTITIES\n",n.map(function(n){var e=n.points.length+(n.closed?1:0);t+="  0\nLWPOLYLINE\n  8\nOpenJsCad\n  90\n"+e+"\n  70\n"+(n.closed?1:0)+"\n";for(var r=0;r<e;r++){var o=r;o>=n.points.length&&(o-=n.points.length);var i=n.points[o];t+=" 10\n"+i.x+"\n 20\n"+i.y+"\n 30\n0.0\n"}}),t+="  0\nENDSEC\n  0\nEOF\n",new Blob([t],{type:"application/dxf"})},CAG.prototype.toDxf=function(){var n=this.getOutlinePaths();return CAG.PathsToDxf(n)},CSG.prototype.toAMFString=function(n){var t='<?xml version="1.0" encoding="UTF-8"?>\n<amf'+(n&&n.unit?' unit="+m.unit"':"")+">\n";for(var e in n)t+='<metadata type="'+e+'">'+n[e]+"</metadata>\n";t+='<object id="0">\n<mesh>\n<vertices>\n',this.polygons.map(function(n){for(var e=0;e<n.vertices.length;e++)t+=n.vertices[e].toAMFString()}),t+="</vertices>\n";var r=0;return this.polygons.map(function(n){if(t+="<volume>\n",!(n.vertices.length<3)){var e=1,o=.4,i=1,a=1;n.shared&&n.shared.color?(e=n.shared.color[0],o=n.shared.color[1],i=n.shared.color[2],a=n.shared.color[3],!0):n.color&&(e=n.color[0],o=n.color[1],i=n.color[2],n.color.length()>3&&(a=n.color[3]),!0),t+="<color><r>"+e+"</r><g>"+o+"</g><b>"+i+"</b>"+(void 0!==a?"<a>"+a+"</a>":"")+"</color>";for(var s=0;s<n.vertices.length-2;s++)t+="<triangle>",t+="<v1>"+r+"</v1>",t+="<v2>"+(r+s+1)+"</v2>",t+="<v3>"+(r+s+2)+"</v3>",t+="</triangle>\n";r+=n.vertices.length,t+="</volume>\n"}}),t+="</mesh>\n</object>\n",t+="</amf>\n",new Blob([t],{type:"application/amf+xml"})},CSG.Vector3D.prototype.toAMFString=function(){return"<x>"+this._x+"</x><y>"+this._y+"</y><z>"+this._z+"</z>"},CSG.Vertex.prototype.toAMFString=function(){return"<vertex><coordinates>"+this.pos.toAMFString()+"</coordinates></vertex>\n"},n.CSG=CSG,n.CAG=CAG}(this);