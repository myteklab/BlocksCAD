var Blockscad=Blockscad||{};class VRButton{static createButton(t){const e=document.createElement("button");function i(){let i=null;function s(){try{i.removeEventListener("end",s)}catch(t){console.warn("Failed to remove session end listener: "+t)}e.textContent="ENTER VR",i=null}e.style.display="",e.style.cursor="pointer",e.style.right="10px",e.style.top="100px",e.style.width="100px",e.textContent="ENTER VR",e.onmouseenter=function(){e.style.opacity="1.0"},e.onmouseleave=function(){e.style.opacity="0.6"},e.onclick=function(){if(null===i){const n={optionalFeatures:["local-floor","bounded-floor"]};navigator.xr.requestSession("immersive-vr",n).then(function(n){!async function(n){try{n.addEventListener("end",s),console.log("Render context made XR compatible."),t.xr.setSession(n),e.textContent="EXIT VR",i=n}catch(t){console.error("Failed to handle XR session start:",t),alert("Unable to start VR session. Please check your device compatibility."),await n.end(),s()}}(n)})}else i.end()}}function s(){e.style.display="none",e.style.cursor="auto",e.style.left="calc(50% - 75px)",e.style.width="150px",e.onmouseenter=null,e.onmouseleave=null,e.onclick=null,e.textContent="VR NOT SUPPORTED"}function n(t){t.style.position="absolute",t.style.top="100px",t.style.right="10px",t.style.padding="12px 6px",t.style.border="1px solid #fff",t.style.borderRadius="4px",t.style.background="rgba(0,0,0,0.5)",t.style.color="#fff",t.style.font="normal 13px sans-serif",t.style.textAlign="center",t.style.opacity="0.6",t.style.outline="none",t.style.zIndex="150"}if("xr"in navigator)return e.id="VRButton",e.style.display="none",n(e),navigator.xr.isSessionSupported("immersive-vr").then(function(t){t?i():s()}),e;{const t=document.createElement("a");return!1===window.isSecureContext?(t.href=document.location.href.replace(/^http:/,"https:"),t.innerHTML="WEBXR NEEDS HTTPS"):(t.href="https://immersiveweb.dev/",t.innerHTML="WEBXR NOT AVAILABLE"),t.style.right="10px",t.style.width="180px",t.style.textDecoration="none",n(t),t}}}Blockscad.ViewportController=function(t,e,i={width:.344,height:.193}){if(null===t||null===e)return console.error("ViewportController requires at least a THREE.Camera and the runningWebXRManager at construction"),null;THREE.Object3D.call(this),this._camera=t,this.add(this._camera),this._camera.position.set(100,-100,30),this._webXRManager=e,this._lookDirection=new THREE.Vector3(0,0,0),this._lookUpVector=new THREE.Vector3(0,0,1),this._viewerScale=800,this.cposx=0,this.cposy=0,this.cposz=0,this._depthNear=.001,this._depthFar=1e5,this._developmentDisplaySize=i,this._runtimeDisplaySize=i,this._displaySizeExtractor=null,this._pixelWidth=1920,this._pixelHeight=1080,that=this,this._webXRManager.isPresenting?this.onSessionStart():this._webXRManager.addEventListener("sessionstart",function(){that.onSessionStart()})},Blockscad.ViewportController.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:Blockscad.ViewportController,onSessionStart:function(t){this._session=this._webXRManager.getSession(),this._vrCam=this._webXRManager.getCamera(this._camera),this.viewerScale=this._viewerScale,this._displaySizeExtractor=new Blockscad.DisplaySizeExtractor(this._session);let e=this;this._displaySizeExtractor.QueryDisplaySize().then(function(t){e._runtimeDisplaySize=t,e.viewerScale=e.viewerScale})},setLookDirection:function(t){this._lookDirection=t,this.rotation.setFromRotationMatrix((new THREE.Matrix4).lookAt(this._lookDirection,new THREE.Vector3(0,0,0),this._lookUpVector))},setLookUp:function(t){this._lookUpVector=t,this.setLookDirection(this._lookDirection)},update:function(){this._webXRManager.isPresenting?this._camera.position.set(0,0,0):this._webXRManager.isPresenting}}),Blockscad.ViewportController.prototype=Object.create(Blockscad.ViewportController.prototype,{depthNear:{get:function(){return this._depthNear},set:function(t){t<=0?console.error("near plane clipping cannot be less than or equal to zero."):(this._depthNear=t,this._camera.near=t,this._webXRManager.isPresenting?this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}):this._camera.updateProjectionMatrix())}},depthFar:{get:function(){return this._depthFar},set:function(t){t<=0?console.error("far plane clipping cannot be less than or equal to zero."):(this._depthFar=t,this._camera.far=t,this._webXRManager.isPresenting?this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}):this._camera.updateProjectionMatrix())}},viewerScale:{get:function(){return this._viewerScale},set:function(t){t<=0?console.error("Viewer Scale cannot be less than or equal to zero."):(this._viewerScale=t,this.scale.setScalar(this.runtimeViewerScale),this._webXRManager.isPresenting&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}},runtimeViewerScale:{get:function(){return this.viewerScale*(this._developmentDisplaySize.width+this._developmentDisplaySize.height)/(this.width+this.height)}},width:{get:function(){return this._runtimeDisplaySize.width}},height:{get:function(){return this._runtimeDisplaySize.height}},metersPerPixelWidth:{get:function(){return this.width/this._pixelWidth}},metersPerPixelHeight:{get:function(){return this.height/this._pixelHeight}}}),Blockscad.DisplaySizeExtractor=function(t){this._planes=[],this._displaySize={x:0,y:0},this._session=t,this._referenceSpace=null,this._headPos=[0,0,0,1],this._raycastLeft=null,this._raycastRight=null,this._raycastTop=null,this._raycastBottom=null,this.resolve=null,this.reject=null},Blockscad.DisplaySizeExtractor.prototype={QueryDisplaySize(){return that=this,new Promise(function(t,e){that.resolve=t,that.reject=e,null===that._referenceSpace?that._session.requestReferenceSpace("local").then(function(t){that.referenceSpace=t,that._session.requestAnimationFrame(that._onXrFrame.bind(that))}).catch(function(t){that.reject(t)}):that._session.requestAnimationFrame(that._onXrFrame.bind(that))})},_onXrFrame(t,e){const i=e.getViewerPose(this.referenceSpace).views[0],s=this._mat4Transpose(i.projectionMatrix),n=this._mat4Transpose(i.transform.inverse.matrix),r=this._mat4multiply(s,n);this._planes=this._extractPlanes(r),this._planes=this._normalizeFrustumPlanes(this._planes),this._headPos=i.transform.inverse.position,this._headPos=[i.transform.inverse.position.x,i.transform.inverse.position.y,i.transform.inverse.position.z,i.transform.inverse.position.w],this._raycastLeft=this._intersectRayPlaneDistance(this._headPos,this._planes[0],[0,0,0],[1,0,0]),this._raycastRight=this._intersectRayPlaneDistance(this._headPos,this._planes[1],[0,0,0],[-1,0,0]),this._raycastTop=this._intersectRayPlaneDistance(this._headPos,this._planes[2],[0,0,0],[0,1,0]),this._raycastBottom=this._intersectRayPlaneDistance(this._headPos,this._planes[3],[0,0,0],[0,-1,0]),this._displaySize={width:this._raycastLeft+this._raycastRight,height:this._raycastTop+this._raycastBottom},this.resolve(this._displaySize)},_intersectRayPlaneDistance:function(t,e,i,s){return 4===t.length&&(t=this._vec4tovec3(t)),4===e.length&&(e=this._vec4tovec3(e)),this._vec3dot(e,this._vec3subtract(i,t))/this._vec3dot(e,this._vec3subtract([0,0,0],s))},_vec3subtract:function(t,e){let i=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i},_vec3multiply:function(t,e){let i=[];return i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i},_vec3dot:function(t,e){let i=t[0]*e[0]+t[1]*e[1];return i+=t[2]*e[2]},_mat4Transpose:function(t){let e=[];return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},_extractPlanes:function(t,e,i){return[[t[12]+t[0],t[13]+t[1],t[14]+t[2],t[15]+t[3]],[t[12]-t[0],t[13]-t[1],t[14]-t[2],t[15]-t[3]],[t[12]+t[4],t[13]+t[5],t[14]+t[6],t[15]+t[7]],[t[12]-t[4],t[13]-t[5],t[14]-t[6],t[15]-t[7]]]},_normalizePlane:function(t){let e=[],i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return e.push(t[0]/i),e.push(t[1]/i),e.push(t[2]/i),e.push(1/i),e},_normalizeFrustumPlanes:function(t){let e=[];for(let i=0;i<t.length;i++)e.push(this._normalizePlane(t[i]));return e},_vec4tovec3:function(t){return[t[0]*(1/t[3]),t[1]*(1/t[3]),t[2]*(1/t[3])]},_vec4TransformMat4:function(t,e){let i=[0,0,0,1],s=t[0],n=t[1],r=t[2],o=t[3];return i[0]=e[0]*s+e[4]*n+e[8]*r+e[12]*o,i[1]=e[1]*s+e[5]*n+e[9]*r+e[13]*o,i[2]=e[2]*s+e[6]*n+e[10]*r+e[14]*o,i[3]=e[3]*s+e[7]*n+e[11]*r+e[15]*o,i},_vec3TransformMat4:function(t,e){let i=[0,0,0],s=t[0],n=t[1],r=t[2],o=e[3]*s+e[7]*n+e[11]*r+e[15];return o=o||1,i[0]=(e[0]*s+e[4]*n+e[8]*r+e[12])/o,i[1]=(e[1]*s+e[5]*n+e[9]*r+e[13])/o,i[2]=(e[2]*s+e[6]*n+e[10]*r+e[14])/o,i},_mat4multiply:function(t,e){let i=[],s=t[0],n=t[1],r=t[2],o=t[3],a=t[4],h=t[5],l=t[6],c=t[7],u=t[8],p=t[9],d=t[10],_=t[11],g=t[12],y=t[13],f=t[14],m=t[15],E=e[0],b=e[1],v=e[2],w=e[3];return i[0]=E*s+b*a+v*u+w*g,i[1]=E*n+b*h+v*p+w*y,i[2]=E*r+b*l+v*d+w*f,i[3]=E*o+b*c+v*_+w*m,E=e[4],b=e[5],v=e[6],w=e[7],i[4]=E*s+b*a+v*u+w*g,i[5]=E*n+b*h+v*p+w*y,i[6]=E*r+b*l+v*d+w*f,i[7]=E*o+b*c+v*_+w*m,E=e[8],b=e[9],v=e[10],w=e[11],i[8]=E*s+b*a+v*u+w*g,i[9]=E*n+b*h+v*p+w*y,i[10]=E*r+b*l+v*d+w*f,i[11]=E*o+b*c+v*_+w*m,E=e[12],b=e[13],v=e[14],w=e[15],i[12]=E*s+b*a+v*u+w*g,i[13]=E*n+b*h+v*p+w*y,i[14]=E*r+b*l+v*d+w*f,i[15]=E*o+b*c+v*_+w*m,i}},Blockscad.StylusPointer=function(t,e){THREE.Object3D.call(this),this.name="StylusPointer",this._viewportController=t,this._viewportController.add(this),this._controller=e.getController(0),this._raycaster=new THREE.Raycaster,this._ray=this._raycaster.ray,this._intersectables=[],this._intersects=[],this._recursive=!1,this._hovered=null,this._dragObject=null,this._dragButton=-1,this.buttonStates=[!1,!1,!1,!1,!1],this._session=this._viewportController._session,this._timeout=Date.now(),this._timeoutMax=2e3,this._oldPosition=new THREE.Vector3,this._beamLengthDefault=.5;let i=new THREE.MeshBasicMaterial({color:6094684}),s=new THREE.CylinderGeometry(7e-4,7e-4,1,6,1).applyMatrix4((new THREE.Matrix4).compose(new THREE.Vector3(0,0,-.5),(new THREE.Quaternion).setFromEuler(new THREE.Euler(Math.PI/2,0,0)),new THREE.Vector3(1,1,1)));this._beamVisual=new THREE.Mesh(s,i),this.add(this._beamVisual),this._visible=!0,this._beamVisual.frustumCulled=!1},Blockscad.StylusPointer.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:Blockscad.StylusPointer,update:function(){this.position.copy(this._controller.position),this.quaternion.copy(this._controller.quaternion),this._updateVisibilityTimeout(),this._updateRaycast(),this._updateButtons()},_updateVisibilityTimeout:function(){this._visible=Date.now()-this._timeout<this._timeoutMax,this.position.x!==this._oldPosition.x&&(this._timeout=Date.now()),this._oldPosition.copy(this.position)},_updateRaycast:function(){this._ray.set(this.getWorldPosition(new THREE.Vector3(0,0,0)),new THREE.Vector3(0,0,-1).applyQuaternion(this.getWorldQuaternion(new THREE.Quaternion(0,0,0,1)))),this.intersects=this._raycaster.intersectObjects(this._intersectables,this._recursive);let t=this.intersects[0]?this.intersects[0]:null;this._hovered&&t?t.object!==this._hovered.object&&this.dispatchEvent({type:"hoverEnter",pointer:this,intersect:t}):t&&this.dispatchEvent({type:"hoverEnter",pointer:this,intersect:t}),this._hovered&&(t?this._hovered.object!==t.object&&this.dispatchEvent({type:"hoverExit",pointer:this,intersect:this._hovered}):this.dispatchEvent({type:"hoverExit",pointer:this,intersect:this._hovered})),this._hovered=t,this._hovered?this._beamVisual.scale.setZ(this._hovered.distance/this._viewportController.runtimeViewerScale):this._beamVisual.scale.setZ(this._beamLengthDefault)},_updateButtons:function(){let t=this._session.inputSources[0].gamepad.buttons;for(var e=0;e<t.length;e++)this.buttonStates[e]!==t[e].pressed?(-1===this._dragButton&&t[e].pressed?(this._dragButton=e,this._hovered&&null===this._dragObject&&(this._dragObject=this._hovered.object,this._dragObject.dispatchEvent({type:"dragBegin",button:e,pointer:this}))):this.dragButton!==e||t[e].pressed||(this._dragButton=-1,null!==this._dragObject&&(this._dragObject.dispatchEvent({type:"dragEnd",button:e,pointer:this}),this._dragObject=null)),this.dispatchEvent({type:"buttonEvent",button:e,state:t[e].pressed?"pressed":"released"})):this._dragButton===e&&this.buttonStates[e]==t[e].pressed&&null!=this._dragObject&&this._dragObject.dispatchEvent({type:"dragUpdate",button:e,pointer:this});for(let e=0;e<t.length;e++)this.buttonStates[e]=t[e].pressed}}),Blockscad.StylusPointer.prototype=Object.create(Blockscad.StylusPointer.prototype,{dragObject:{get:function(){return this._dragObject}},isDragging:{get:function(){return this._dragButton>-1}},dragButton:{get:function(){return this._dragButton}},intersectables:{get:function(){return this._intersectables},set:function(t){"array"==typeof t?this._intersectables=t:console.error("The stylus' intersectables member must be an array")}},beamLengthDefault:{get:function(){return this._beamLengthDefault},set:function(t){t<=0?console.error("Stylus beam length must be greater than zero."):this._beamLengthDefault=t}}}),Blockscad.Draggable=function(t,e){THREE.Mesh.call(this,t,e),this.dragPointer=null,this.dragOffset=new THREE.Matrix4,this.addEventListener("dragBegin",this.dragBegin),this.addEventListener("dragUpdate",this.dragUpdate),this.addEventListener("dragEnd",this.dragEnd)},Blockscad.Draggable.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:Blockscad.Draggable,dragBegin:function(t){null===this.dragPointer&&0===t.button&&(this.dragPointer=t.pointer,this.dragOffset.copy(this.matrixWorld),this.dragOffset.premultiply((new THREE.Matrix4).getInverse(this.dragPointer.matrixWorld)))},dragUpdate:function(){this.dragPointer&&(this.matrixWorld.copy(this.dragOffset),this.matrixWorld.premultiply(this.dragPointer.matrixWorld),this.matrix.copy(this.matrixWorld),this.parent&&this.matrix.premultiply((new THREE.Matrix4).getInverse(this.parent.matrixWorld)),this.matrix.decompose(this.position,this.quaternion,this.scale))},dragEnd:function(t){this.dragPointer===t.pointer&&(this.dragPointer=null)}}),Blockscad.ZOrbitController=function(t,e){Blockscad.ViewportController.call(this,t,e),this.pivotOffset=new THREE.Object3D,this.pivotOffset.attach(this),this.pivotOffset.name="pivotOffset",this.pitchObject=new THREE.Object3D,this.pitchObject.name="pitchObject",this.pitchObject.attach(this.pivotOffset),this.attach(this.pitchObject),this.stylus=null,this._initialDragOffset=new THREE.Vector3,this._initialRigPos=new THREE.Vector3,this._initialRigRot=new THREE.Quaternion,this._initialViewerScale=1,this._upVector=new THREE.Vector3(0,1,0),this._rightVector=new THREE.Vector3(1,0,0),this._isActuating=!1,this.rotateSensitivity=3,this.zoomSensitivity=2},Blockscad.ZOrbitController.prototype=Object.assign(Object.create(Blockscad.ViewportController.prototype),{constructor:Blockscad.ZOrbitController,update:function(){null!==this.stylus?(!this._isActuating&&this.stylus.isDragging&&null===this.stylus.dragObject?(this._isActuating=!0,this._initialDragOffset.copy(this.stylus.position),this.getWorldPosition(this._initialRigPos),this.getWorldQuaternion(this._initialRigRot),this._initialViewerScale=this.viewerScale):this._isActuating&&!this.stylus.isDragging?this._isActuating=!1:this._isActuating&&null===this.stylus.dragObject&&(0===this.stylus.dragButton?this.panUpdate():3===this.stylus.dragButton?this.rotateUpdate():4===this.stylus.dragButton&&this.zoomUpdate()),ViewportController.prototype.update.call(this)):Blockscad.ViewportController.prototype.update.call(this)},panUpdate:function(){let t=(new THREE.Vector3).copy(this.stylus.position),e=(new THREE.Vector3).subVectors(this._initialDragOffset,t);e.multiplyScalar(this.viewerScale),e.applyQuaternion(this._initialRigRot),this.position.addVectors(this._initialRigPos,e)},rotateUpdate:function(){let t=(new THREE.Vector3).copy(this.stylus.position),e=(new THREE.Vector3).subVectors(this._initialDragOffset,t);e.multiplyScalar(this.rotateSensitivity),this.quaternion.copy(this._initialRigRot),this.rotateOnWorldAxis(this._upVector,e.x),this.rotateOnWorldAxis((new THREE.Vector3).copy(this._rightVector).applyQuaternion(this.quaternion),-e.y)},zoomUpdate:function(){let t=(new THREE.Vector3).subVectors(this._initialDragOffset,this.stylus.position);this.viewerScale=this._initialViewerScale+t.z*this._initialViewerScale*this.zoomSensitivity},assignStylus:function(t){this.stylus=t,this.add(this.stylus)}});